{"version":3,"sources":["unit.js"],"names":["$","$$","Mavo","Unit","Class","abstract","extends","Node","constructor","element","mavo","o","arguments","length","undefined","this","all","set","collection","dirty","scope","parentScope","fromTemplate","computed","is","required","hooks","run","isDeleted","deleted","getData","isNull","unit","walkUp","lazy","closestCollection","live","value","_this","classList","toggle","elementContents","document","createDocumentFragment","childNodes","forEach","node","appendChild","contents","tag","className","textContent","events","click","evt","remove","parentNode","name","_deleted","fire","action","item","unsavedChanges","editing","static","get","prioritizePrimitive","Scope","Primitive","create","TypeError","Bliss"],"mappings":"AAAA,cAGA,SAAUA,EAAGC,GAELC,KAAKC,KAAOH,EAAEI,OACrBC,YAAU,EACVC,UAASJ,KAAKK,KACdC,YAAa,SAASC,EAASC,GAAc,GAARC,GAAQC,UAAAC,QAAA,GAAAC,SAAAF,UAAA,MAAAA,UAAA,EAC5CG,MAAKP,YAAYQ,IAAIC,IAAIF,KAAKN,QAASM,MAEvCA,KAAKG,WAAaP,EAAEO,WACpBH,KAAKI,MAAQR,EAAEQ,MAEXJ,KAAKG,aAERH,KAAKK,MAAQL,KAAKM,YAAcN,KAAKG,WAAWG,aAG5CN,KAAKO,aAAa,WAAY,cAClCP,KAAKQ,SAAWrB,KAAKsB,GAAG,WAAYT,KAAKN,SACzCM,KAAKU,SAAWvB,KAAKsB,GAAG,WAAYT,KAAKN,UAG1CP,KAAKwB,MAAMC,IAAI,gBAAiBZ,OAMjCa,UAAW,WACAb,KAAKc,OAEf,SAAId,KAAKc,WAIAd,KAAKM,aAAeN,KAAKM,YAAYO,aAG/CE,QAAS,SAASnB,GACjBA,EAAIA,KAEJ,IAAIoB,GAAS,SAAAC,GAAA,MAAQA,GAAKb,QAAUR,EAAEQ,OACjBa,EAAKH,SAAWlB,EAAEQ,OAClBa,EAAKT,WAAaZ,EAAEY,SAEzC,OAAIQ,GAAOhB,MACH,SAIRA,MAAKkB,OAAO,SAAAb,GACX,GAAIW,EAAOX,GACV,MAAO,SAKVc,MACCC,kBAAmB,WAClB,MAAOpB,MAAKG,YACLH,KAAKK,MAAMF,aACVH,KAAKM,YAAaN,KAAKM,YAAYc,kBAAoB,QAIjEC,MACCP,QAAS,SAASQ,GAAO,GAAAC,GAAAvB,IACxBA,MAAKN,QAAQ8B,UAAUC,OAAO,UAAWH;AAErCA,GAGHtB,KAAK0B,gBAAkBC,SAASC,yBAChC1C,EAAGc,KAAKN,QAAQmC,YAAYC,QAAQ,SAAAC,GACnCR,EAAKG,gBAAgBM,YAAYD,KAGlC9C,EAAEgD,SAASjC,KAAKN,UAEdwC,IAAK,SACLC,UAAW,cACXC,YAAa,IACbC,QACCC,MAAS,SAASC,GACjBtD,EAAEuD,OAAOxC,KAAKyC,eAIjB,WAAazC,KAAK0C,MAEjBR,IAAK,SACLC,UAAW,aACXC,YAAa,OACbC,QACCC,MAAS,SAAAC,GAAA,MAAOhB,GAAKT,SAAU,OAKlCd,KAAKN,QAAQ8B,UAAUgB,OAAO,iBAEtBxC,KAAKc,UAEbd,KAAKN,QAAQ0C,YAAc,GAC3BpC,KAAKN,QAAQsC,YAAYhC,KAAK0B,iBAI9B1B,KAAK2C,UAAW,EAEhB1D,EAAE2D,KAAK5C,KAAKN,QAAS,mBACpBuB,KAAMjB,KAAKG,WACXR,KAAMK,KAAKL,KACXkD,OAAQ,WACRC,KAAM9C,SAKT+C,eAAgB,SAASzB,GAOxB,OANIA,IAAUtB,KAAKQ,UAAaR,KAAKgD,UACpC1B,GAAQ,GAGTtB,KAAKN,QAAQ8B,UAAUC,OAAO,kBAAmBH,GAE1CA,IAIT2B,UACCC,IAAK,SAASxD,EAASyD,GACtB,GAAI9C,GAAQlB,KAAKiE,MAAMnD,IAAIiD,IAAIxD,EAE/B,OAAQyD,KAAwB9C,EAAQlB,KAAKkE,UAAUpD,IAAIiD,IAAIxD,GAAWW,GAG3EiD,OAAQ,SAAS5D,EAASC,GAAc,GAARC,GAAQC,UAAAC,QAAA,GAAAC,SAAAF,UAAA,MAAAA,UAAA,EACvC,KAAKH,IAAYC,EAChB,KAAM,IAAI4D,WAAU;AAGrB,MAAO,KAAIpE,KAAKA,KAAKsB,GAAG,QAASf,GAAU,QAAU,cAAaA,EAASC,EAAMC,QAKjF4D,MAAOA,MAAMvE","file":"mavo.min.js","sourcesContent":["/*\n * Mavo Unit: Super class that Scope and Primitive inherit from\n */\n(function($, $$) {\n\nvar _ = Mavo.Unit = $.Class({\n\tabstract: true,\n\textends: Mavo.Node,\n\tconstructor: function(element, mavo, o = {}) {\n\t\tthis.constructor.all.set(this.element, this);\n\n\t\tthis.collection = o.collection;\n\t\tthis.dirty = o.dirty;\n\n\t\tif (this.collection) {\n\t\t\t// This is a collection item\n\t\t\tthis.scope = this.parentScope = this.collection.parentScope;\n\t\t}\n\n\t\tif (!this.fromTemplate(\"computed\", \"required\")) {\n\t\t\tthis.computed = Mavo.is(\"computed\", this.element);\n\t\t\tthis.required = Mavo.is(\"required\", this.element);\n\t\t}\n\n\t\tMavo.hooks.run(\"unit-init-end\", this);\n\t},\n\n\t/**\n\t * Check if this unit is either deleted or inside a deleted scope\n\t */\n\tisDeleted: function() {\n\t\tvar ret = this.deleted;\n\n\t\tif (this.deleted) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn !!this.parentScope && this.parentScope.isDeleted();\n\t},\n\n\tgetData: function(o) {\n\t\to = o || {};\n\n\t\tvar isNull = unit => unit.dirty && !o.dirty ||\n\t\t                     unit.deleted && o.dirty ||\n\t\t                     unit.computed && !o.computed;\n\n\t\tif (isNull(this)) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Check if any of the parent scopes doesn't return data\n\t\tthis.walkUp(scope => {\n\t\t\tif (isNull(scope)) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t});\n\t},\n\n\tlazy: {\n\t\tclosestCollection: function() {\n\t\t\treturn this.collection ||\n\t\t\t       this.scope.collection ||\n\t\t\t       (this.parentScope? this.parentScope.closestCollection : null);\n\t\t}\n\t},\n\n\tlive: {\n\t\tdeleted: function(value) {\n\t\t\tthis.element.classList.toggle(\"deleted\", value);\n\n\t\t\tif (value) {\n\t\t\t\t// Soft delete, store element contents in a fragment\n\t\t\t\t// and replace them with an undo prompt.\n\t\t\t\tthis.elementContents = document.createDocumentFragment();\n\t\t\t\t$$(this.element.childNodes).forEach(node => {\n\t\t\t\t\tthis.elementContents.appendChild(node);\n\t\t\t\t});\n\n\t\t\t\t$.contents(this.element, [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\tclassName: \"close mv-ui\",\n\t\t\t\t\t\ttextContent: \"Ã—\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": function(evt) {\n\t\t\t\t\t\t\t\t$.remove(this.parentNode);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t\"Deleted \" + this.name,\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\tclassName: \"undo mv-ui\",\n\t\t\t\t\t\ttextContent: \"Undo\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.deleted = false\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]);\n\n\t\t\t\tthis.element.classList.remove(\"delete-hover\");\n\t\t\t}\n\t\t\telse if (this.deleted) {\n\t\t\t\t// Undelete\n\t\t\t\tthis.element.textContent = \"\";\n\t\t\t\tthis.element.appendChild(this.elementContents);\n\n\t\t\t\t// otherwise expressions won't update because this will still seem as deleted\n\t\t\t\t// Alternatively, we could fire datachange with a timeout.\n\t\t\t\tthis._deleted = false;\n\n\t\t\t\t$.fire(this.element, \"mavo:datachange\", {\n\t\t\t\t\tunit: this.collection,\n\t\t\t\t\tmavo: this.mavo,\n\t\t\t\t\taction: \"undelete\",\n\t\t\t\t\titem: this\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tif (value && (this.computed || !this.editing)) {\n\t\t\t\tvalue = false;\n\t\t\t}\n\n\t\t\tthis.element.classList.toggle(\"unsaved-changes\", value);\n\n\t\t\treturn value;\n\t\t}\n\t},\n\n\tstatic: {\n\t\tget: function(element, prioritizePrimitive) {\n\t\t\tvar scope = Mavo.Scope.all.get(element);\n\n\t\t\treturn (prioritizePrimitive || !scope)? Mavo.Primitive.all.get(element) : scope;\n\t\t},\n\n\t\tcreate: function(element, mavo, o = {}) {\n\t\t\tif (!element || !mavo) {\n\t\t\t\tthrow new TypeError(\"Mavo.Unit.create() requires an element argument and a mavo object\");\n\t\t\t}\n\n\t\t\treturn new Mavo[Mavo.is(\"scope\", element)? \"Scope\" : \"Primitive\"](element, mavo, o);\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}