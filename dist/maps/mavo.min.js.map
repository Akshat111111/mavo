{"version":3,"sources":["primitive.js"],"names":["_typeof","Symbol","iterator","obj","constructor","$","$$","_","Mavo","Primitive","Class","extends","Unit","element","mavo","o","_this","this","fromTemplate","attribute","getValueAttribute","humanReadable","normalize","datatype","getDatatype","templateValue","getValue","raw","is","editor","editorType","edit","children","filter","el","matches","selectors","formControl","property","textContent","editorValue","remove","hasAttribute","original","getAttribute","cloneNode","template","observe","records","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_step","_iterator","copies","next","done","primitive","value","setValue","force","silent","err","requestAnimationFrame","exposed","computed","needsEdit","emptyValue","collection","swapUI","callback","unobserve","ui","ret","inside","forEach","descriptor","Object","getOwnPropertyDescriptor","Node","prototype","defineProperty","get","_this2","call","set","_this3","output","all","has","getData","dirty","savedValue","save","placeholder","unsavedChanges","popup","hidePopup","editing","data","prevTabindex","tabIndex","removeAttribute","unbind","revert","preEdit","_this4","empty","timer","events","click.mavo:preedit","e","focus.mavo:preedit","focus","click.mavo:edit","evt","preventDefault","mouseenter.mavo:preedit","clearTimeout","setTimeout","mouseleave.mavo:preedit","initEdit","_this5","getMatch","editors","create","extend","type","input change","permissions","storage","setUnsavedChanges","select","keyup","keyCode","contains","document","activeElement","stopPropagation","mavo:datachange","fire","label","dataInput","attributes","test","name","setAttribute","replace","classList","add","className","hidden","contents","size","Math","min","length","hideCallback","target","showPopup","after","x","offsetLeft","y","offsetTop","offsetHeight","style","top","left","_this6","parentNode","appendChild","clear","render","Array","isArray","find","_this7","observer","record","disconnect","lazy","readable","_this8","arguments","presentational","safeCast","_value","selectedOptions","node","action","live","hide","toggle","static","WeakMap","selector","String","datatypes","cast","useProperty","formatNumber","indexOf","namespaceURI","numberFormat","Intl","NumberFormat","maximumFractionDigits","Infinity","format","img, video, audio","a, link","select, input, textarea, meter, progress","input[type=checkbox]","time","date","Date","isNaN","options","day","month","year","hour","minute","datetime-local","timeZone","toLocaleString","meta","checked","input[type=range], input[type=number], meter, progress","*","tag",".number",".boolean","a, img, video, audio, .url","p, div, li, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address, .multiline","display","getComputedStyle","width","offsetWidth","meter, progress","max","time, .date","types","week","datetime","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Primitive = $.Class({\n\textends: Mavo.Unit,\n\tconstructor: function (element, mavo, o) {\n\t\tif (!this.fromTemplate(\"attribute\", \"datatype\", \"humanReadable\", \"computed\", \"templateValue\")) {\n\t\t\t// Which attribute holds the data, if any?\n\t\t\t// \"null\" or null for none (i.e. data is in content).\n\t\t\tthis.attribute = _.getValueAttribute(this.element);\n\n\t\t\tif (this.attribute) {\n\t\t\t\tthis.humanReadable = this.attribute.humanReadable;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.element.normalize();\n\t\t\t}\n\n\t\t\tthis.datatype = _.getDatatype(this.element, this.attribute);\n\n\t\t\tthis.templateValue = this.getValue({raw: true});\n\t\t}\n\n\t\t/**\n\t\t * Set up input widget\n\t\t */\n\n\t\t// Exposed widgets (visible always)\n\t\tif (Mavo.is(\"formControl\", this.element)) {\n\t\t\tthis.editor = this.element;\n\t\t\tthis.editorType = \"exposed\";\n\n\t\t\tthis.edit();\n\t\t}\n\n\t\t// Nested widgets\n\t\tif (!this.editor && !this.attribute) {\n\t\t\tthis.editor = $$(this.element.children).filter(function (el) {\n\t\t\t    return el.matches(Mavo.selectors.formControl) && !el.matches(Mavo.selectors.property);\n\t\t\t})[0];\n\n\t\t\tif (this.editor) {\n\t\t\t\tthis.editorType = \"nested\";\n\t\t\t\tthis.element.textContent = this.editorValue;\n\t\t\t\t$.remove(this.editor);\n\t\t\t}\n\t\t}\n\n\t\t// Linked widgets\n\t\tif (!this.editor && this.element.hasAttribute(\"data-edit\")) {\n\t\t\tthis.editorType = \"linked\";\n\n\t\t\tvar original = $(this.element.getAttribute(\"data-edit\"));\n\n\t\t\tif (original && Mavo.is(\"formControl\", original)) {\n\t\t\t\tthis.editor = original.cloneNode(true);\n\n\t\t\t\t// Update editor if original mutates\n\t\t\t\tif (!this.template) {\n\t\t\t\t\tMavo.observe(original, \"all\", records => {\n\t\t\t\t\t\tfor (let primitive of this.copies) {\n\t\t\t\t\t\t\tprimitive.editor = original.cloneNode(true);\n\t\t\t\t\t\t\tprimitive.setValue(primitive.value, {force: true, silent: true});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\trequestAnimationFrame(() => {\n\t\t\tif (!this.exposed && !this.computed) {\n\t\t\t\tthis.mavo.needsEdit = true;\n\t\t\t}\n\t\t});\n\n\t\tthis.default = this.element.getAttribute(\"data-default\");\n\n\t\tif (this.computed || this.default === \"\") { // attribute exists, no value, default is template value\n\t\t\tthis.default = this.templateValue;\n\t\t}\n\t\telse if (this.default === null) { // attribute does not exist\n\t\t\tthis.default = this.editor? this.editorValue : this.emptyValue;\n\t\t}\n\n\t\tif (this.collection) {\n\t\t\t// Collection of primitives, deal with setting textContent etc without the UI interfering.\n\t\t\tvar swapUI = callback => {\n\t\t\t\tthis.unobserve();\n\t\t\t\tvar ui = $.remove($(Mavo.selectors.ui, this.element));\n\n\t\t\t\tvar ret = callback();\n\n\t\t\t\t$.inside(ui, this.element);\n\t\t\t\tthis.observe();\n\n\t\t\t\treturn ret;\n\t\t\t};\n\n\t\t\t// Intercept certain properties so that any Mavo UI inside this primitive will not be destroyed\n\t\t\t[\"textContent\", \"innerHTML\"].forEach(property => {\n\t\t\t\tvar descriptor = Object.getOwnPropertyDescriptor(Node.prototype, property);\n\n\t\t\t\tObject.defineProperty(this.element, property, {\n\t\t\t\t\tget: function() {\n\t\t\t\t\t\treturn swapUI(() => descriptor.get.call(this));\n\t\t\t\t\t},\n\n\t\t\t\t\tset: function(value) {\n\t\t\t\t\t\tswapUI(() => descriptor.set.call(this, value));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tif (!this.computed) {\n\t\t\tthis.setValue(this.templateValue, {silent: true});\n\t\t}\n\n\t\tthis.setValue(this.template? this.default : this.templateValue, {silent: true});\n\n\t\t// Observe future mutations to this property, if possible\n\t\t// Properties like input.checked or input.value cannot be observed that way\n\t\t// so we cannot depend on mutation observers for everything :(\n\t\tthis.observe();\n\t},\n\n\tget editorValue() {\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\treturn _.getValue(this.editor, undefined, this.datatype);\n\t\t\t}\n\n\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\tif (output) {\n\t\t\t\treturn _.all.has(output)? _.all.get(output).value : _.getValue(output);\n\t\t\t}\n\t\t}\n\t},\n\n\tset editorValue(value) {\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\t_.setValue(this.editor, value);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\t\tif (output) {\n\t\t\t\t\tif (_.all.has(output)) {\n\t\t\t\t\t\t_.all.get(output).value = value;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t_.setValue(output, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tget exposed() {\n\t\treturn this.editor === this.element;\n\t},\n\n\tgetData: function(o) {\n\t\to = o || {};\n\n\t\tvar ret = this.super.getData.call(this, o);\n\n\t\tif (ret !== undefined) {\n\t\t\treturn ret;\n\t\t}\n\n\t\tvar ret = !o.dirty && !this.exposed? this.savedValue : this.value;\n\n\t\tif (!o.dirty && ret === \"\") {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\tsave: function() {\n\t\tif (this.placeholder) {\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.savedValue = this.value;\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tdone: function () {\n\t\tthis.unobserve();\n\n\t\tif (this.popup) {\n\t\t\tthis.hidePopup();\n\t\t}\n\t\telse if (!this.attribute && !this.exposed && this.editing) {\n\t\t\t$.remove(this.editor);\n\t\t\tthis.element.textContent = this.editorValue;\n\t\t}\n\n\t\tif (!this.exposed) {\n\t\t\tthis.editing = false;\n\t\t}\n\n\t\t// Revert tabIndex\n\t\tif (this.element._.data.prevTabindex !== null) {\n\t\t\tthis.element.tabIndex = this.element._.data.prevTabindex;\n\t\t}\n\t\telse {\n\t\t\tthis.element.removeAttribute(\"tabindex\");\n\t\t}\n\n\t\tthis.element._.unbind(\".mavo:edit .mavo:preedit .mavo:showpopup\");\n\n\t\tthis.observe();\n\t},\n\n\trevert: function() {\n\t\tif (this.unsavedChanges && this.savedValue !== undefined) {\n\t\t\t// FIXME if we have a collection of properties (not scopes), this will cause\n\t\t\t// cancel to not remove new unsaved items\n\t\t\t// This should be fixed by handling this on the collection level.\n\t\t\tthis.value = this.savedValue;\n\t\t\tthis.unsavedChanges = false;\n\t\t}\n\t},\n\n\t// Prepare to be edited\n\t// Called when root edit button is pressed\n\tpreEdit: function () {\n\t\tif (this.computed) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Empty properties should become editable immediately\n\t\t// otherwise they could be invisible!\n\t\tif (this.empty && !this.attribute) {\n\t\t\tthis.edit();\n\t\t\treturn;\n\t\t}\n\n\t\tvar timer;\n\n\t\tthis.element._.events({\n\t\t\t// click is needed too because it works with the keyboard as well\n\t\t\t\"click.mavo:preedit\": e => this.edit(),\n\t\t\t\"focus.mavo:preedit\": e => {\n\t\t\t\tthis.edit();\n\n\t\t\t\tif (!this.popup) {\n\t\t\t\t\tthis.editor.focus();\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"click.mavo:edit\": evt => {\n\t\t\t\t// Prevent default actions while editing\n\t\t\t\t// e.g. following links etc\n\t\t\t\tif (!this.exposed) {\n\t\t\t\t\tevt.preventDefault();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (!this.attribute) {\n\t\t\tthis.element._.events({\n\t\t\t\t\"mouseenter.mavo:preedit\": e => {\n\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\ttimer = setTimeout(() => this.edit(), 150);\n\t\t\t\t},\n\t\t\t\t\"mouseleave.mavo:preedit\": e => {\n\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Make element focusable, so it can actually receive focus\n\t\tthis.element._.data.prevTabindex = this.element.getAttribute(\"tabindex\");\n\t\tthis.element.tabIndex = 0;\n\t},\n\n\t// Called only the first time this primitive is edited\n\tinitEdit: function () {\n\t\tif (!this.editor) {\n\t\t\t// No editor provided, use default for element type\n\t\t\t// Find default editor for datatype\n\t\t\tvar editor = _.getMatch(this.element, _.editors);\n\n\t\t\tif (editor.create) {\n\t\t\t\t$.extend(this, editor, property => property != \"create\");\n\t\t\t}\n\n\t\t\tvar create = editor.create || editor;\n\t\t\tthis.editor = $.create($.type(create) === \"function\"? create.call(this) : create);\n\t\t\tthis.editorValue = this.value;\n\t\t\tthis.editorType = \"created\";\n\t\t}\n\n\t\tthis.editor._.events({\n\t\t\t\"input change\": evt => {\n\t\t\t\tvar unsavedChanges = this.mavo.unsavedChanges;\n\n\t\t\t\tthis.value = this.editorValue;\n\n\t\t\t\t// Editing exposed elements outside edit mode is instantly saved\n\t\t\t\tif (\n\t\t\t\t\tthis.exposed &&\n\t\t\t\t\t!this.mavo.editing && // must not be in edit mode\n\t\t\t\t    this.mavo.permissions.save // must be able to save\n\t\t\t\t) {\n\t\t\t\t\t// TODO what if change event never fires? What if user\n\t\t\t\t\tthis.unsavedChanges = false;\n\t\t\t\t\tthis.mavo.unsavedChanges = unsavedChanges;\n\n\t\t\t\t\t// Must not save too many times (e.g. not while dragging a slider)\n\t\t\t\t\tif (evt.type == \"change\") {\n\t\t\t\t\t\tthis.save(); // Save current element\n\n\t\t\t\t\t\t// Don’t call this.mavo.save() as it will save other fields too\n\t\t\t\t\t\t// We only want to save exposed controls, so save current status\n\t\t\t\t\t\tthis.mavo.storage.save();\n\n\t\t\t\t\t\t// Are there any unsaved changes from other properties?\n\t\t\t\t\t\tthis.mavo.setUnsavedChanges();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"focus\": evt => {\n\t\t\t\tthis.editor.select && this.editor.select();\n\t\t\t},\n\t\t\t\"keyup\": evt => {\n\t\t\t\tif (this.popup && evt.keyCode == 13 || evt.keyCode == 27) {\n\t\t\t\t\tif (this.popup.contains(document.activeElement)) {\n\t\t\t\t\t\tthis.element.focus();\n\t\t\t\t\t}\n\n\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\tthis.hidePopup();\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"mavo:datachange\": evt => {\n\t\t\t\tif (evt.property === \"output\") {\n\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t$.fire(this.editor, \"input\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (\"placeholder\" in this.editor) {\n\t\t\tthis.editor.placeholder = \"(\" + this.label + \")\";\n\t\t}\n\n\t\tif (!this.exposed) {\n\t\t\t// Copy any data-input-* attributes from the element to the editor\n\t\t\tvar dataInput = /^data-input-/i;\n\t\t\t$$(this.element.attributes).forEach(function (attribute) {\n\t\t\t\tif (dataInput.test(attribute.name)) {\n\t\t\t\t\tthis.editor.setAttribute(attribute.name.replace(dataInput, \"\"), attribute.value);\n\t\t\t\t}\n\t\t\t}, this);\n\n\t\t\tif (this.attribute) {\n\t\t\t\t// Set up popup\n\t\t\t\tthis.element.classList.add(\"using-popup\");\n\n\t\t\t\tthis.popup = this.popup || $.create(\"div\", {\n\t\t\t\t\tclassName: \"mv-popup\",\n\t\t\t\t\thidden: true,\n\t\t\t\t\tcontents: [\n\t\t\t\t\t\tthis.label + \":\",\n\t\t\t\t\t\tthis.editor\n\t\t\t\t\t]\n\t\t\t\t});\n\n\t\t\t\t// No point in having a dropdown in a popup\n\t\t\t\tif (this.editor.matches(\"select\")) {\n\t\t\t\t\tthis.editor.size = Math.min(10, this.editor.children.length);\n\t\t\t\t}\n\n\t\t\t\t// Toggle popup events & methods\n\t\t\t\tvar hideCallback = evt => {\n\t\t\t\t\tif (!this.popup.contains(evt.target) && !this.element.contains(evt.target)) {\n\t\t\t\t\t\tthis.hidePopup();\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tthis.showPopup = function() {\n\t\t\t\t\t$.unbind([this.element, this.popup], \".mavo:showpopup\");\n\t\t\t\t\tthis.popup._.after(this.element);\n\n\t\t\t\t\tvar x = this.element.offsetLeft;\n\t\t\t\t\tvar y = this.element.offsetTop + this.element.offsetHeight;\n\n\t\t\t\t\t // TODO what if it doesn’t fit?\n\t\t\t\t\tthis.popup._.style({ top:  `${y}px`, left: `${x}px` });\n\n\t\t\t\t\tthis.popup._.removeAttribute(\"hidden\"); // trigger transition\n\n\t\t\t\t\t$.events(document, \"focus click\", hideCallback, true);\n\t\t\t\t};\n\n\t\t\t\tthis.hidePopup = function() {\n\t\t\t\t\t$.unbind(document, \"focus click\", hideCallback, true);\n\n\t\t\t\t\tthis.popup.setAttribute(\"hidden\", \"\"); // trigger transition\n\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t$.remove(this.popup);\n\t\t\t\t\t}, 400); // TODO transition-duration could override this\n\n\t\t\t\t\t$.events(this.element, \"focus.mavo:showpopup click.mavo:showpopup\", evt => {\n\t\t\t\t\t\tthis.showPopup();\n\t\t\t\t\t}, true);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tif (!this.popup) {\n\t\t\tthis.editor.classList.add(\"mv-editor\");\n\t\t}\n\n\t\tthis.initEdit = null;\n\t},\n\n\tedit: function () {\n\t\tif (this.computed || this.editing) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.element._.unbind(\".mavo:preedit\");\n\n\t\tif (this.initEdit) {\n\t\t\tthis.initEdit();\n\t\t}\n\n\t\tif (this.popup) {\n\t\t\tthis.showPopup();\n\t\t}\n\n\t\tif (!this.attribute) {\n\t\t\tif (this.editor.parentNode != this.element && !this.exposed) {\n\t\t\t\tthis.editorValue = this.value;\n\t\t\t\tthis.element.textContent = \"\";\n\n\t\t\t\tif (!this.exposed) {\n\t\t\t\t\tthis.element.appendChild(this.editor);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.editing = true;\n\t}, // edit\n\n\tclear: function() {\n\t\tthis.value = this.emptyValue;\n\t},\n\n\trender: function(data) {\n\t\tif (Array.isArray(data)) {\n\t\t\tdata = data[0]; // TODO what is gonna happen to the rest? Lost?\n\t\t}\n\n\t\tif (typeof data === \"object\") {\n\t\t\tdata = data[this.property];\n\t\t}\n\n\t\tthis.value = data === undefined? this.default : data;\n\n\t\tthis.save();\n\t},\n\n\tfind: function(property) {\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\t},\n\n\tobserve: function() {\n\t\tif (!this.computed) {\n\t\t\tthis.observer = Mavo.observe(this.element, this.attribute, this.observer || (record => {\n\t\t\t\tif (this.attribute || !this.mavo.editing) {\n\t\t\t\t\tthis.value = this.getValue();\n\t\t\t\t}\n\t\t\t}));\n\t\t}\n\t},\n\n\tunobserve: function () {\n\t\tthis.observer && this.observer.disconnect();\n\t},\n\n\t/**\n\t * Get value from the DOM\n\t */\n\tgetValue: function(o) {\n\t\treturn _.getValue(this.element, this.attribute, this.datatype, o);\n\t},\n\n\tlazy: {\n\t\tlabel: function() {\n\t\t\treturn Mavo.readable(this.property);\n\t\t},\n\n\t\temptyValue: function() {\n\t\t\tswitch (this.datatype) {\n\t\t\t\tcase \"boolean\":\n\t\t\t\t\treturn false;\n\t\t\t\tcase \"number\":\n\t\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\treturn \"\";\n\t\t}\n\t},\n\n\tsetValue: function (value, o = {}) {\n\t\tthis.unobserve();\n\n\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\tvar presentational = value.presentational;\n\t\t\tvalue = value.value;\n\t\t}\n\n\t\tvalue = value || value === 0? value : \"\";\n\t\tvalue = _.safeCast(value, this.datatype);\n\n\t\tif (value == this._value && !o.force) {\n\t\t\treturn value;\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tthis.editorValue = value;\n\t\t}\n\n\t\tif (this.humanReadable && this.attribute) {\n\t\t\tpresentational = this.humanReadable(value);\n\t\t}\n\n\t\tif (!this.editing || this.attribute) {\n\t\t\tif (this.editor && this.editor.matches(\"select\") && this.editor.selectedOptions[0]) {\n\t\t\t\tpresentational = this.editor.selectedOptions[0].textContent;\n\t\t\t}\n\n\t\t\t_.setValue(this.element, {value, presentational}, this.attribute, this.datatype);\n\t\t}\n\n\t\tthis.empty = value === \"\";\n\n\t\tthis._value = value;\n\n\t\tif (!o.silent) {\n\t\t\tif (!this.computed) {\n\t\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t\t}\n\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\t$.fire(this.element, \"mavo:datachange\", {\n\t\t\t\t\tproperty: this.property,\n\t\t\t\t\tvalue: value,\n\t\t\t\t\tmavo: this.mavo,\n\t\t\t\t\tnode: this,\n\t\t\t\t\tdirty: this.editing,\n\t\t\t\t\taction: \"propertychange\"\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tthis.observe();\n\n\t\treturn value;\n\t},\n\n\tlive: {\n\t\tvalue: function (value) {\n\t\t\treturn this.setValue(value);\n\t\t},\n\n\t\tempty: function(value) {\n\t\t\tvar hide = value && !this.exposed && !(this.attribute && $(Mavo.selectors.property, this.element));\n\t\t\tthis.element.classList.toggle(\"empty\", hide);\n\t\t},\n\n\t\tediting: function (value) {\n\t\t\tthis.element.classList.toggle(\"editing\", value);\n\t\t},\n\n\t\tcomputed: function (value) {\n\t\t\tthis.element.classList.toggle(\"computed\", value);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tgetMatch: function (element, all) {\n\t\t\t// TODO specificity\n\t\t\tvar ret = null;\n\n\t\t\tfor (var selector in all) {\n\t\t\t\tif (element.matches(selector)) {\n\t\t\t\t\tret = all[selector];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\tgetValueAttribute: function (element) {\n\t\t\tvar ret = element.getAttribute(\"data-attribute\") || _.getMatch(element, _.attributes);\n\n\t\t\t// TODO refactor this\n\t\t\tif (ret && ret.value) {\n\t\t\t\tret = $.extend(new String(ret.value), ret);\n\t\t\t}\n\n\t\t\tif (!ret || ret === \"null\") {\n\t\t\t\tret = null;\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\tgetDatatype: function (element, attribute) {\n\t\t\tvar ret = element.getAttribute(\"datatype\");\n\n\t\t\tif (!ret) {\n\t\t\t\tfor (var selector in _.datatypes) {\n\t\t\t\t\tif (element.matches(selector)) {\n\t\t\t\t\t\tret = _.datatypes[selector][attribute];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tret = ret || \"string\";\n\n\t\t\treturn ret;\n\t\t},\n\n\t\t/**\n\t\t * Only cast if conversion is lossless\n\t\t */\n\t\tsafeCast: function(value, datatype) {\n\t\t\tvar existingType = typeof value;\n\t\t\tvar cast = _.cast(value, datatype);\n\n\t\t\tif (value === null || value === undefined) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"boolean\") {\n\t\t\t\tif (value === \"false\" || value === 0 || value === \"\") {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif (value === \"true\" || value > 0) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"number\") {\n\t\t\t\tif (/^[-+]?[0-9.e]+$/i.test(value + \"\")) {\n\t\t\t\t\treturn cast;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\treturn cast;\n\t\t},\n\n\t\t/**\n\t\t * Cast to a different primitive datatype\n\t\t */\n\t\tcast: function(value, datatype) {\n\t\t\tswitch (datatype) {\n\t\t\t\tcase \"number\": return +value;\n\t\t\t\tcase \"boolean\": return !!value;\n\t\t\t\tcase \"string\": return value + \"\";\n\t\t\t}\n\n\t\t\treturn value;\n\t\t},\n\n\t\tgetValue: function (element, attribute, datatype, o = {}) {\n\t\t\tattribute = attribute || attribute === null? attribute : _.getValueAttribute(element);\n\t\t\tdatatype = datatype || _.getDatatype(element, attribute);\n\n\t\t\tvar ret;\n\n\t\t\t// TODO Get rid of this horrible raw hack\n\t\t\tif (attribute in element && !o.raw && _.useProperty(element, attribute)) {\n\t\t\t\t// Returning properties (if they exist) instead of attributes\n\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\tret = element[attribute];\n\t\t\t}\n\t\t\telse if (attribute) {\n\t\t\t\tret = element.getAttribute(attribute);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tret = element.getAttribute(\"content\") || element.textContent || null;\n\t\t\t}\n\n\t\t\treturn _.safeCast(ret, datatype);\n\t\t},\n\n\t\tsetValue: function (element, value, attribute, datatype) {\n\t\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\t\tvar presentational = value.presentational;\n\t\t\t\tvalue = value.value;\n\t\t\t}\n\n\t\t\tif (attribute !== null) {\n\t\t\t\tattribute = attribute ||  _.getValueAttribute(element);\n\t\t\t}\n\n\t\t\tif (attribute in element && _.useProperty(element, attribute) && element[attribute] != value) {\n\t\t\t\t// Setting properties (if they exist) instead of attributes\n\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\ttry {\n\t\t\t\t\telement[attribute] = value;\n\t\t\t\t}\n\t\t\t\tcatch (e) {}\n\t\t\t}\n\n\t\t\t// Set attribute anyway, even if we set a property because when\n\t\t\t// they're not in sync it gets really fucking confusing.\n\t\t\tif (attribute) {\n\t\t\t\tif (element.getAttribute(attribute) != value) { // intentionally non-strict, e.g. \"3.\" !== 3\n\t\t\t\t\telement.setAttribute(attribute, value);\n\n\t\t\t\t\tif (presentational) {\n\t\t\t\t\t\telement.textContent = presentational;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (datatype === \"number\" && !presentational) {\n\t\t\t\t\tpresentational = _.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\telement.textContent = presentational || value;\n\n\t\t\t\tif (presentational && element.setAttribute) {\n\t\t\t\t\telement.setAttribute(\"content\", value);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t *  Set/get a property or an attribute?\n\t\t * @return {Boolean} true to use a property, false to use the attribute\n\t\t */\n\t\tuseProperty: function(element, attribute) {\n\t\t\tif ([\"href\", \"src\"].indexOf(attribute) > -1) {\n\t\t\t\t// URL properties resolve \"\" as location.href, fucking up emptiness checks\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (element.namespaceURI == \"http://www.w3.org/2000/svg\") {\n\t\t\t\t// SVG has a fucked up DOM, do not use these properties\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\n\t\tlazy: {\n\t\t\tformatNumber: () => {\n\t\t\t\tvar numberFormat = new Intl.NumberFormat(\"en-US\", {maximumFractionDigits:2});\n\n\t\t\t\treturn function(value) {\n\t\t\t\t\tif (value === Infinity || value === -Infinity) {\n\t\t\t\t\t\t// Pretty print infinity\n\t\t\t\t\t\treturn value < 0? \"-∞\" : \"∞\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn numberFormat.format(value);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n});\n\n// Define default attributes\n_.attributes = {\n\t\"img, video, audio\": \"src\",\n\t\"a, link\": \"href\",\n\t\"select, input, textarea, meter, progress\": \"value\",\n\t\"input[type=checkbox]\": \"checked\",\n\t\"time\": {\n\t\tvalue: \"datetime\",\n\t\thumanReadable: function (value) {\n\t\t\tvar date = new Date(value);\n\n\t\t\tif (!value || isNaN(date)) {\n\t\t\t\treturn \"(No \" + this.label + \")\";\n\t\t\t}\n\n\t\t\t// TODO do this properly (account for other datetime datatypes and different formats)\n\t\t\tvar options = {\n\t\t\t\t\"date\": {day: \"numeric\", month: \"short\", year: \"numeric\"},\n\t\t\t\t\"month\": {month: \"long\"},\n\t\t\t\t\"time\": {hour: \"numeric\", minute: \"numeric\"},\n\t\t\t\t\"datetime-local\": {day: \"numeric\", month: \"short\", year: \"numeric\", hour: \"numeric\", minute: \"numeric\"}\n\t\t\t};\n\n\t\t\tvar format = options[this.editor && this.editor.type] || options.date;\n\t\t\tformat.timeZone = \"UTC\";\n\n\t\t\treturn date.toLocaleString(\"en-GB\", format);\n\t\t}\n\t},\n\t\"meta\": \"content\"\n};\n\n// Basic datatypes per attribute\n// Only number, boolean\n_.datatypes = {\n\t\"input[type=checkbox]\": {\n\t\t\"checked\": \"boolean\"\n\t},\n\t\"input[type=range], input[type=number], meter, progress\": {\n\t\t\"value\": \"number\"\n\t}\n};\n\n_.editors = {\n\t\"*\": {\"tag\": \"input\"},\n\n\t\".number\": {\n\t\t\"tag\": \"input\",\n\t\t\"type\": \"number\"\n\t},\n\n\t\".boolean\": {\n\t\t\"tag\": \"input\",\n\t\t\"type\": \"checkbox\"\n\t},\n\n\t\"a, img, video, audio, .url\": {\n\t\t\"tag\": \"input\",\n\t\t\"type\": \"url\",\n\t\t\"placeholder\": \"http://\"\n\t},\n\n\t// Block elements\n\t\"p, div, li, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address, .multiline\": {\n\t\tcreate: function() {\n\t\t\tvar display = getComputedStyle(this.element).display;\n\t\t\tvar tag = display.indexOf(\"inline\") === 0? \"input\" : \"textarea\";\n\t\t\tvar editor = $.create(tag);\n\n\t\t\tif (tag == \"textarea\") {\n\t\t\t\tvar width = this.element.offsetWidth;\n\n\t\t\t\tif (width) {\n\t\t\t\t\teditor.width = width;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn editor;\n\t\t},\n\n\t\tget editorValue () {\n\t\t\treturn this.editor && _.safeCast(this.editor.value, this.datatype);\n\t\t},\n\n\t\tset editorValue (value) {\n\t\t\tif (this.editor) {\n\t\t\t\tthis.editor.value = value ? value.replace(/\\r?\\n/g, \"\") : \"\";\n\t\t\t}\n\t\t}\n\t},\n\n\t\"meter, progress\": function() {\n\t\treturn $.create({\n\t\t\ttag: \"input\",\n\t\t\ttype: \"range\",\n\t\t\tmin: this.element.getAttribute(\"min\") || 0,\n\t\t\tmax: this.element.getAttribute(\"max\") || 100\n\t\t});\n\t},\n\n\t\"time, .date\": function() {\n\t\tvar types = {\n\t\t\t\"date\": /^[Y\\d]{4}-[M\\d]{2}-[D\\d]{2}$/i,\n\t\t\t\"month\": /^[Y\\d]{4}-[M\\d]{2}$/i,\n\t\t\t\"time\": /^[H\\d]{2}:[M\\d]{2}/i,\n\t\t\t\"week\": /[Y\\d]{4}-W[W\\d]{2}$/i,\n\t\t\t\"datetime-local\": /^[Y\\d]{4}-[M\\d]{2}-[D\\d]{2} [H\\d]{2}:[M\\d]{2}/i\n\t\t};\n\n\t\tvar datetime = this.element.getAttribute(\"datetime\") || \"YYYY-MM-DD\";\n\n\t\tfor (var type in types) {\n\t\t\tif (types[type].test(datetime)) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn $.create(\"input\", {type: type});\n\t}\n};\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}