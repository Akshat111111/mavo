{"version":3,"sources":["scope.js"],"names":["$","$$","_","Mavo","Scope","Class","extends","Unit","constructor","element","mavo","o","_this","this","properties","scope","hooks","run","Primitive","getValueAttribute","property","selectors","forEach","Node","getProperty","contains","existing","template","constructorOptions","collection","Collection","add","mutable","is","obj","create","vocabElement","isRoot","closest","vocab","getAttribute","getData","ret","call","undefined","propagate","computed","data","dirty","unhandled","extend","type","DEFAULT_TYPE","find","prop","callback","_arguments","arguments","each","apply","save","placeholder","unsavedChanges","done","unbind","propagated","render","_this2","Array","isArray","parentScope","parentNode","static","all","WeakMap","normalize","setAttribute","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Scope = $.Class({\n\textends: Mavo.Unit,\n\tconstructor: function (element, mavo, o) {\n\t\tthis.properties = {};\n\n\t\tthis.scope = this;\n\n\t\tMavo.hooks.run(\"scope-init-start\", this);\n\n\t\t// Should this element also create a primitive?\n\t\tif (Mavo.Primitive.getValueAttribute(this.element)) {\n\t\t\tvar obj = this.properties[this.property] = new Mavo.Primitive(this.element, this.mavo, {scope: this});\n\t\t}\n\n\t\t// Create Mavo objects for all properties in this scope (primitives or scopes),\n\t\t// but not properties in descendant scopes (they will be handled by their scope)\n\t\t$$(Mavo.selectors.property, this.element).forEach(element => {\n\t\t\tvar property = Mavo.Node.getProperty(element);\n\n\t\t\tif (this.contains(element)) {\n\t\t\t\tvar existing = this.properties[property];\n\t\t\t\tvar template = this.template? this.template.properties[property] : null;\n\t\t\t\tvar constructorOptions = {template, scope: this};\n\n\t\t\t\tif (existing) {\n\t\t\t\t\t// Two scopes with the same property, convert to static collection\n\t\t\t\t\tvar collection = existing;\n\n\t\t\t\t\tif (!(existing instanceof Mavo.Collection)) {\n\t\t\t\t\t\tcollection = new Mavo.Collection(existing.element, this.mavo, constructorOptions);\n\t\t\t\t\t\tthis.properties[property] = existing.collection = collection;\n\t\t\t\t\t\tcollection.add(existing);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!collection.mutable && Mavo.is(\"multiple\", element)) {\n\t\t\t\t\t\tcollection.mutable = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tcollection.add(element);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// No existing properties with this id, normal case\n\t\t\t\t\tvar obj = Mavo.Node.create(element, this.mavo, constructorOptions);\n\n\t\t\t\t\tthis.properties[property] = obj;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tvar vocabElement = this.isRoot? this.element.closest(\"[vocab]\") : null || this.element;\n\t\tthis.vocab = vocabElement.getAttribute(\"vocab\");\n\n\t\tMavo.hooks.run(\"scope-init-end\", this);\n\t},\n\n\tget isRoot() {\n\t\treturn !this.property;\n\t},\n\n\tgetData: function(o) {\n\t\to = o || {};\n\n\t\tvar ret = this.super.getData.call(this, o);\n\n\t\tif (ret !== undefined) {\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = {};\n\n\t\tthis.propagate(obj => {\n\n\t\t\tif ((!obj.computed || o.computed) && !(obj.property in ret)) {\n\t\t\t\tvar data = obj.getData(o);\n\n\t\t\t\tif (data !== null || o.null) {\n\t\t\t\t\tret[obj.property] = data;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (!o.dirty || o.unhandled) {\n\t\t\t$.extend(ret, this.unhandled);\n\t\t}\n\n\t\tif (this.type && this.type != _.DEFAULT_TYPE) {\n\t\t\tret[\"@type\"] = this.type;\n\t\t}\n\n\t\tif (this.vocab) {\n\t\t\tret[\"@context\"] = this.vocab;\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\t/**\n\t * Search entire subtree for property, return relative value\n\t * @return {Mavo.Unit}\n\t */\n\tfind: function(property) {\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\n\t\tif (property in this.properties) {\n\t\t\treturn this.properties[property].find(property);\n\t\t}\n\n\t\tfor (var prop in this.properties) {\n\t\t\tvar ret = this.properties[prop].find(property);\n\n\t\t\tif (ret !== undefined) {\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagate: function(callback) {\n\t\t$.each(this.properties, (property, obj) => {\n\t\t\tobj.call(...arguments);\n\t\t});\n\t},\n\n\tsave: function() {\n\t\tif (this.placeholder) {\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tdone: function() {\n\t\t$.unbind(this.element, \".mavo:edit\");\n\t},\n\n\tpropagated: [\"save\", \"done\", \"import\", \"clear\"],\n\n\t// Inject data in this element\n\trender: function(data) {\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tMavo.hooks.run(\"scope-render-start\", this);\n\n\t\t// TODO retain dropped elements\n\t\tdata = Array.isArray(data)? data[0] : data;\n\n\t\t// TODO what if it was a primitive and now it's a scope?\n\t\t// In that case, render the this.properties[this.property] with it\n\n\t\tthis.unhandled = $.extend({}, data, property => {\n\t\t\treturn !(property in this.properties);\n\t\t});\n\n\t\tthis.propagate(obj => {\n\t\t\tobj.render(data[obj.property]);\n\t\t});\n\n\t\tthis.save();\n\n\t\tMavo.hooks.run(\"scope-render-end\", this);\n\t},\n\n\t// Check if this scope contains a property\n\t// property can be either a Mavo.Unit or a Node\n\tcontains: function(property) {\n\t\tif (property instanceof Mavo.Unit) {\n\t\t\treturn property.parentScope === this;\n\t\t}\n\n\t\treturn property.parentNode && (this.element === property.parentNode.closest(Mavo.selectors.scope));\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tDEFAULT_TYPE: \"Item\",\n\n\t\tnormalize: function(element) {\n\t\t\t// Get & normalize typeof name, if exists\n\t\t\tif (Mavo.is(\"scope\", element)) {\n\t\t\t\tvar type = element.getAttribute(\"typeof\") || element.getAttribute(\"itemtype\") || _.DEFAULT_TYPE;\n\n\t\t\t\telement.setAttribute(\"typeof\", type);\n\n\t\t\t\treturn type;\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}