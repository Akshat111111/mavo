{"version":3,"sources":["collection.js"],"names":["$","$$","Mavo","Collection","Class","extends","Node","constructor","element","mavo","o","this","templateElement","children","fromTemplate","properties","selectors","property","map","getProperty","mutable","matches","multiple","cloneNode","item","createItem","add","itemTemplate","template","hooks","run","length","containsTemplate","getData","arguments","undefined","env","context","options","data","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","Symbol","iterator","next","done","value","deleted","itemData","push","err","unhandled","before","concat","after","_this","Unit","create","collection","type","permissions","can","itemControls","className","inside","contents","tag","title","name","events","click","evt","replace","bottomUp","indexOf","edit","index","get","parentNode","nextItem","_","marker","splice","i","_item","silent","fire","node","action","unsavedChanges","delete","hard","_this2","remove","transition","opacity","then","style","clear","propagate","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","childNodes","save","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","_item2","propagated","revert","_iteratorNormalCompletion4","_didIteratorError4","_iteratorError4","_step4","_iterator4","_item3","render","_this3","toArray","fragment","document","createDocumentFragment","forEach","datum","appendChild","insertBefore","slice","find","items","filter","ret","flatten","live","_mutable","needsEdit","required","hidden","classList","addButton","tagName","toLowerCase","containerSelector","container","closest","lazy","order","getAttribute","test","compareDocumentPosition","DOCUMENT_POSITION_FOLLOWING","closestCollection","parent","_this4","selector","group","button","contains","textContent","addEventListener","preventDefault","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.children = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.children.length;\n\t},\n\n\t// Collection still contains its template as data\n\tget containsTemplate() {\n\t\treturn this.children.length && this.children[0].element === this.element;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: []\n\t\t};\n\n\t\tfor (item of this.children) {\n\t\t\tif (!item.deleted) {\n\t\t\t\tlet itemData = item.getData(env.options);\n\n\t\t\t\tif (itemData) {\n\t\t\t\t\tenv.data.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this.unhandled && env.options.unhandled) {\n\t\t\tenv.data = this.unhandled.before.concat(env.data, this.unhandled.after);\n\t\t}\n\n\t\tif (!this.mutable && env.data.length == 1) {\n\t\t\t// See https://github.com/LeaVerou/mavo/issues/50#issuecomment-266079652\n\t\t\tenv.data = env.data[0];\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Unit.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type\n\t\t});\n\n\t\t// Add delete & add buttons\n\t\tif (this.mutable) {\n\t\t\tthis.mavo.permissions.can(\"edit\", () => {\n\t\t\t\tvar itemControls = $(\".mv-item-controls\", element) || $.create({\n\t\t\t\t\tclassName: \"mv-item-controls mv-ui\",\n\t\t\t\t\tinside: element\n\t\t\t\t});\n\n\t\t\t\t$.contents(itemControls, [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Delete this \" + this.name,\n\t\t\t\t\t\tclassName: \"delete\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.delete(item)\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: `Add new ${this.name.replace(/s$/i, \"\")} ${this.bottomUp? \"after\" : \"before\"}`,\n\t\t\t\t\t\tclassName: \"add\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.add(null, this.children.indexOf(item)).edit()\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]);\n\t\t\t});\n\t\t}\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Unit} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Unit.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (index in this.children) {\n\t\t\tif (this.bottomUp) {\n\t\t\t\tindex++;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t}\n\n\t\tif (!item.element.parentNode) {\n\t\t\t// Add it to the DOM, if not already in\n\t\t\tvar nextItem = this.children[index];\n\n\t\t\titem.element._.before(nextItem && nextItem.element || this.marker);\n\t\t}\n\n\t\t// Update internal data model\n\t\tthis.children.splice(index, 0, item);\n\n\t\tfor (let i = index - 1; i < this.length; i++) {\n\t\t\tlet item = this.children[i];\n\n\t\t\tif (item) {\n\t\t\t\titem.index = i;\n\n\t\t\t\tif (!o.silent) {\n\t\t\t\t\titem.element._.fire(\"mavo:datachange\", {\n\t\t\t\t\t\tnode: this,\n\t\t\t\t\t\tmavo: this.mavo,\n\t\t\t\t\t\taction: \"add\",\n\t\t\t\t\t\titem\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!o.silent) {\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t}\n\n\t\treturn item;\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.children.splice(this.children.indexOf(item), 1);\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.element._.fire(\"mavo:datachange\", {\n\t\t\t\tnode: this,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\taction: \"delete\",\n\t\t\t\titem: item\n\t\t\t});\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\t/**\n\t * Delete all items in the collection.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.element.remove) {\n\t\t\t\t\titem.element.remove();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Document fragment, remove all children\n\t\t\t\t\tfor (let node of item.element.childNodes) {\n\t\t\t\t\t\tnode => node.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.children = [];\n\n\t\t\tthis.marker._.fire(\"mavo:datachange\", {\n\t\t\t\tnode: this,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\taction: \"clear\"\n\t\t\t});\n\t\t}\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.children) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\"],\n\n\trevert: function() {\n\t\tfor (let item of this.children) {\n\t\t\t// Delete added items\n\t\t\tif (item.unsavedChanges) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Bring back deleted items\n\t\t\t\tif (item.deleted) {\n\t\t\t\t\titem.deleted = false;\n\t\t\t\t}\n\n\t\t\t\t// Revert all properties\n\t\t\t\titem.revert();\n\t\t\t}\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tthis.unhandled = {before: [], after: []};\n\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.children.forEach((item, i) => item.render(data && data[i]));\n\n\t\t\tif (data) {\n\t\t\t\tthis.unhandled.after = data.slice(this.children.length);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.clear();\n\n\t\t\t// Using document fragments improved rendering performance by 60%\n\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\tdata.forEach((datum, i) => {\n\t\t\t\tvar item = this.createItem();\n\n\t\t\t\titem.render(datum);\n\n\t\t\t\tthis.children.push(item);\n\t\t\t\titem.index = i;\n\n\t\t\t\tfragment.appendChild(item.element);\n\t\t\t});\n\n\t\t\tthis.marker.parentNode.insertBefore(fragment, this.marker);\n\t\t}\n\n\t\tthis.save();\n\t},\n\n\tfind: function(property) {\n\t\tvar items = this.children.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has data-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\tthis.mavo.needsEdit = true;\n\n\t\t\t\tthis.required = this.templateElement.matches(Mavo.selectors.required);\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = $.create(\"div\", {\n\t\t\t\t\thidden: true,\n\t\t\t\t\tclassName: \"mv-marker\",\n\t\t\t\t\tafter: this.templateElement\n\t\t\t\t});\n\n\t\t\t\tthis.templateElement.classList.add(\"mv-item\");\n\n\t\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\t\tthis.addButton._.before($.value(this.children[0], \"element\") || this.marker);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\n\t\t\t\t\t\tif (containerSelector) {\n\t\t\t\t\t\t\tvar after = this.marker.closest(containerSelector);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.addButton._.after(after && after.parentNode? after : this.marker);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"data-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.templateElement) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.item);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.add-${this.property}`;\n\t\t\tvar group = this.closestCollection || this.marker.closest(Mavo.selectors.group);\n\n\t\t\tif (group) {\n\t\t\t\tvar button = $$(selector, group).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.add().edit();\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}