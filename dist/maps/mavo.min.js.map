{"version":3,"sources":["mavo.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","$$","_","self","Mavo","Class","constructor","element","_this","this","index","all","push","id","getAttribute","Node","getProperty","setAttribute","unhandled","classList","contains","autoEdit","has","is","selectors","rootGroup","removeAttribute","add","storage","urlParam","source","wrapper","closest","test","Backend","create","permissions","Permissions","property","group","concat","forEach","hasAttribute","addEventListener","evt","keyCode","superKey","preventDefault","save","primitive","isGroup","not","formControl","Primitive","getValueAttribute","matches","around","parentNode","ui","bar","className","start","status","inside","authControls","can","loginHash","login","tag","href","textContent","events","click","after","location","hash","history","replaceState","document","title","URL","window","remove","unbind","backend","innerHTML","contents","name","e","logout","needsEdit","hooks","run","root","setUnsavedChanges","onchange","_ref","action","value","toggle","edit","onclick","editing","done","mouseenter focus","mouseleave blur","revert","disabled","unsavedChanges","clear","appendChild","cannot","read","load","on","fire","off","debouncedSave","debounce","callback","node","saved","requestAnimationFrame","removeEventListener","data","getData","o","toJSON","arguments","undefined","render","context","confirm","store","target","item","type","parent","walk","obj","_this2","inProgress","ready","then","get","err","Promise","reject","response","JSON","parse","xhr","console","error","log","stack","_this3","put","file","dataString","lastSaved","Date","now","live","toggleAttribute","static","navigator","platform","indexOf","init","container","filter","map","Hooks","s","specificProperty","multiple","required","option","li","tr","dt","dd","selector","split","join","or","selector1","selector2","and","ret","s1","apply","s2","andNot","extend","output","autoMultiple","include","Intl","documentElement","Stretchy","Bliss"],"mappings":"AAAA,YAEA,SAASA,oBAAmBC,GAAO,GAAIC,MAAMC,QAAQF,GAAM,CAAE,IAAK,GAAIG,GAAI,EAAGC,EAAOH,MAAMD,EAAIK,QAASF,EAAIH,EAAIK,OAAQF,IAAOC,EAAKD,GAAKH,EAAIG,EAAM,OAAOC,GAAe,MAAOH,OAAMK,KAAKN,IAF1L,SAAWO,EAAGC,GAId,GAAIC,GAAIC,KAAKC,KAAOJ,EAAEK,OACrBC,YAAa,SAAUC,GAAS,GAAAC,GAAAC,IAqE/B,IAnEAA,KAAKC,MAAQR,EAAES,IAAIC,KAAKH,MAGxBA,KAAKI,GAAKN,EAAQO,aAAa,cAAgBV,KAAKW,KAAKC,YAAYT,IAAYA,EAAQM,IAA/E,OAA4FJ,KAAKC,MAC3GH,EAAQU,aAAa,YAAaR,KAAKI,IAEvCJ,KAAKS,UAAYX,EAAQY,UAAUC,SAAS,qBAE5CX,KAAKY,SAAWnB,EAAEoB,IAAI,WAAYf,GAElCE,KAAKF,QAAUL,EAAEqB,GAAG,QAAShB,GAAUA,EAAUP,EAAEE,EAAEsB,UAAUC,UAAWlB,GAErEE,KAAKF,UACTA,EAAQU,aAAa,SAAUV,EAAQO,aAAa,aAAe,IACnEP,EAAQmB,gBAAgB,YACxBjB,KAAKF,QAAUA,GAGhBE,KAAKF,QAAQY,UAAUQ,IAAI,WAET,GAAdlB,KAAKC,QACRD,KAAKmB,QAAU1B,EAAE2B,SAAS,SAC1BpB,KAAKqB,OAAS5B,EAAE2B,SAAS,WAG1BpB,KAAKsB,QAAUxB,EAAQyB,QAAQ,gBAAkBzB,EAEjDE,KAAKmB,QAAUnB,KAAKmB,SAAW1B,EAAE2B,SAAYpB,KAAKI,GAAnB,WAAkCN,EAAQO,aAAa,eAAiB,KACvGL,KAAKqB,OAASrB,KAAKqB,QAAU5B,EAAE2B,SAAYpB,KAAKI,GAAnB,YAAmCN,EAAQO,aAAa,gBAAkB,KAEnGL,KAAKmB,UAAY,gBAAgBK,KAAKxB,KAAKmB,WAC9CnB,KAAKmB,QAAU1B,EAAEgC,QAAQC,OAAO1B,KAAKmB,QAASnB;AAG3CA,KAAKqB,SACRrB,KAAKqB,OAAS5B,EAAEgC,QAAQC,OAAO1B,KAAKqB,OAAQrB,OAG7CA,KAAK2B,YAAc3B,KAAKmB,QAAUnB,KAAKmB,QAAQQ,YAAc,GAAIhC,MAAKiC,YAGtEpC,EAAGC,EAAEsB,UAAUc,SAAW,KAAOpC,EAAEsB,UAAUe,MAAOhC,GAASiC,QAAQ/B,KAAKF,UAAUkC,QAAQ,SAAAlC,GACvFL,EAAEqB,GAAG,eAAgBhB,KAAaA,EAAQmC,aAAa,kBAC1DnC,EAAQU,aAAa,gBAAiB,MAKxCR,KAAKsB,QAAQY,iBAAiB,UAAW,SAAAC,GACrB,IAAfA,EAAIC,SAAiBD,EAAI1C,EAAE4C,YAC9BF,EAAIG,iBACJvC,EAAKwC,UAKP/C,EAAGC,EAAEsB,UAAUyB,UAAW1C,GAASkC,QAAQ,SAAAlC,GAC1C,GAAI2C,GAAUlD,EAAKE,EAAEsB,UAAU2B,IAAIjD,EAAEsB,UAAU4B,aAAjC,KAAkDlD,EAAEsB,UAAUc,SAAY/B,KACxEH,KAAKmB,GAAG,WAAYhB,IAC0B,OAA9CH,KAAKiD,UAAUC,kBAAkB/C,KACzCA,EAAQgD,QAAQ,WAEpBL,IACH3C,EAAQU,aAAa,SAAU,MAI7BR,KAAKsB,UAAYtB,KAAKF,SAAWL,EAAEqB,GAAG,WAAYhB,GAAU,CAE/D,GAAIiD,GAAS/C,KAAKF,OAGdE,MAAKF,QAAQgD,QAAQ,cACxBC,EAASA,EAAOC,WAERhD,KAAKF,QAAQgD,QAAQ,iCAC7BC,EAASA,EAAOxB,QAAQ,UAGzBvB,KAAKsB,QAAU/B,EAAEmC,QAASqB,OAAAA,IAG3B/C,KAAKsB,QAAQZ,UAAUQ,IAAI,cAE3BlB,KAAKiD,IACJC,IAAK3D,EAAE,UAAWS,KAAKsB,UAAY/B,EAAEmC;AACpCyB,UAAW,eACXC,MAAOpD,KAAKsB,WAIdtB,KAAKiD,GAAGI,OAAS9D,EAAE,UAAWS,KAAKiD,GAAGC,MAAQ3D,EAAEmC,OAAO,QACtDyB,UAAW,SACXG,OAAQtD,KAAKiD,GAAGC,MAGblD,KAAKmB,UAERnB,KAAKuD,gBAELvD,KAAK2B,YAAY6B,IAAI,QAAS,WAG7BzD,EAAK0D,UAAY,UAAY9D,KAAKO,IAAI,KAATH,EAAsB,GAAK,IAAMA,EAAKK,IAEnEL,EAAKwD,aAAaG,MAAQnE,EAAEmC,QAC3BiC,IAAK,IACLC,KAAM7D,EAAK0D,UACXI,YAAa,QACbV,UAAW,eACXW,QACCC,MAAO,SAAA5B,GACNA,EAAIG,iBACJvC,EAAKoB,QAAQuC,UAGfM,MAAOzE,EAAE,UAAWQ,EAAKkD,GAAGC,MAI7B,IAAIQ,IACHA,EAAQ,WACJO,SAASC,OAASnE,EAAK0D,YAE1BU,QAAQC,aAAa,KAAMC,SAASC,MAAO,GAAIC,KAAI,GAAIN,UAAY,IACnElE,EAAKoB,QAAQuC,aAGfc,OAAOtC,iBAAiB,kBAAmBwB,IACzC,WACFnE,EAAEkF,OAAO1E,EAAKwD,aAAaG,OAC3B3D,EAAKuB,QAAQ7B,EAAEiF,OAAO,qBAIvB1E,KAAKsB,QAAQY,iBAAiB,kBAAmB,SAAAC,GAChD,GAAIA,EAAIwC,SAAW5E,EAAKoB,QAAS,CAChC,GAAIkC,GAAS9D,EAAE,UAAWQ,EAAKkD,GAAGC,IAClCG,GAAOuB,UAAY,GACnBvB,EAAO5D,EAAEoF,UACR,gBAAkB1C,EAAIwC,QAAQvE,GAAK,QAClCuD,IAAK,SAAUiB,UAAWzC,EAAI2C,OAE9BnB,IAAK,SACLE,YAAa,SACbV,UAAW,SACXW;AACCC,MAAO,SAAAgB,GAAA,MAAK5C,GAAIwC,QAAQK,iBAO7BhF,KAAKsB,QAAQY,iBAAiB,mBAAoB,SAAAC,GACjD5C,EAAE,UAAWQ,EAAKkD,GAAGC,KAAKW,YAAc,MAK1C7D,KAAKiF,WAAY,EAGjBtF,KAAKuF,MAAMC,IAAI,mBAAoBnF,MAEnCA,KAAKoF,KAAOzF,KAAKW,KAAKoB,OAAO1B,KAAKF,QAASE,MAE3CL,KAAKuF,MAAMC,IAAI,kBAAmBnF,MAElCA,KAAKqF,mBAAkB,GAEvBrF,KAAK2B,YAAY2D,SAAS,SAAAC,GAAqB,GAAnBC,GAAmBD,EAAnBC,OAAQC,EAAWF,EAAXE,KACnC1F,GAAKuB,QAAQZ,UAAUgF,OAAvB,OAAqCF,IAAYC,KAGlDzF,KAAK2B,YAAY6B,KAAK,OAAQ,MAAO,UAAW,WAC/CzD,EAAKkD,GAAG0C,KAAOpG,EAAEmC,OAAO,UACvByB,UAAW,OACXU,YAAa,OACb+B,QAAS,SAAAb,GAAA,MAAKhF,GAAK8F,QAAS9F,EAAK+F,OAAS/F,EAAK4F,QAC/CrC,OAAQvD,EAAKkD,GAAGC,MAGbnD,EAAKa,UACRb,EAAKuB,QAAQY,iBAAiB,YAAa,SAAAC,GAAA,MAAOpC,GAAKkD,GAAG0C,KAAK5B,WAE9D,WACFxE,EAAEkF,OAAO1E,EAAKkD,GAAG0C,MAEb5F,EAAK8F,SACR9F,EAAK+F,SAIH9F,KAAKiF,WACRjF,KAAK2B,YAAY6B,IAAI,OAAQ,WAC5BzD,EAAKkD,GAAGV,KAAOhD,EAAEmC,OAAO,UACvByB,UAAW,OACXU,YAAa,OACbC,QACCC,MAAO,SAAAgB,GAAA,MAAKhF,GAAKwC,QACjBwD,mBAAoB,SAAAhB,GACnBhF,EAAKuB,QAAQZ,UAAUQ,IAAI;AAC3BnB,EAAKsF,qBAENW,kBAAmB,SAAAjB,GAAA,MAAKhF,GAAKuB,QAAQZ,UAAU+D,OAAO,kBAEvDnB,OAAQvD,EAAKkD,GAAGC,MAGjBnD,EAAKkD,GAAGgD,OAAS1G,EAAEmC,OAAO,UACzByB,UAAW,SACXU,YAAa,SACbqC,UAAU,EACVpC,QACCC,MAAO,SAAAgB,GAAA,MAAKhF,GAAKkG,UACjBF,mBAAoB,SAAAhB,GACdhF,EAAKoG,iBACTpG,EAAKuB,QAAQZ,UAAUQ,IAAI,kBAC3BnB,EAAKsF,sBAGPW,kBAAmB,SAAAjB,GAAA,MAAKhF,GAAKuB,QAAQZ,UAAU+D,OAAO,oBAEvDnB,OAAQvD,EAAKkD,GAAGC,OAEf,WACF3D,EAAEkF,QAAQ1E,EAAKkD,GAAGV,KAAMxC,EAAKkD,GAAGgD,SAChClG,EAAKkD,GAAGV,KAAOxC,EAAKkD,GAAGgD,OAAS,OAIlCjG,KAAK2B,YAAY6B,IAAI,SAAU,WAC9BzD,EAAKkD,GAAGmD,MAAQ7G,EAAEmC,OAAO,UACxByB,UAAW,QACXU,YAAa,QACb+B,QAAS,SAAAb,GAAA,MAAKhF,GAAKqG,WAGpBrG,EAAKkD,GAAGC,IAAImD,YAAYtG,EAAKkD,GAAGmD,SAGjCpG,KAAK2B,YAAY2E,QAAQ,SAAU,QAAS,WAC3C/G,EAAEkF,OAAO1E,EAAKkD,GAAGmD,SAGdpG,KAAKmB,SAAWnB,KAAKqB,QAEnBrB,KAAKmB,SACTnB,KAAKqB,OAAOM,YAAY6B,IAAI,OAAQ,WAAA,MAAMzD,GAAK4B,YAAY4E,MAAO,IAGnEvG,KAAK2B,YAAY6B,IAAI,OAAQ,WAAA,MAAMzD,GAAKyG,WAIxCxG,KAAK2B,YAAY8E,IAAI,OAAQ;AAE7BlH,EAAEmH,KAAK1G,KAAKsB,QAAS,cAGjBtB,KAAKiF,YACTjF,KAAK2B,YAAYgF,KAAK,OAAQ,MAAO,WAGrC3G,KAAKsB,QAAQY,iBAAiB,YAAa,SAAAC,GAC1C,GAAIyE,GAAgBnH,EAAEoH,SAAS,WAC9B9G,EAAKwC,QACH,KAECuE,EAAW,SAAA3E,GACVA,EAAI4E,KAAKC,OACZJ,IAIFK,uBAAsB,WACrBlH,EAAK4B,YAAY6B,IAAI,OAAQ,WAC5BzD,EAAKuB,QAAQY,iBAAiB,kBAAmB4E,IAC/C,WACF/G,EAAKuB,QAAQ4F,oBAAoB,kBAAmBJ,UAMxDnH,KAAKuF,MAAMC,IAAI,WAAYnF,OAG5B6F,GAAIA,WACH,MAAO7F,MAAKoF,KAAKS,SAGlBsB,GAAIA,QACH,MAAOnH,MAAKoH,WAGbA,QAAS,SAASC,GACjB,MAAOrH,MAAKoF,KAAKgC,QAAQC,IAG1BC,OAAQ,WAA2B,GAAlBH,GAAkBI,UAAAlI,QAAA,GAAAmI,SAAAD,UAAA,GAAXvH,KAAKmH,KAAMI,UAAA,EAClC,OAAO9H,GAAE6H,OAAOH,IAGjBM,OAAQ,SAASN,GAChB1H,EAAEyF,MAAMC,IAAI,gBAAiBuC,QAAS1H,KAAMmH,KAAAA,IAExCA,IACCnH,KAAK6F,SACR7F,KAAK8F,OACL9F,KAAKoF,KAAKqC,OAAON,GACjBnH,KAAK2F,QAGL3F,KAAKoF,KAAKqC,OAAON,IAKnBnH,KAAKmG,gBAAiB,GAGvBC,MAAO,WACFuB,QAAQ,mDACX3H,KAAK4H,MAAM,MACX5H,KAAKoF,KAAKgB,UAIZT,KAAM,WACL3F,KAAKoF,KAAKO;AAEVpG,EAAEuE,OAAO9D,KAAKsB,QAAS,4CAA6C,SAAAa,GACnE,GAAIA,EAAI0F,OAAO/E,QAAQ,6BAA8B,CACpD,GAAIgF,GAAO3F,EAAI0F,OAAOtG,QAAQ9B,EAAEsB,UAAU+G,KAC1CA,GAAKpH,UAAUgF,OAAO,eAA4B,cAAZvD,EAAI4F,MAG3C,GAAI5F,EAAI0F,OAAO/E,QAAQrD,EAAEsB,UAAU+G,MAAO,CACzC3F,EAAI0F,OAAOnH,UAAU+D,OAAO,mBAE5B,IAAIuD,GAAS7F,EAAI0F,OAAO7E,WAAWzB,QAAQ9B,EAAEsB,UAAU+G,KAEnDE,IACHA,EAAOtH,UAAUgF,OAAO,mBAAgC,cAAZvD,EAAI4F,SAGhD,GAEH/H,KAAKqF,qBAUNA,kBAAmB,SAASI,GAC3B,GAAIU,KAAmBV,CAgBvB,OAdKA,IACJzF,KAAKiI,KAAK,SAAAC,GACT,GAAIA,EAAI/B,eAOP,MANAA,IAAiB,EAEbV,KAAU,IACbyC,EAAI/B,gBAAiB,IAGf,IAKHnG,KAAKmG,eAAiBA,GAI9BL,KAAM,WACL9F,KAAKoF,KAAKU,OACVvG,EAAEmF,OAAO1E,KAAKsB,QAAS,cACvBtB,KAAKmG,gBAAiB,GAQvBK,KAAM,WAAW,GAAA2B,GAAAnI,IAChBA,MAAKoI,WAAa,SAElB,IAAIzD,GAAU3E,KAAKmB,SAAWnB,KAAKqB,MAEnC,OAAOsD,GAAQ0D,MAAMC,KAAK,WAAA,MAAM3D,GAAQ4D,QAAjC5D,SACA,SAAA6D,GAEN,MAAIL,GAAK9G,QAAUsD,IAAYwD,EAAK9G,OAC5B8G,EAAK9G,OAAOgH,MAAMC,KAAK,WAAA,MAAMH,GAAK9G,OAAOkH,QAG1CE,QAAQC,OAAOF,KAEtBF,KAAK,SAAAK,GACDA,GAAgC,UAApBpJ,EAAEwI,KAAKY,KACtBA,EAAWC,KAAKC,MAAMF;AAGvBR,EAAKV,OAAOkB,KAdNhE,SAgBA,SAAA6D,GACFA,IACCA,EAAIM,KAAyB,KAAlBN,EAAIM,IAAIzF,OACtB8E,EAAKV,OAAO,KAIZsB,QAAQC,MAAMR,GACdO,QAAQE,IAAIT,EAAIU,WAIlBZ,KAAK,WACLH,EAAKC,YAAa,EAClB7I,EAAEmH,KAAKyB,EAAK7G,QAAS,gBAIvBsG,MAAO,WAAW,GAAAuB,GAAAnJ,IACZA,MAAKmB,UAIVnB,KAAKoI,WAAa,SAElBpI,KAAKmB,QAAQuC,QACZ4E,KAAK,WAAA,MAAMa,GAAKhI,QAAQiI,QACxBd,KAAK,SAAAe,GACL9J,EAAEmH,KAAKyC,EAAK7H,QAAS,aACpB6F,KAAMkC,EAAKlC,KACXmC,WAAYD,EAAKC,aAGlBH,EAAKI,UAAYC,KAAKC,QARvBzJ,SAUO,SAAAwI,GACFA,IACHO,QAAQC,MAAMR,GACdO,QAAQE,IAAIT,EAAIU,UAGjBZ,KAAK,WACLa,EAAKf,YAAa,MAIpB7F,KAAM,WACLvC,KAAKoF,KAAK7C,OAEVvC,KAAK4H,QAEL5H,KAAKmG,gBAAiB,GAGvBF,OAAQ,WACPjG,KAAKoF,KAAKa,UAGXgC,KAAM,SAASnB,GACd9G,KAAKoF,KAAK6C,KAAKnB,IAGhB4C,MACCtB,WAAY,SAAS3C,GACpBlG,EAAEoK,gBAAgB3J,KAAKsB,QAAS,mBAAoBmE,EAAOA,IAG5DU,eAAgB,SAASV,GACxBzF,KAAKsB,QAAQZ,UAAUgF,OAAO,kBAAmBD,GAE7CzF,KAAKiD,IAAMjD,KAAKiD,GAAGV,OACtBvC,KAAKiD,GAAGV,KAAK2D,UAAYT,EACzBzF,KAAKiD,GAAGgD,OAAOC,UAAYT,IAI7BR,UAAW,SAASQ,GACnBlG,EAAEoK,gBAAgB3J,KAAKiD,GAAGC,IAAK,SAAU,IAAKuC,KAIhDmE,UACC1J,OAEAmC,SAAgD,IAAtCwH,UAAUC,SAASC,QAAQ,OAAc,UAAY;AAE/DC,KAAM,SAASC,GACd,MAAOzK,GAAGC,EAAEsB,UAAUiJ,KAAMC,GAAa5F,UACvC6F,OAAO,SAAApK,GAAA,OAAYA,EAAQkD,WAAWzB,QAAQ9B,EAAEsB,UAAUiJ,QAC1DG,IAAI,SAAArK,GAAA,MAAW,IAAIL,GAAEK,MAGxBoF,MAAO,GAAI3F,GAAE6K,UAIf,WAEA,GAAIC,GAAI5K,EAAEsB,WACTiJ,KAAM,2CACNnI,SAAU,yBACVyI,iBAAkB,SAAAxF,GAAA,MAAA,aAAqBA,EAArB,gBAAyCA,EAAzC,KAClBhD,MAAO,+CACPyI,SAAU,yCACVC,SAAU,yCACV7H,YAAa,kCACbmF,KAAM,WACN7E,GAAI,SACJwH,OAAQ,SAAA3F,GAAA,MAAA,IAAYA,EAAZ,YAA4BA,EAA5B,OAAuCA,GAC/CmF,WACCS,GAAM,SACNC,GAAM,QACNF,OAAU,SACVG,GAAM,KACNC,GAAM,OAIJ7L,EAAMqL,EAAErL,IAAM,SAAA8L,GAAA,MAAYA,GAASC,MAAM,aACzCrI,EAAM2H,EAAE3H,IAAM,SAAAoI,GAAA,MAAY9L,GAAI8L,GAAUX,IAAI,SAAAE,GAAA,MAAA,QAAaA,EAAb,MAAmBW,KAAK,KACpEC,EAAKZ,EAAEY,GAAK,SAACC,EAAWC,GAAZ,MAA0BD,GAAY,KAAOC,GACzDC,EAAMf,EAAEe,IAAM,SAACF,EAAWC,GAC7B,GAAIE,MAAUjM,EAAOJ,EAAImM,EAIzB,OAFAnM,GAAIkM,GAAWlJ,QAAQ,SAAAsJ,GAAA,MAAMD,GAAIlL,KAAJoL,MAAAF,EAAAtM,mBAAYK,EAAK+K,IAAI,SAAAqB;AAAA,MAAMF,GAAKE,QAEtDH,EAAIL,KAAK,OAEbS,EAASpB,EAAEoB,OAAS,SAACP,EAAWC,GAAZ,MAA0BC,GAAIF,EAAWxI,EAAIyI,IAErE5L,GAAEmM,OAAOjM,EAAEsB,WACVyB,UAAWiJ,EAAOpB,EAAExI,SAAUwI,EAAEvI,OAChCd,UAAWyK,EAAOpB,EAAEvI,MAAOuI,EAAExI,UAC7B8J,OAAQV,EAAGZ,EAAEC,iBAAiB,UAAW,mBACzCsB,aAAcR,EAAI,iBAAkB,sBAMrC3C,QAAQvI,KACPX,EAAE8I,QACF9I,EAAEsM,QAAQ5M,MAAMK,MAAQkF,OAAOsH,MAAQzH,SAAS0H,gBAAgBxK,QAAS,oFAF1EkH,SAIO,SAAAD,GAAA,MAAOO,SAAQC,MAAMR,KAC3BF,KAAK,WAAA,MAAM3I,MAAKqK,SAEjBgC,SAASjL,UAAUmJ,OAAS,8BAEzB+B,MAAOA,MAAM1M","file":"mavo.min.js","sourcesContent":["(function ($, $$) {\n\n\"use strict\";\n\nvar _ = self.Mavo = $.Class({\n\tconstructor: function (element) {\n\t\t// Index among other mavos in the page, 1 is first\n\t\tthis.index = _.all.push(this);\n\n\t\t// Assign a unique (for the page) id to this mavo instance\n\t\tthis.id = element.getAttribute(\"data-mavo\") || Mavo.Node.getProperty(element) || element.id || `mavo${this.index}`;\n\t\telement.setAttribute(\"data-mavo\", this.id);\n\n\t\tthis.unhandled = element.classList.contains(\"mv-keep-unhandled\");\n\n\t\tthis.autoEdit = _.has(\"autoedit\", element);\n\n\t\tthis.element = _.is(\"group\", element)? element : $(_.selectors.rootGroup, element);\n\n\t\tif (!this.element) {\n\t\t\telement.setAttribute(\"typeof\", element.getAttribute(\"property\") || \"\");\n\t\t\telement.removeAttribute(\"property\");\n\t\t\tthis.element = element;\n\t\t}\n\n\t\tthis.element.classList.add(\"mv-root\");\n\n\t\tif (this.index == 1) {\n\t\t\tthis.storage = _.urlParam(\"store\");\n\t\t\tthis.source = _.urlParam(\"source\");\n\t\t}\n\n\t\tthis.wrapper = element.closest(\".mv-wrapper\") || element;\n\n\t\tthis.storage = this.storage || _.urlParam(`${this.id}_store`) || element.getAttribute(\"data-store\") || null;\n\t\tthis.source = this.source || _.urlParam(`${this.id}_source`) || element.getAttribute(\"data-source\") || null;\n\n\t\tif (this.storage && !/^\\s*none\\s*$/i.test(this.storage)) {\n\t\t\tthis.storage = _.Backend.create(this.storage, this);\n\t\t}\n\n\t\tif (this.source) {\n\t\t\tthis.source = _.Backend.create(this.source, this);\n\t\t}\n\n\t\tthis.permissions = this.storage ? this.storage.permissions : new Mavo.Permissions();\n\n\t\t// Apply heuristic for collections\n\t\t$$(_.selectors.property + \", \" + _.selectors.group, element).concat([this.element]).forEach(element => {\n\t\t\tif (_.is(\"autoMultiple\", element) && !element.hasAttribute(\"data-multiple\")) {\n\t\t\t\telement.setAttribute(\"data-multiple\", \"\");\n\t\t\t}\n\t\t});\n\n\t\t// Ctrl + S or Cmd + S to save\n\t\tthis.wrapper.addEventListener(\"keydown\", evt => {\n\t\t\tif (evt.keyCode == 83 && evt[_.superKey]) {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.save();\n\t\t\t}\n\t\t});\n\n\t\t// Apply heuristic forgroups\n\t\t$$(_.selectors.primitive, element).forEach(element => {\n\t\t\tvar isGroup = $(`${_.selectors.not(_.selectors.formControl)}, ${_.selectors.property}`, element) && (// Contains other properties or non-form elements and...\n\t\t\t                Mavo.is(\"multiple\", element) || // is a collection...\n\t\t\t                Mavo.Primitive.getValueAttribute(element) === null  // ...or its content is not in an attribute\n\t\t\t\t\t\t) || element.matches(\"template\");\n\n\t\t\tif (isGroup) {\n\t\t\t\telement.setAttribute(\"typeof\", \"\");\n\t\t\t}\n\t\t});\n\n\t\tif (this.wrapper === this.element && _.is(\"multiple\", element)) {\n\t\t\t// Need to create a wrapper\n\t\t\tvar around = this.element;\n\n\t\t\t// Avoid producing invalid HTML\n\t\t\tif (this.element.matches(\"li, option\")) {\n\t\t\t\taround = around.parentNode;\n\t\t\t}\n\t\t\telse if (this.element.matches(\"td, tr, tbody, thead, tfoot\")) {\n\t\t\t\taround = around.closest(\"table\");\n\t\t\t}\n\n\t\t\tthis.wrapper = $.create({ around });\n\t\t}\n\n\t\tthis.wrapper.classList.add(\"mv-wrapper\");\n\n\t\tthis.ui = {\n\t\t\tbar: $(\".mv-bar\", this.wrapper) || $.create({\n\t\t\t\tclassName: \"mv-bar mv-ui\",\n\t\t\t\tstart: this.wrapper\n\t\t\t})\n\t\t};\n\n\t\tthis.ui.status = $(\".status\", this.ui.bar) || $.create(\"span\", {\n\t\t\tclassName: \"status\",\n\t\t\tinside: this.ui.bar\n\t\t});\n\n\t\tif (this.storage) {\n\t\t\t// Reflect backend permissions in global permissions\n\t\t\tthis.authControls = {};\n\n\t\t\tthis.permissions.can(\"login\", () => {\n\t\t\t\t// #login authenticates if only 1 mavo on the page, or if the first.\n\t\t\t\t// Otherwise, we have to generate a slightly more complex hash\n\t\t\t\tthis.loginHash = \"#login\" + (Mavo.all[0] === this? \"\" : \"-\" + this.id);\n\n\t\t\t\tthis.authControls.login = $.create({\n\t\t\t\t\ttag: \"a\",\n\t\t\t\t\thref: this.loginHash,\n\t\t\t\t\ttextContent: \"Login\",\n\t\t\t\t\tclassName: \"login button\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: evt => {\n\t\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\t\tthis.storage.login();\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tafter: $(\".status\", this.ui.bar)\n\t\t\t\t});\n\n\t\t\t\t// We also support a hash to trigger login, in case the user doesn't want visible login UI\n\t\t\t\tvar login;\n\t\t\t\t(login = () => {\n\t\t\t\t\tif (location.hash === this.loginHash) {\n\t\t\t\t\t\t// This just does location.hash = \"\" without getting a pointless # at the end of the URL\n\t\t\t\t\t\thistory.replaceState(null, document.title, new URL(\"\", location) + \"\");\n\t\t\t\t\t\tthis.storage.login();\n\t\t\t\t\t}\n\t\t\t\t})();\n\t\t\t\twindow.addEventListener(\"hashchange.mavo\", login);\n\t\t\t}, () => {\n\t\t\t\t$.remove(this.authControls.login);\n\t\t\t\tthis.wrapper._.unbind(\"hashchange.mavo\");\n\t\t\t});\n\n\t\t\t// Update login status\n\t\t\tthis.wrapper.addEventListener(\"mavo:login.mavo\", evt => {\n\t\t\t\tif (evt.backend == this.storage) { // ignore logins from source backend\n\t\t\t\t\tvar status = $(\".status\", this.ui.bar);\n\t\t\t\t\tstatus.innerHTML = \"\";\n\t\t\t\t\tstatus._.contents([\n\t\t\t\t\t\t\"Logged in to \" + evt.backend.id + \" as \",\n\t\t\t\t\t\t{tag: \"strong\", innerHTML: evt.name},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttextContent: \"Logout\",\n\t\t\t\t\t\t\tclassName: \"logout\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\tclick: e => evt.backend.logout()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}\n\t\t\t\t\t]);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.wrapper.addEventListener(\"mavo:logout.mavo\", evt => {\n\t\t\t\t$(\".status\", this.ui.bar).textContent = \"\";\n\t\t\t});\n\t\t}\n\n\t\t// Is there any control that requires an edit button?\n\t\tthis.needsEdit = false;\n\n\t\t// Build mavo objects\n\t\tMavo.hooks.run(\"init-tree-before\", this);\n\n\t\tthis.root = Mavo.Node.create(this.element, this);\n\n\t\tMavo.hooks.run(\"init-tree-after\", this);\n\n\t\tthis.setUnsavedChanges(false);\n\n\t\tthis.permissions.onchange(({action, value}) => {\n\t\t\tthis.wrapper.classList.toggle(`can-${action}`, !!value);\n\t\t});\n\n\t\tthis.permissions.can([\"edit\", \"add\", \"delete\"], () => {\n\t\t\tthis.ui.edit = $.create(\"button\", {\n\t\t\t\tclassName: \"edit\",\n\t\t\t\ttextContent: \"Edit\",\n\t\t\t\tonclick: e => this.editing? this.done() : this.edit(),\n\t\t\t\tinside: this.ui.bar\n\t\t\t});\n\n\t\t\tif (this.autoEdit) {\n\t\t\t\tthis.wrapper.addEventListener(\"mavo:load\", evt => this.ui.edit.click());\n\t\t\t}\n\t\t}, () => { // cannot\n\t\t\t$.remove(this.ui.edit);\n\n\t\t\tif (this.editing) {\n\t\t\t\tthis.done();\n\t\t\t}\n\t\t});\n\n\t\tif (this.needsEdit) {\n\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\tthis.ui.save = $.create(\"button\", {\n\t\t\t\t\tclassName: \"save\",\n\t\t\t\t\ttextContent: \"Save\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.save(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tthis.wrapper.classList.add(\"save-hovered\");\n\t\t\t\t\t\t\tthis.setUnsavedChanges();\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.wrapper.classList.remove(\"save-hovered\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\n\t\t\t\tthis.ui.revert = $.create(\"button\", {\n\t\t\t\t\tclassName: \"revert\",\n\t\t\t\t\ttextContent: \"Revert\",\n\t\t\t\t\tdisabled: true,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.revert(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tif (!this.unsavedChanges) {\n\t\t\t\t\t\t\t\tthis.wrapper.classList.add(\"revert-hovered\");\n\t\t\t\t\t\t\t\tthis.setUnsavedChanges();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.wrapper.classList.remove(\"revert-hovered\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\t\t\t}, () => {\n\t\t\t\t$.remove([this.ui.save, this.ui.revert]);\n\t\t\t\tthis.ui.save = this.ui.revert = null;\n\t\t\t});\n\t\t}\n\n\t\tthis.permissions.can(\"delete\", () => {\n\t\t\tthis.ui.clear = $.create(\"button\", {\n\t\t\t\tclassName: \"clear\",\n\t\t\t\ttextContent: \"Clear\",\n\t\t\t\tonclick: e => this.clear()\n\t\t\t});\n\n\t\t\tthis.ui.bar.appendChild(this.ui.clear);\n\t\t});\n\n\t\tthis.permissions.cannot([\"delete\", \"edit\"], () => {\n\t\t\t$.remove(this.ui.clear);\n\t\t});\n\n\t\tif (this.storage || this.source) {\n\t\t\t// Fetch existing data\n\t\t\tif (!this.storage) {\n\t\t\t\tthis.source.permissions.can(\"read\", () => this.permissions.read = true);\n\t\t\t}\n\n\t\t\tthis.permissions.can(\"read\", () => this.load());\n\t\t}\n\t\telse {\n\t\t\t// No storage\n\t\t\tthis.permissions.on([\"read\", \"edit\"]);\n\n\t\t\t$.fire(this.wrapper, \"mavo:load\");\n\t\t}\n\n\t\tif (!this.needsEdit) {\n\t\t\tthis.permissions.off([\"edit\", \"add\", \"delete\"]);\n\n\t\t\t// If there's no edit mode, we must save immediately when properties change\n\t\t\tthis.wrapper.addEventListener(\"mavo:load\", evt => {\n\t\t\t\tvar debouncedSave = _.debounce(() => {\n\t\t\t\t\tthis.save();\n\t\t\t\t}, 1000);\n\n\t\t\t\tvar callback = evt => {\n\t\t\t\t\tif (evt.node.saved) {\n\t\t\t\t\t\tdebouncedSave();\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\t\t\tthis.wrapper.addEventListener(\"mavo:datachange\", callback);\n\t\t\t\t\t}, () => {\n\t\t\t\t\t\tthis.wrapper.removeEventListener(\"mavo:datachange\", callback);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tMavo.hooks.run(\"init-end\", this);\n\t},\n\n\tget editing() {\n\t\treturn this.root.editing;\n\t},\n\n\tget data() {\n\t\treturn this.getData();\n\t},\n\n\tgetData: function(o) {\n\t\treturn this.root.getData(o);\n\t},\n\n\ttoJSON: function(data = this.data) {\n\t\treturn _.toJSON(data);\n\t},\n\n\trender: function(data) {\n\t\t_.hooks.run(\"render-start\", {context: this, data});\n\n\t\tif (data) {\n\t\t\tif (this.editing) { // TODO this logic should go to Node\n\t\t\t\tthis.done();\n\t\t\t\tthis.root.render(data);\n\t\t\t\tthis.edit();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.root.render(data);\n\t\t\t}\n\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tclear: function() {\n\t\tif (confirm(\"This will delete all your data. Are you sure?\")) {\n\t\t\tthis.store(null);\n\t\t\tthis.root.clear();\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.root.edit();\n\n\t\t$.events(this.wrapper, \"mouseenter.mavo:edit mouseleave.mavo:edit\", evt => {\n\t\t\tif (evt.target.matches(\".mv-item-controls .delete\")) {\n\t\t\t\tvar item = evt.target.closest(_.selectors.item);\n\t\t\t\titem.classList.toggle(\"delete-hover\", evt.type == \"mouseenter\");\n\t\t\t}\n\n\t\t\tif (evt.target.matches(_.selectors.item)) {\n\t\t\t\tevt.target.classList.remove(\"has-hovered-item\");\n\n\t\t\t\tvar parent = evt.target.parentNode.closest(_.selectors.item);\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tparent.classList.toggle(\"has-hovered-item\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\t\t}, true);\n\n\t\tthis.setUnsavedChanges();\n\t},\n\n\t/**\n\t * Set this mavo instance’s unsavedChanges flag.\n\t * @param {Boolean} [value]\n\t *        If true, just sets the flag to true, no traversal.\n\t *        If false, sets the flag of the Mavo instance and every tree node to false\n\t *        If not provided, traverses the tree and recalculates the flag value.\n\t */\n\tsetUnsavedChanges: function(value) {\n\t\tvar unsavedChanges = !!value;\n\n\t\tif (!value) {\n\t\t\tthis.walk(obj => {\n\t\t\t\tif (obj.unsavedChanges) {\n\t\t\t\t\tunsavedChanges = true;\n\n\t\t\t\t\tif (value === false) {\n\t\t\t\t\t\tobj.unsavedChanges = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this.unsavedChanges = unsavedChanges;\n\t},\n\n\t// Conclude editing\n\tdone: function() {\n\t\tthis.root.done();\n\t\t$.unbind(this.wrapper, \".mavo:edit\");\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t/**\n\t * load - Fetch data from source and render it.\n\t *\n\t * @return {Promise}  A promise that resolves when the data is loaded.\n\t */\n\tload: function() {\n\t\tthis.inProgress = \"Loading\";\n\n\t\tvar backend = this.storage || this.source;\n\n\t\treturn backend.ready.then(() => backend.get())\n\t\t.catch(err => {\n\t\t\t// Try again with source\n\t\t\tif (this.source && backend !== this.source) {\n\t\t\t\treturn this.source.ready.then(() => this.source.get());\n\t\t\t}\n\n\t\t\treturn Promise.reject(err);\n\t\t})\n\t\t.then(response => {\n\t\t\tif (response && $.type(response) == \"string\") {\n\t\t\t\tresponse = JSON.parse(response);\n\t\t\t}\n\n\t\t\tthis.render(response);\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tif (err.xhr && err.xhr.status == 404) {\n\t\t\t\t\tthis.render(\"\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// TODO display error to user\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t\tconsole.log(err.stack);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t\t$.fire(this.wrapper, \"mavo:load\");\n\t\t});\n\t},\n\n\tstore: function() {\n\t\tif (!this.storage) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.inProgress = \"Saving\";\n\n\t\tthis.storage.login()\n\t\t.then(() => this.storage.put())\n\t\t.then(file => {\n\t\t\t$.fire(this.wrapper, \"mavo:save\", {\n\t\t\t\tdata: file.data,\n\t\t\t\tdataString: file.dataString\n\t\t\t});\n\n\t\t\tthis.lastSaved = Date.now();\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tconsole.error(err);\n\t\t\t\tconsole.log(err.stack);\n\t\t\t}\n\t\t})\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t});\n\t},\n\n\tsave: function() {\n\t\tthis.root.save();\n\n\t\tthis.store();\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\trevert: function() {\n\t\tthis.root.revert();\n\t},\n\n\twalk: function(callback) {\n\t\tthis.root.walk(callback);\n\t},\n\n\tlive: {\n\t\tinProgress: function(value) {\n\t\t\t$.toggleAttribute(this.wrapper, \"data-mv-progress\", value, value);\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tthis.wrapper.classList.toggle(\"unsaved-changes\", value);\n\n\t\t\tif (this.ui && this.ui.save) {\n\t\t\t\tthis.ui.save.disabled = !value;\n\t\t\t\tthis.ui.revert.disabled = !value;\n\t\t\t}\n\t\t},\n\n\t\tneedsEdit: function(value) {\n\t\t\t$.toggleAttribute(this.ui.bar, \"hidden\", \"\", !value);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: [],\n\n\t\tsuperKey: navigator.platform.indexOf(\"Mac\") === 0? \"metaKey\" : \"ctrlKey\",\n\n\t\tinit: function(container) {\n\t\t\treturn $$(_.selectors.init, container || document)\n\t\t\t\t.filter(element => !element.parentNode.closest(_.selectors.init))\n\t\t\t\t.map(element => new _(element));\n\t\t},\n\n\t\thooks: new $.Hooks()\n\t}\n});\n\n{\n\nlet s = _.selectors = {\n\tinit: \".mavo, [mavo], [data-mavo], [data-store]\",\n\tproperty: \"[property], [itemprop]\",\n\tspecificProperty: name => `[property=${name}], [itemprop=${name}]`,\n\tgroup: \"[typeof], [itemscope], [itemtype], .mv-group\",\n\tmultiple: \"[multiple], [data-multiple], .multiple\",\n\trequired: \"[required], [data-required], .required\",\n\tformControl: \"input, select, option, textarea\",\n\titem: \".mv-item\",\n\tui: \".mv-ui\",\n\toption: name => `[${name}], [data-${name}], .${name}`,\n\tcontainer: {\n\t\t\"li\": \"ul, ol\",\n\t\t\"tr\": \"table\",\n\t\t\"option\": \"select\",\n\t\t\"dt\": \"dl\",\n\t\t\"dd\": \"dl\"\n\t}\n};\n\nlet arr = s.arr = selector => selector.split(/\\s*,\\s*/g);\nlet not = s.not = selector => arr(selector).map(s => `:not(${s})`).join(\"\");\nlet or = s.or = (selector1, selector2) => selector1 + \", \" + selector2;\nlet and = s.and = (selector1, selector2) => {\n\tvar ret = [], arr2 = arr(selector2);\n\n\tarr(selector1).forEach(s1 => ret.push(...arr2.map(s2 => s1 + s2)));\n\n\treturn ret.join(\", \");\n};\nlet andNot = s.andNot = (selector1, selector2) => and(selector1, not(selector2));\n\n$.extend(_.selectors, {\n\tprimitive: andNot(s.property, s.group),\n\trootGroup: andNot(s.group, s.property),\n\toutput: or(s.specificProperty(\"output\"), \".output, .value\"),\n\tautoMultiple: and(\"li, tr, option\", \":only-of-type\")\n});\n\n}\n\n// Init mavo\nPromise.all([\n\t$.ready(),\n\t$.include(Array.from && window.Intl && document.documentElement.closest, \"https://cdn.polyfill.io/v2/polyfill.min.js?features=blissfuljs,Intl.~locale.en\")\n])\n.catch(err => console.error(err))\n.then(() => Mavo.init());\n\nStretchy.selectors.filter = \".mv-editor:not([property])\";\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}