{"version":3,"sources":["mavo.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","$$","_","self","Mavo","Class","constructor","element","_this","this","treeBuilt","defer","dataMv","attributes","map","attribute","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_step","_iterator","join","concat","Symbol","iterator","next","done","_element","value","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","getAttribute","setAttribute","err","index","all","push","id","unhandled","classList","contains","autoEdit","storage","urlParam","source","trim","Backend","create","permissions","Permissions","addEventListener","evt","keyCode","superKey","preventDefault","save","selectors","primitive","forEach","hasChildren","not","formControl","property","defaults","Primitive","getDefaults","isCollection","is","getValueAttribute","ui","bar","className","start","status","inside","authControls","can","loginHash","login","tag","href","textContent","events","click","after","location","hash","history","replaceState","document","title","URL","window","remove","unbind","backend","innerHTML","contents","name","e","logout","needsEdit","hooks","run","root","Group","resolve","setUnsavedChanges","onchange","_ref","action","toggle","edit","onclick","editing","mouseenter focus","add","mouseleave blur","revert","disabled","unsavedChanges","clear","appendChild","cannot","read","load","on","fire","off","debouncedSave","debounce","callback","node","saved","requestAnimationFrame","removeEventListener","data","getData","o","toJSON","arguments","render","context","confirm","store","target","matches","item","closest","type","parent","parentNode","walk","obj","_this2","inProgress","ready","then","get","Promise","reject","response","JSON","parse","xhr","console","error","log","stack","_this3","put","file","dataString","lastSaved","Date","now","live","toggleAttribute","static","navigator","platform","indexOf","init","container","filter","Hooks","s","specificProperty","group","multiple","li","tr","option","dt","dd","selector","split","or","selector1","selector2","and","ret","s1","apply","s2","andNot","extend","rootGroup","output","include","Intl","documentElement","Stretchy","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function ($, $$) {\n\n\"use strict\";\n\nvar _ = self.Mavo = $.Class({\n\tconstructor: function (element) {\n\t\tthis.treeBuilt = Mavo.defer();\n\n\t\tthis.element = element;\n\n\t\t// Convert any data-mv-* attributes to mv-*\n\t\tvar dataMv = _.attributes.map(attribute => `[data-${attribute}]`);\n\t\tfor (let element of $$(dataMv.join(\", \"), this.element).concat(this.element)) {\n\t\t\tfor (let attribute of _.attributes) {\n\t\t\t\tlet value = element.getAttribute(\"data-\" + attribute);\n\n\t\t\t\tif (value !== null) {\n\t\t\t\t\telement.setAttribute(attribute, value);\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\n\t\t// Index among other mavos in the page, 1 is first\n\t\tthis.index = _.all.push(this);\n\n\t\t// Assign a unique (for the page) id to this mavo instance\n\t\tthis.id = Mavo.getAttribute(this.element, \"mv-app\", \"id\") || `mavo${this.index}`;\n\t\tthis.element.setAttribute(\"mv-app\", this.id);\n\n\t\tthis.unhandled = this.element.classList.contains(\"mv-keep-unhandled\");\n\t\tthis.autoEdit = this.element.classList.contains(\"mv-autoedit\");\n\n\t\tif (this.index == 1) {\n\t\t\tthis.storage = _.urlParam(\"store\");\n\t\t\tthis.source = _.urlParam(\"source\");\n\t\t}\n\n\t\tthis.storage = this.storage || _.urlParam(`${this.id}_store`) || this.element.getAttribute(\"mv-storage\") || null;\n\t\tthis.source = this.source || _.urlParam(`${this.id}_source`) || this.element.getAttribute(\"mv-init\") || null;\n\n\t\tif (this.storage) {\n\t\t\tthis.storage = this.storage.trim();\n\n\t\t\tthis.storage = this.storage == \"none\"? null : _.Backend.create(this.storage, this);\n\t\t}\n\n\t\tif (this.source) {\n\t\t\tthis.source = _.Backend.create(this.source, this);\n\t\t}\n\n\t\tthis.permissions = this.storage ? this.storage.permissions : new Mavo.Permissions();\n\n\t\t// Ctrl + S or Cmd + S to save\n\t\tthis.element.addEventListener(\"keydown\", evt => {\n\t\t\tif (evt.keyCode == 83 && evt[_.superKey]) {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.save();\n\t\t\t}\n\t\t});\n\n\t\tthis.element.setAttribute(\"typeof\", \"\");\n\n\t\t// Apply heuristic for groups\n\t\t$$(_.selectors.primitive, element).forEach(element => {\n\t\t\tvar hasChildren = $(`${_.selectors.not(_.selectors.formControl)}, ${_.selectors.property}`, element);\n\n\t\t\tif (hasChildren) {\n\t\t\t\tvar defaults = Mavo.Primitive.getDefaults(element);\n\t\t\t\tvar isCollection = Mavo.is(\"multiple\", element);\n\n\t\t\t\tif (isCollection || !Mavo.Primitive.getValueAttribute(element, defaults) && !defaults.hasChildren) {\n\t\t\t\t\telement.setAttribute(\"typeof\", \"\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.ui = {\n\t\t\tbar: $(\".mv-bar\", this.element) || $.create({\n\t\t\t\tclassName: \"mv-bar mv-ui\",\n\t\t\t\tstart: this.element\n\t\t\t})\n\t\t};\n\n\t\tthis.ui.status = $(\".mv-status\", this.ui.bar) || $.create(\"span\", {\n\t\t\tclassName: \"mv-status\",\n\t\t\tinside: this.ui.bar\n\t\t});\n\n\t\tif (this.storage) {\n\t\t\t// Reflect backend permissions in global permissions\n\t\t\tthis.authControls = {};\n\n\t\t\tthis.permissions.can(\"login\", () => {\n\t\t\t\t// #login authenticates if only 1 mavo on the page, or if the first.\n\t\t\t\t// Otherwise, we have to generate a slightly more complex hash\n\t\t\t\tthis.loginHash = \"#login\" + (Mavo.all[0] === this? \"\" : \"-\" + this.id);\n\n\t\t\t\tthis.authControls.login = $.create({\n\t\t\t\t\ttag: \"a\",\n\t\t\t\t\thref: this.loginHash,\n\t\t\t\t\ttextContent: \"Login\",\n\t\t\t\t\tclassName: \"mv-login mv-button\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: evt => {\n\t\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\t\tthis.storage.login();\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tafter: $(\".mv-status\", this.ui.bar)\n\t\t\t\t});\n\n\t\t\t\t// We also support a hash to trigger login, in case the user doesn't want visible login UI\n\t\t\t\tvar login;\n\t\t\t\t(login = () => {\n\t\t\t\t\tif (location.hash === this.loginHash) {\n\t\t\t\t\t\t// This just does location.hash = \"\" without getting a pointless # at the end of the URL\n\t\t\t\t\t\thistory.replaceState(null, document.title, new URL(\"\", location) + \"\");\n\t\t\t\t\t\tthis.storage.login();\n\t\t\t\t\t}\n\t\t\t\t})();\n\t\t\t\twindow.addEventListener(\"hashchange.mavo\", login);\n\t\t\t}, () => {\n\t\t\t\t$.remove(this.authControls.login);\n\t\t\t\tthis.element._.unbind(\"hashchange.mavo\");\n\t\t\t});\n\n\t\t\t// Update login status\n\t\t\tthis.element.addEventListener(\"mavo:login.mavo\", evt => {\n\t\t\t\tif (evt.backend == this.storage) { // ignore logins from source backend\n\t\t\t\t\tvar status = $(\".mv-status\", this.ui.bar);\n\t\t\t\t\tstatus.innerHTML = \"\";\n\t\t\t\t\tstatus._.contents([\n\t\t\t\t\t\t\"Logged in to \" + evt.backend.id + \" as \",\n\t\t\t\t\t\t{tag: \"strong\", innerHTML: evt.name},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttextContent: \"Logout\",\n\t\t\t\t\t\t\tclassName: \"mv-logout\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\tclick: e => evt.backend.logout()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}\n\t\t\t\t\t]);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.element.addEventListener(\"mavo:logout.mavo\", evt => {\n\t\t\t\t$(\".mv-status\", this.ui.bar).textContent = \"\";\n\t\t\t});\n\t\t}\n\n\t\t// Is there any control that requires an edit button?\n\t\tthis.needsEdit = false;\n\n\t\t// Build mavo objects\n\t\tMavo.hooks.run(\"init-tree-before\", this);\n\n\t\tthis.root = new Mavo.Group(this.element, this);\n\t\tthis.treeBuilt.resolve();\n\n\t\tMavo.hooks.run(\"init-tree-after\", this);\n\n\t\tthis.setUnsavedChanges(false);\n\n\t\tthis.permissions.onchange(({action, value}) => {\n\t\t\tthis.element.classList.toggle(`mv-can-${action}`, !!value);\n\t\t});\n\n\t\tthis.permissions.can([\"edit\", \"add\", \"delete\"], () => {\n\t\t\tthis.ui.edit = $.create(\"button\", {\n\t\t\t\tclassName: \"mv-edit\",\n\t\t\t\ttextContent: \"Edit\",\n\t\t\t\tonclick: e => this.editing? this.done() : this.edit(),\n\t\t\t\tinside: this.ui.bar\n\t\t\t});\n\n\t\t\tif (this.autoEdit) {\n\t\t\t\tthis.element.addEventListener(\"mavo:load\", evt => this.ui.edit.click());\n\t\t\t}\n\t\t}, () => { // cannot\n\t\t\t$.remove(this.ui.edit);\n\n\t\t\tif (this.editing) {\n\t\t\t\tthis.done();\n\t\t\t}\n\t\t});\n\n\t\tif (this.needsEdit) {\n\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\tthis.ui.save = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-save\",\n\t\t\t\t\ttextContent: \"Save\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.save(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tthis.element.classList.add(\"mv-save-hovered\");\n\t\t\t\t\t\t\tthis.setUnsavedChanges();\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.element.classList.remove(\"mv-save-hovered\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\n\t\t\t\tthis.ui.revert = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-revert\",\n\t\t\t\t\ttextContent: \"Revert\",\n\t\t\t\t\tdisabled: true,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.revert(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tif (!this.unsavedChanges) {\n\t\t\t\t\t\t\t\tthis.element.classList.add(\"mv-revert-hovered\");\n\t\t\t\t\t\t\t\tthis.setUnsavedChanges();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.element.classList.remove(\"mv-revert-hovered\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\t\t\t}, () => {\n\t\t\t\t$.remove([this.ui.save, this.ui.revert]);\n\t\t\t\tthis.ui.save = this.ui.revert = null;\n\t\t\t});\n\t\t}\n\n\t\tthis.permissions.can(\"delete\", () => {\n\t\t\tthis.ui.clear = $.create(\"button\", {\n\t\t\t\tclassName: \"mv-clear\",\n\t\t\t\ttextContent: \"Clear\",\n\t\t\t\tonclick: e => this.clear()\n\t\t\t});\n\n\t\t\tthis.ui.bar.appendChild(this.ui.clear);\n\t\t});\n\n\t\tthis.permissions.cannot([\"delete\", \"edit\"], () => {\n\t\t\t$.remove(this.ui.clear);\n\t\t});\n\n\t\tif (this.storage || this.source) {\n\t\t\t// Fetch existing data\n\t\t\tif (!this.storage) {\n\t\t\t\tthis.source.permissions.can(\"read\", () => this.permissions.read = true);\n\t\t\t}\n\n\t\t\tthis.permissions.can(\"read\", () => this.load());\n\t\t}\n\t\telse {\n\t\t\t// No storage\n\t\t\tthis.permissions.on([\"read\", \"edit\"]);\n\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t}\n\n\t\tif (!this.needsEdit) {\n\t\t\tthis.permissions.off([\"edit\", \"add\", \"delete\"]);\n\n\t\t\t// If there's no edit mode, we must save immediately when properties change\n\t\t\tthis.element.addEventListener(\"mavo:load\", evt => {\n\t\t\t\tvar debouncedSave = _.debounce(() => {\n\t\t\t\t\tthis.save();\n\t\t\t\t}, 1000);\n\n\t\t\t\tvar callback = evt => {\n\t\t\t\t\tif (evt.node.saved) {\n\t\t\t\t\t\tdebouncedSave();\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\t\t\tthis.element.addEventListener(\"mavo:datachange\", callback);\n\t\t\t\t\t}, () => {\n\t\t\t\t\t\tthis.element.removeEventListener(\"mavo:datachange\", callback);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tMavo.hooks.run(\"init-end\", this);\n\t},\n\n\tget editing() {\n\t\treturn this.root.editing;\n\t},\n\n\tget data() {\n\t\treturn this.getData();\n\t},\n\n\tgetData: function(o) {\n\t\treturn this.root.getData(o);\n\t},\n\n\ttoJSON: function(data = this.data) {\n\t\treturn _.toJSON(data);\n\t},\n\n\trender: function(data) {\n\t\t_.hooks.run(\"render-start\", {context: this, data});\n\n\t\tif (data) {\n\t\t\tif (this.editing) { // TODO this logic should go to Node\n\t\t\t\tthis.done();\n\t\t\t\tthis.root.render(data);\n\t\t\t\tthis.edit();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.root.render(data);\n\t\t\t}\n\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tclear: function() {\n\t\tif (confirm(\"This will delete all your data. Are you sure?\")) {\n\t\t\tthis.store(null);\n\t\t\tthis.root.clear();\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.root.edit();\n\n\t\t$.events(this.element, \"mouseenter.mavo:edit mouseleave.mavo:edit\", evt => {\n\t\t\tif (evt.target.matches(\".mv-item-controls .mv-delete\")) {\n\t\t\t\tvar item = evt.target.closest(_.selectors.item);\n\t\t\t\titem.classList.toggle(\"mv-delete-hover\", evt.type == \"mouseenter\");\n\t\t\t}\n\n\t\t\tif (evt.target.matches(_.selectors.item)) {\n\t\t\t\tevt.target.classList.remove(\"mv-has-hovered-item\");\n\n\t\t\t\tvar parent = evt.target.parentNode.closest(_.selectors.item);\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tparent.classList.toggle(\"mv-has-hovered-item\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\t\t}, true);\n\n\t\tthis.setUnsavedChanges();\n\t},\n\n\t/**\n\t * Set this mavo instance’s unsavedChanges flag.\n\t * @param {Boolean} [value]\n\t *        If true, just sets the flag to true, no traversal.\n\t *        If false, sets the flag of the Mavo instance and every tree node to false\n\t *        If not provided, traverses the tree and recalculates the flag value.\n\t */\n\tsetUnsavedChanges: function(value) {\n\t\tvar unsavedChanges = !!value;\n\n\t\tif (!value) {\n\t\t\tthis.walk(obj => {\n\t\t\t\tif (obj.unsavedChanges) {\n\t\t\t\t\tunsavedChanges = true;\n\n\t\t\t\t\tif (value === false) {\n\t\t\t\t\t\tobj.unsavedChanges = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this.unsavedChanges = unsavedChanges;\n\t},\n\n\t// Conclude editing\n\tdone: function() {\n\t\tthis.root.done();\n\t\t$.unbind(this.element, \".mavo:edit\");\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t/**\n\t * load - Fetch data from source and render it.\n\t *\n\t * @return {Promise}  A promise that resolves when the data is loaded.\n\t */\n\tload: function() {\n\t\tthis.inProgress = \"Loading\";\n\n\t\tvar backend = this.storage || this.source;\n\n\t\treturn backend.ready.then(() => backend.get())\n\t\t.catch(err => {\n\t\t\t// Try again with source\n\t\t\tif (this.source && backend !== this.source) {\n\t\t\t\treturn this.source.ready.then(() => this.source.get());\n\t\t\t}\n\n\t\t\treturn Promise.reject(err);\n\t\t})\n\t\t.then(response => {\n\t\t\tif (response && $.type(response) == \"string\") {\n\t\t\t\tresponse = JSON.parse(response);\n\t\t\t}\n\n\t\t\tthis.render(response);\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tif (err.xhr && err.xhr.status == 404) {\n\t\t\t\t\tthis.render(\"\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// TODO display error to user\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t\tconsole.log(err.stack);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t});\n\t},\n\n\tstore: function() {\n\t\tif (!this.storage) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.inProgress = \"Saving\";\n\n\t\tthis.storage.login()\n\t\t.then(() => this.storage.put())\n\t\t.then(file => {\n\t\t\t$.fire(this.element, \"mavo:save\", {\n\t\t\t\tdata: file.data,\n\t\t\t\tdataString: file.dataString\n\t\t\t});\n\n\t\t\tthis.lastSaved = Date.now();\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tconsole.error(err);\n\t\t\t\tconsole.log(err.stack);\n\t\t\t}\n\t\t})\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t});\n\t},\n\n\tsave: function() {\n\t\tthis.root.save();\n\n\t\tthis.store();\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\trevert: function() {\n\t\tthis.root.revert();\n\t},\n\n\twalk: function(callback) {\n\t\tthis.root.walk(callback);\n\t},\n\n\tlive: {\n\t\tinProgress: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"mv-progress\", value, value);\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tthis.element.classList.toggle(\"mv-unsaved-changes\", value);\n\n\t\t\tif (this.ui && this.ui.save) {\n\t\t\t\tthis.ui.save.disabled = !value;\n\t\t\t\tthis.ui.revert.disabled = !value;\n\t\t\t}\n\t\t},\n\n\t\tneedsEdit: function(value) {\n\t\t\t$.toggleAttribute(this.ui.bar, \"hidden\", \"\", !value);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: [],\n\n\t\tsuperKey: navigator.platform.indexOf(\"Mac\") === 0? \"metaKey\" : \"ctrlKey\",\n\n\t\tinit: function(container) {\n\t\t\treturn $$(_.selectors.init, container || document)\n\t\t\t\t.filter(element => !element.parentNode.closest(_.selectors.init))\n\t\t\t\t.map(element => new _(element));\n\t\t},\n\n\t\thooks: new $.Hooks(),\n\n\t\tattributes: [\n\t\t\t\"mv-app\", \"mv-storage\", \"mv-init\", \"mv-attribute\",\n\t\t\t\"mv-default\", \"mv-mode\", \"mv-edit\", \"mv-permisssions\"\n\t\t]\n\t}\n});\n\n{\n\nlet s = _.selectors = {\n\tinit: \".mv-app, [mv-app], [data-mv-app], [mv-storage], [data-mv-storage]\",\n\tproperty: \"[property], [itemprop]\",\n\tspecificProperty: name => `[property=${name}], [itemprop=${name}]`,\n\tgroup: \"[typeof], [itemscope], [itemtype], .mv-group\",\n\tmultiple: \"[mv-multiple], .mv-multiple\",\n\tformControl: \"input, select, option, textarea\",\n\titem: \".mv-item\",\n\tui: \".mv-ui\",\n\tcontainer: {\n\t\t\"li\": \"ul, ol\",\n\t\t\"tr\": \"table\",\n\t\t\"option\": \"select\",\n\t\t\"dt\": \"dl\",\n\t\t\"dd\": \"dl\"\n\t}\n};\n\nlet arr = s.arr = selector => selector.split(/\\s*,\\s*/g);\nlet not = s.not = selector => arr(selector).map(s => `:not(${s})`).join(\"\");\nlet or = s.or = (selector1, selector2) => selector1 + \", \" + selector2;\nlet and = s.and = (selector1, selector2) => {\n\tvar ret = [], arr2 = arr(selector2);\n\n\tarr(selector1).forEach(s1 => ret.push(...arr2.map(s2 => s1 + s2)));\n\n\treturn ret.join(\", \");\n};\nlet andNot = s.andNot = (selector1, selector2) => and(selector1, not(selector2));\n\n$.extend(_.selectors, {\n\tprimitive: andNot(s.property, s.group),\n\trootGroup: andNot(s.group, s.property),\n\toutput: or(s.specificProperty(\"output\"), \".mv-output, .mv-value\")\n});\n\n}\n\n// Init mavo\nPromise.all([\n\t$.ready(),\n\t$.include(Array.from && window.Intl && document.documentElement.closest, \"https://cdn.polyfill.io/v2/polyfill.min.js?features=blissfuljs,Intl.~locale.en\")\n])\n.catch(err => console.error(err))\n.then(() => Mavo.init());\n\nStretchy.selectors.filter = \".mv-editor:not([property])\";\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}