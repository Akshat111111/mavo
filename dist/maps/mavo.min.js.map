{"version":3,"sources":["mavo.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","$$","_","self","Mavo","Class","constructor","element","_this","this","index","all","push","id","getAttribute","Node","getProperty","unhandled","classList","contains","store","urlParam","source","autoEdit","has","is","selectors","rootScope","setAttribute","removeAttribute","add","property","scope","concat","forEach","hasAttribute","wrapper","closest","addEventListener","evt","keyCode","superKey","preventDefault","save","primitive","isScope","not","formControl","Primitive","getValueAttribute","matches","around","parentNode","create","ui","bar","className","start","status","inside","needsEdit","permissions","Permissions","hooks","run","root","setUnsavedChanges","observe","p","floating","editing","login","edit","unsavedChanges","toggle","onchange","_ref","action","value","can","textContent","onclick","e","done","requestAnimationFrame","click","remove","events","mouseenter focus","mouseleave blur","revert","disabled","clear","appendChild","cannot","storage","Storage","load","on","fire","off","data","getData","o","toJSON","arguments","undefined","render","context","confirm","target","item","type","parent","walk","obj","unbind","callback","live","set","static","navigator","platform","indexOf","init","container","document","map","Hooks","s","specificProperty","name","multiple","required","computed","option","li","tr","dt","dd","documentFragment","selector","split","join","or","selector1","selector2","and","ret","s1","apply","s2","andNot","extend","output","autoMultiple","Promise","ready","include","window","Intl","documentElement","err","console","error","then","Stretchy","filter","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function ($, $$) {\n\n\"use strict\";\n\nvar _ = self.Mavo = $.Class({\n\tconstructor: function (element) {\n\t\t// Index among other mavos in the page, 1 is first\n\t\tthis.index = _.all.push(this);\n\n\t\t// Assign a unique (for the page) id to this mavo instance\n\t\tthis.id = element.getAttribute(\"data-mavo\") || Mavo.Node.getProperty(element) || element.id || `mavo${this.index}`;\n\n\t\tthis.unhandled = element.classList.contains(\"mv-keep-unhandled\");\n\n\t\tif (this.index == 1) {\n\t\t\tthis.store = _.urlParam(\"store\");\n\t\t\tthis.source = _.urlParam(\"source\");\n\t\t}\n\n\t\tthis.store = this.store || _.urlParam(`${this.id}_store`) || element.getAttribute(\"data-store\") || null;\n\t\tthis.source = this.source || _.urlParam(`${this.id}_source`) || element.getAttribute(\"data-source\") || null;\n\n\t\tthis.autoEdit = _.has(\"autoedit\", element);\n\n\t\tthis.element = _.is(\"scope\", element)? element : $(_.selectors.rootScope, element);\n\n\t\tif (!this.element) {\n\t\t\telement.setAttribute(\"typeof\", element.getAttribute(\"property\") || \"\");\n\t\t\telement.removeAttribute(\"property\");\n\t\t\tthis.element = element;\n\t\t}\n\n\t\tthis.element.classList.add(\"mv-root\");\n\n\t\t// Apply heuristic for collections\n\t\t$$(_.selectors.property + \", \" + _.selectors.scope, element).concat([this.element]).forEach(element => {\n\t\t\tif (_.is(\"autoMultiple\", element) && !element.hasAttribute(\"data-multiple\")) {\n\t\t\t\telement.setAttribute(\"data-multiple\", \"\");\n\t\t\t}\n\t\t});\n\n\t\tthis.wrapper = element.closest(\".mv-wrapper\") || element;\n\n\t\t// Ctrl + S or Cmd + S to save\n\t\tthis.wrapper.addEventListener(\"keydown\", evt => {\n\t\t\tif (evt.keyCode == 83 && evt[_.superKey]) {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.save();\n\t\t\t}\n\t\t});\n\n\t\t// Apply heuristic for scopes\n\t\t$$(_.selectors.primitive, element).forEach(element => {\n\t\t\tvar isScope = $(`${_.selectors.not(_.selectors.formControl)}, ${_.selectors.property}`, element) && (// Contains other properties or non-form elements and...\n\t\t\t                Mavo.is(\"multiple\", element) || // is a collection...\n\t\t\t                Mavo.Primitive.getValueAttribute(element) === null  // ...or its content is not in an attribute\n\t\t\t\t\t\t) || element.matches(\"template\");\n\n\t\t\tif (isScope) {\n\t\t\t\telement.setAttribute(\"typeof\", \"\");\n\t\t\t}\n\t\t});\n\n\t\tif (this.wrapper === this.element && _.is(\"multiple\", element)) {\n\t\t\t// Need to create a wrapper\n\t\t\tvar around = this.element;\n\n\t\t\t// Avoid producing invalid HTML\n\t\t\tif (this.element.matches(\"li, option\")) {\n\t\t\t\taround = around.parentNode;\n\t\t\t}\n\t\t\telse if (this.element.matches(\"td, tr, tbody, thead, tfoot\")) {\n\t\t\t\taround = around.closest(\"table\");\n\t\t\t}\n\n\t\t\tthis.wrapper = $.create({ around });\n\t\t}\n\n\t\tthis.wrapper.classList.add(\"mv-wrapper\");\n\n\t\tthis.ui = {\n\t\t\tbar: $(\".mv-bar\", this.wrapper) || $.create({\n\t\t\t\tclassName: \"mv-bar mv-ui\",\n\t\t\t\tstart: this.wrapper\n\t\t\t})\n\t\t};\n\n\t\tthis.ui.status = $(\".status\", this.ui.bar) || $.create(\"span\", {\n\t\t\tclassName: \"status\",\n\t\t\tinside: this.ui.bar\n\t\t});\n\n\t\t// Is there any control that requires an edit button?\n\t\tthis.needsEdit = false;\n\n\t\tthis.permissions = new Mavo.Permissions(null, this);\n\n\t\t// Build mavo objects\n\t\tMavo.hooks.run(\"init-tree-before\", this);\n\n\t\tthis.root = Mavo.Node.create(this.element, this);\n\n\t\tMavo.hooks.run(\"init-tree-after\", this);\n\n\t\tthis.setUnsavedChanges(false);\n\n\t\t_.observe(this.wrapper, \"class\", () => {\n\t\t\tvar p = this.permissions;\n\t\t\tvar floating = !this.editing && (p.login || p.edit && !p.login && !(p.save && this.unsavedChanges));\n\t\t\tthis.ui.bar.classList.toggle(\"floating\", floating);\n\t\t});\n\n\t\tthis.permissions.onchange(({action, value}) => {\n\t\t\tthis.wrapper.classList.toggle(`can-${action}`, value);\n\t\t});\n\n\t\tthis.permissions.can([\"edit\", \"add\", \"delete\"], () => {\n\t\t\tthis.ui.edit = $.create(\"button\", {\n\t\t\t\tclassName: \"edit\",\n\t\t\t\ttextContent: \"Edit\",\n\t\t\t\tonclick: e => this.editing? this.done() : this.edit(),\n\t\t\t\tinside: this.ui.bar\n\t\t\t});\n\n\t\t\tif (this.autoEdit) {\n\t\t\t\trequestAnimationFrame(() => this.ui.edit.click());\n\t\t\t}\n\t\t}, () => { // cannot\n\t\t\t$.remove(this.ui.edit);\n\n\t\t\tif (this.editing) {\n\t\t\t\tthis.done();\n\t\t\t}\n\t\t});\n\n\t\tif (this.needsEdit) {\n\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\tthis.ui.save = $.create(\"button\", {\n\t\t\t\t\tclassName: \"save\",\n\t\t\t\t\ttextContent: \"Save\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.save(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tthis.wrapper.classList.add(\"save-hovered\");\n\t\t\t\t\t\t\tthis.setUnsavedChanges();\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.wrapper.classList.remove(\"save-hovered\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\n\t\t\t\tthis.ui.revert = $.create(\"button\", {\n\t\t\t\t\tclassName: \"revert\",\n\t\t\t\t\ttextContent: \"Revert\",\n\t\t\t\t\tdisabled: true,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.revert(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tif (!this.unsavedChanges) {\n\t\t\t\t\t\t\t\tthis.wrapper.classList.add(\"revert-hovered\");\n\t\t\t\t\t\t\t\tthis.setUnsavedChanges();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.wrapper.classList.remove(\"revert-hovered\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\t\t\t}, () => {\n\t\t\t\t$.remove([this.ui.save, this.ui.revert]);\n\t\t\t\tthis.ui.save = this.ui.revert = null;\n\t\t\t});\n\t\t}\n\n\t\tthis.permissions.can(\"delete\", () => {\n\t\t\tthis.ui.clear = $.create(\"button\", {\n\t\t\t\tclassName: \"clear\",\n\t\t\t\ttextContent: \"Clear\",\n\t\t\t\tonclick: e => this.clear()\n\t\t\t});\n\n\t\t\tthis.ui.bar.appendChild(this.ui.clear);\n\t\t});\n\n\t\tthis.permissions.cannot([\"delete\", \"edit\"], () => {\n\t\t\t$.remove(this.ui.clear);\n\t\t});\n\n\t\tif (this.store || this.source) {\n\t\t\t// Fetch existing data\n\t\t\tthis.storage = new _.Storage(this);\n\n\t\t\tthis.permissions.can(\"read\", () => this.storage.load());\n\t\t}\n\t\telse {\n\t\t\t// No storage\n\t\t\tthis.permissions.on([\"read\", \"edit\"]);\n\n\t\t\t$.fire(this.wrapper, \"mavo:load\");\n\t\t}\n\n\t\tif (!this.needsEdit) {\n\t\t\tthis.permissions.off([\"edit\", \"add\", \"delete\"]);\n\t\t}\n\n\t\tMavo.hooks.run(\"init-end\", this);\n\t},\n\n\tget data() {\n\t\treturn this.getData();\n\t},\n\n\tgetData: function(o) {\n\t\treturn this.root.getData(o);\n\t},\n\n\ttoJSON: function(data = this.data) {\n\t\treturn _.toJSON(data);\n\t},\n\n\trender: function(data) {\n\t\t_.hooks.run(\"render-start\", {context: this, data});\n\n\t\tif (data) {\n\t\t\tthis.root.render(data);\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tclear: function() {\n\t\tif (confirm(\"This will delete all your data. Are you sure?\")) {\n\t\t\tthis.storage && this.storage.clear();\n\t\t\tthis.root.clear();\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.editing = true;\n\n\t\tthis.root.edit();\n\n\t\t$.events(this.wrapper, \"mouseenter.mavo:edit mouseleave.mavo:edit\", evt => {\n\t\t\tif (evt.target.matches(\".mv-item-controls .delete\")) {\n\t\t\t\tvar item = evt.target.closest(_.selectors.item);\n\t\t\t\titem.classList.toggle(\"delete-hover\", evt.type == \"mouseenter\");\n\t\t\t}\n\n\t\t\tif (evt.target.matches(_.selectors.item)) {\n\t\t\t\tevt.target.classList.remove(\"has-hovered-item\");\n\n\t\t\t\tvar parent = evt.target.parentNode.closest(_.selectors.item);\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tparent.classList.toggle(\"has-hovered-item\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\t\t}, true);\n\n\t\tthis.setUnsavedChanges();\n\t},\n\n\tsetUnsavedChanges: function(value) {\n\t\tvar unsavedChanges = !!value;\n\n\t\tif (!value) {\n\t\t\tthis.walk(obj => {\n\t\t\t\tif (obj.unsavedChanges) {\n\t\t\t\t\tunsavedChanges = true;\n\n\t\t\t\t\tif (value === false) {\n\t\t\t\t\t\tobj.unsavedChanges = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this.unsavedChanges = unsavedChanges;\n\t},\n\n\t// Conclude editing\n\tdone: function() {\n\t\tthis.root.done();\n\t\t$.unbind(this.wrapper, \".mavo:edit\");\n\t\tthis.editing = false;\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tsave: function() {\n\t\tthis.root.save();\n\n\t\tif (this.storage) {\n\t\t\tthis.storage.save();\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\trevert: function() {\n\t\tthis.root.revert();\n\t},\n\n\twalk: function(callback) {\n\t\tthis.root.walk(callback);\n\t},\n\n\tlive: {\n\t\tediting: {\n\t\t\tset: function(value) {\n\t\t\t\tthis.wrapper.classList.toggle(\"editing\", value);\n\n\t\t\t\tif (value) {\n\t\t\t\t\tthis.wrapper.setAttribute(\"data-editing\", \"\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.wrapper.removeAttribute(\"data-editing\");\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tthis.wrapper.classList.toggle(\"unsaved-changes\", value);\n\n\t\t\tif (this.ui && this.ui.save) {\n\t\t\t\tthis.ui.save.disabled = !value;\n\t\t\t\tthis.ui.revert.disabled = !value;\n\t\t\t}\n\t\t},\n\n\t\tneedsEdit: function(value) {\n\t\t\tthis.ui.bar[`${value? \"remove\" : \"set\"}Attribute`](\"hidden\", \"\");\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: [],\n\n\t\tsuperKey: navigator.platform.indexOf(\"Mac\") === 0? \"metaKey\" : \"ctrlKey\",\n\n\t\tinit: container => $$(_.selectors.init, container || document).map(element => new _(element)),\n\n\t\thooks: new $.Hooks()\n\t}\n});\n\n{\n\nlet s = _.selectors = {\n\tinit: \".mavo, [mavo], [data-mavo], [data-store]\",\n\tproperty: \"[property], [itemprop]\",\n\tspecificProperty: name => `[property=${name}], [itemprop=${name}]`,\n\tscope: \"[typeof], [itemscope], [itemtype], .mv-group\",\n\tmultiple: \"[multiple], [data-multiple], .multiple\",\n\trequired: \"[required], [data-required], .required\",\n\tformControl: \"input, select, option, textarea\",\n\tcomputed: \".computed\", // Properties or scopes with computed properties, will not be saved\n\titem: \".mv-item\",\n\tui: \".mv-ui\",\n\toption: name => `[${name}], [data-${name}], [data-mv-options~='${name}'], .${name}`,\n\tcontainer: {\n\t\t\"li\": \"ul, ol\",\n\t\t\"tr\": \"table\",\n\t\t\"option\": \"select\",\n\t\t\"dt\": \"dl\",\n\t\t\"dd\": \"dl\"\n\t},\n\tdocumentFragment: \".document-fragment\"\n};\n\nlet arr = s.arr = selector => selector.split(/\\s*,\\s*/g);\nlet not = s.not = selector => arr(selector).map(s => `:not(${s})`).join(\"\");\nlet or = s.or = (selector1, selector2) => selector1 + \", \" + selector2;\nlet and = s.and = (selector1, selector2) => {\n\tvar ret = [], arr2 = arr(selector2);\n\n\tarr(selector1).forEach(s1 => ret.push(...arr2.map(s2 => s1 + s2)));\n\n\treturn ret.join(\", \");\n};\nlet andNot = s.andNot = (selector1, selector2) => and(selector1, not(selector2));\n\n$.extend(_.selectors, {\n\tprimitive: andNot(s.property, s.scope),\n\trootScope: andNot(s.scope, s.property),\n\toutput: or(s.specificProperty(\"output\"), \".output, .value\"),\n\tautoMultiple: and(\"li, tr, option\", \":only-of-type\")\n});\n\n}\n\n// Init mavo\nPromise.all([\n\t$.ready(),\n\t$.include(Array.from && window.Intl && document.documentElement.closest, \"https://cdn.polyfill.io/v2/polyfill.min.js?features=blissfuljs,Intl.~locale.en\")\n])\n.catch(err => console.error(err))\n.then(() => Mavo.init());\n\nStretchy.selectors.filter = \".mv-editor:not([property])\";\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}