{"version":3,"sources":["group.js"],"names":["$","$$","_","Mavo","Group","Class","extends","Unit","constructor","element","mavo","o","_this","this","children","group","hooks","run","Primitive","getValueAttribute","property","selectors","forEach","Node","getProperty","contains","existing","template","constructorOptions","collection","Collection","add","mutable","is","obj","create","vocabElement","isRoot","closest","vocab","getAttribute","getData","arguments","length","undefined","env","context","options","data","call","propagate","saved","store","unhandled","extend","type","DEFAULT_TYPE","summary","toString","find","prop","ret","save","unsavedChanges","propagated","render","_this2","Array","isArray","parentGroup","parentNode","static","all","WeakMap","normalize","setAttribute","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Group = $.Class({\n\textends: Mavo.Unit,\n\tconstructor: function (element, mavo, o) {\n\t\tthis.children = {};\n\n\t\tthis.group = this;\n\n\t\tMavo.hooks.run(\"group-init-start\", this);\n\n\t\t// Should this element also create a primitive?\n\t\tif (Mavo.Primitive.getValueAttribute(this.element)) {\n\t\t\tvar obj = this.children[this.property] = new Mavo.Primitive(this.element, this.mavo, {group: this});\n\t\t}\n\n\t\t// Create Mavo objects for all properties in this group (primitives orgroups),\n\t\t// but not properties in descendantgroups (they will be handled by their group)\n\t\t$$(Mavo.selectors.property, this.element).forEach(element => {\n\t\t\tvar property = Mavo.Node.getProperty(element);\n\n\t\t\tif (this.contains(element)) {\n\t\t\t\tvar existing = this.children[property];\n\t\t\t\tvar template = this.template? this.template.children[property] : null;\n\t\t\t\tvar constructorOptions = {template, group: this};\n\n\t\t\t\tif (existing) {\n\t\t\t\t\t// Twogroups with the same property, convert to static collection\n\t\t\t\t\tvar collection = existing;\n\n\t\t\t\t\tif (!(existing instanceof Mavo.Collection)) {\n\t\t\t\t\t\tcollection = new Mavo.Collection(existing.element, this.mavo, constructorOptions);\n\t\t\t\t\t\tthis.children[property] = existing.collection = collection;\n\t\t\t\t\t\tcollection.add(existing);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!collection.mutable && Mavo.is(\"multiple\", element)) {\n\t\t\t\t\t\tcollection.mutable = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tcollection.add(element);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// No existing properties with this id, normal case\n\t\t\t\t\tvar obj = Mavo.Node.create(element, this.mavo, constructorOptions);\n\n\t\t\t\t\tthis.children[property] = obj;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tvar vocabElement = (this.isRoot? this.element.closest(\"[vocab]\") : null) || this.element;\n\t\tthis.vocab = vocabElement.getAttribute(\"vocab\");\n\n\t\tMavo.hooks.run(\"group-init-end\", this);\n\t},\n\n\tget isRoot() {\n\t\treturn !this.property;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: this.super.getData.call(this, o)\n\t\t};\n\n\t\tif (env.data !== undefined) {\n\t\t\treturn env.data;\n\t\t}\n\n\t\tenv.data = {};\n\n\t\tthis.propagate(obj => {\n\t\t\tif ((obj.saved || o.store == \"*\") && !(obj.property in env.data)) {\n\t\t\t\tvar data = obj.getData(o);\n\n\t\t\t\tif (data !== null || env.options.null) {\n\t\t\t\t\tenv.data[obj.property] = data;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (env.options.unhandled) {\n\t\t\t$.extend(env.data, this.unhandled);\n\t\t}\n\n\t\t// JSON-LD stuff\n\t\tif (this.type && this.type != _.DEFAULT_TYPE) {\n\t\t\tenv.data[\"@type\"] = this.type;\n\t\t}\n\n\t\tif (this.vocab) {\n\t\t\tenv.data[\"@context\"] = this.vocab;\n\t\t}\n\n\t\t// Special summary property works like toString\n\t\tif (env.data.summary) {\n\t\t\tenv.data.toString = function() {\n\t\t\t\treturn this.summary;\n\t\t\t};\n\t\t}\n\n\t\tMavo.hooks.run(\"primitive-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t/**\n\t * Search entire subtree for property, return relative value\n\t * @return {Mavo.Unit}\n\t */\n\tfind: function(property) {\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\n\t\tif (property in this.children) {\n\t\t\treturn this.children[property].find(property);\n\t\t}\n\n\t\tfor (var prop in this.children) {\n\t\t\tvar ret = this.children[prop].find(property);\n\n\t\t\tif (ret !== undefined) {\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t},\n\n\tsave: function() {\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tpropagated: [\"save\", \"import\", \"clear\"],\n\n\t// Inject data in this element\n\trender: function(data) {\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tMavo.hooks.run(\"group-render-start\", this);\n\n\t\t// TODO retain dropped elements\n\t\tdata = Array.isArray(data)? data[0] : data;\n\n\t\t// TODO what if it was a primitive and now it's a group?\n\t\t// In that case, render the this.children[this.property] with it\n\n\t\tthis.unhandled = $.extend({}, data, property => {\n\t\t\treturn !(property in this.children);\n\t\t});\n\n\t\tthis.propagate(obj => {\n\t\t\tobj.render(data[obj.property]);\n\t\t});\n\n\t\tthis.save();\n\n\t\tMavo.hooks.run(\"group-render-end\", this);\n\t},\n\n\t// Check if this group contains a property\n\t// property can be either a Mavo.Unit or a Node\n\tcontains: function(property) {\n\t\tif (property instanceof Mavo.Unit) {\n\t\t\treturn property.parentGroup === this;\n\t\t}\n\n\t\treturn property.parentNode && (this.element === property.parentNode.closest(Mavo.selectors.group));\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tDEFAULT_TYPE: \"Item\",\n\n\t\tnormalize: function(element) {\n\t\t\t// Get & normalize typeof name, if exists\n\t\t\tif (Mavo.is(\"group\", element)) {\n\t\t\t\tvar type = element.getAttribute(\"typeof\") || element.getAttribute(\"itemtype\") || _.DEFAULT_TYPE;\n\n\t\t\t\telement.setAttribute(\"typeof\", type);\n\n\t\t\t\treturn type;\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}