{"version":3,"sources":["group.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","$$","_","Mavo","Group","Class","extends","Node","nodeType","constructor","element","mavo","o","_this","this","children","group","hooks","run","Primitive","getValueAttribute","property","selectors","forEach","getProperty","contains","existing","template","constructorOptions","collection","Collection","add","mutable","is","obj","create","vocabElement","isRoot","closest","vocab","getAttribute","getData","arguments","undefined","env","context","options","data","call","propagate","saved","store","unhandled","extend","type","DEFAULT_TYPE","summary","toString","find","all","prop","ret","push","apply","save","unsavedChanges","propagated","dataRender","_this2","render","parentGroup","parentNode","static","WeakMap","normalize","setAttribute","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Group = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Group\",\n\tconstructor: function (element, mavo, o) {\n\t\tthis.children = {};\n\n\t\tthis.group = this;\n\n\t\tMavo.hooks.run(\"group-init-start\", this);\n\n\t\t// Should this element also create a primitive?\n\t\tif (Mavo.Primitive.getValueAttribute(this.element)) {\n\t\t\tvar obj = this.children[this.property] = new Mavo.Primitive(this.element, this.mavo, {group: this});\n\t\t}\n\n\t\t// Create Mavo objects for all properties in this group (primitives orgroups),\n\t\t// but not properties in descendantgroups (they will be handled by their group)\n\t\t$$(Mavo.selectors.property, this.element).forEach(element => {\n\t\t\tvar property = Mavo.Node.getProperty(element);\n\n\t\t\tif (this.contains(element)) {\n\t\t\t\tvar existing = this.children[property];\n\t\t\t\tvar template = this.template? this.template.children[property] : null;\n\t\t\t\tvar constructorOptions = {template, group: this};\n\n\t\t\t\tif (existing) {\n\t\t\t\t\t// Twogroups with the same property, convert to static collection\n\t\t\t\t\tvar collection = existing;\n\n\t\t\t\t\tif (!(existing instanceof Mavo.Collection)) {\n\t\t\t\t\t\tcollection = new Mavo.Collection(existing.element, this.mavo, constructorOptions);\n\t\t\t\t\t\tthis.children[property] = existing.collection = collection;\n\t\t\t\t\t\tcollection.add(existing);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!collection.mutable && Mavo.is(\"multiple\", element)) {\n\t\t\t\t\t\tcollection.mutable = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tcollection.add(element);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// No existing properties with this id, normal case\n\t\t\t\t\tvar obj = Mavo.Node.create(element, this.mavo, constructorOptions);\n\n\t\t\t\t\tthis.children[property] = obj;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tvar vocabElement = (this.isRoot? this.element.closest(\"[vocab]\") : null) || this.element;\n\t\tthis.vocab = vocabElement.getAttribute(\"vocab\");\n\n\t\tMavo.hooks.run(\"group-init-end\", this);\n\t},\n\n\tget isRoot() {\n\t\treturn !this.property;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: this.super.getData.call(this, o)\n\t\t};\n\n\t\tif (env.data !== undefined) {\n\t\t\treturn env.data;\n\t\t}\n\n\t\tenv.data = {};\n\n\t\tthis.propagate(obj => {\n\t\t\tif ((obj.saved || o.store == \"*\") && !(obj.property in env.data)) {\n\t\t\t\tvar data = obj.getData(o);\n\n\t\t\t\tif (data !== null || env.options.null) {\n\t\t\t\t\tenv.data[obj.property] = data;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (env.options.unhandled) {\n\t\t\t$.extend(env.data, this.unhandled);\n\t\t}\n\n\t\t// JSON-LD stuff\n\t\tif (this.type && this.type != _.DEFAULT_TYPE) {\n\t\t\tenv.data[\"@type\"] = this.type;\n\t\t}\n\n\t\tif (this.vocab) {\n\t\t\tenv.data[\"@context\"] = this.vocab;\n\t\t}\n\n\t\t// Special summary property works like toString\n\t\tif (env.data.summary) {\n\t\t\tenv.data.toString = function() {\n\t\t\t\treturn this.summary;\n\t\t\t};\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t/**\n\t * Search entire subtree for property, return relative value\n\t * @return {Mavo.Node}\n\t */\n\tfind: function(property, o = {}) {\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\n\t\tif (property in this.children) {\n\t\t\treturn this.children[property].find(property, o);\n\t\t}\n\n\t\tvar all = [];\n\n\t\tfor (var prop in this.children) {\n\t\t\tvar ret = this.children[prop].find(property, o);\n\n\t\t\tif (ret !== undefined) {\n\t\t\t\tif (Array.isArray(ret)) {\n\t\t\t\t\tall.push(...ret);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn ret;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (all.length) {\n\t\t\treturn all;\n\t\t}\n\t},\n\n\tsave: function() {\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tpropagated: [\"save\", \"import\", \"clear\"],\n\n\t// Do not call directly, call this.render() instead\n\tdataRender: function(data) {\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\t// TODO retain dropped elements\n\t\tdata = Array.isArray(data)? data[0] : data;\n\n\t\t// TODO what if it was a primitive and now it's a group?\n\t\t// In that case, render the this.children[this.property] with it\n\n\t\tthis.unhandled = $.extend({}, data, property => {\n\t\t\treturn !(property in this.children);\n\t\t});\n\n\t\tthis.propagate(obj => {\n\t\t\tobj.render(data[obj.property]);\n\t\t});\n\t},\n\n\t// Check if this group contains a property\n\tcontains: function(property) {\n\t\tif (property instanceof Mavo.Node) {\n\t\t\treturn property.parentGroup === this;\n\t\t}\n\n\t\treturn property.parentNode && (this.element === property.parentNode.closest(Mavo.selectors.group));\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tDEFAULT_TYPE: \"Item\",\n\n\t\tnormalize: function(element) {\n\t\t\t// Get & normalize typeof name, if exists\n\t\t\tif (Mavo.is(\"group\", element)) {\n\t\t\t\tvar type = Mavo.getAttribute(element, \"typeof\", \"itemtype\") || _.DEFAULT_TYPE;\n\n\t\t\t\telement.setAttribute(\"typeof\", type);\n\n\t\t\t\treturn type;\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}