{"version":3,"sources":["collection.js"],"names":["$","$$","Mavo","Collection","Class","extends","Node","constructor","element","mavo","o","this","templateElement","items","fromTemplate","matches","div","document","createElement","getAttribute","classList","add","attributes","forEach","attr","setAttribute","name","value","appendChild","importNode","content","parentNode","replaceChild","properties","selectors","property","map","getProperty","mutable","multiple","cloneNode","item","createItem","itemTemplate","template","hooks","run","length","containsTemplate","getData","data","deleted","itemData","push","dirty","unhandled","before","concat","after","_this","Unit","create","collection","type","is","Fragment","permissions","can","className","contents","tag","title","events","click","evt","replace","bottomUp","indexOf","edit","inside","index","arguments","undefined","get","nextItem","_","marker","splice","i","_item","silent","fire","node","action","unsavedChanges","propagate","_arguments","call","apply","delete","hard","_this2","remove","transition","opacity","then","style","required","placeholder","walk","obj","once","preEdit","clear","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","childNodes","Symbol","iterator","next","done","err","save","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","propagated","revert","_iteratorNormalCompletion4","_didIteratorError4","_iteratorError4","_step4","_iterator4","render","_this3","toArray","fragment","createDocumentFragment","datum","insertBefore","slice","find","filter","ret","flatten","live","_mutable","needsEdit","hidden","addButton","tagName","toLowerCase","containerSelector","container","closest","lazy","order","test","compareDocumentPosition","DOCUMENT_POSITION_FOLLOWING","closestCollection","parent","_this4","selector","scope","button","contains","textContent","addEventListener","preventDefault","_iteratorNormalCompletion5","_didIteratorError5","_iteratorError5","_step5","_iterator5","toggle","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.items = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\")) {\n\t\t\tif (this.templateElement.matches(\"template\")) {\n\t\t\t\tvar div = document.createElement(this.templateElement.getAttribute(\"data-tag\") || \"mv-group\");\n\t\t\t\tdiv.classList.add(\"document-fragment\");\n\n\t\t\t\t$$(this.templateElement.attributes).forEach(attr => {\n\t\t\t\t\tdiv.setAttribute(attr.name, attr.value);\n\t\t\t\t});\n\n\t\t\t\tdiv.appendChild(document.importNode(this.templateElement.content, true));\n\t\t\t\tthis.templateElement.parentNode.replaceChild(div, this.templateElement);\n\t\t\t\tthis.element = this.templateElement = div;\n\t\t\t}\n\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.items.length;\n\t},\n\n\t// Collection still contains its template as data\n\tget containsTemplate() {\n\t\treturn this.items.length && this.items[0].element === this.element;\n\t},\n\n\tgetData: function(o) {\n\t\to = o || {};\n\n\t\tvar data = [];\n\n\t\tthis.items.forEach(item => {\n\t\t\tif (!item.deleted) {\n\t\t\t\tvar itemData = item.getData(o);\n\n\t\t\t\tif (itemData) {\n\t\t\t\t\tdata.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (!o.dirty && this.unhandled) {\n\t\t\tdata = this.unhandled.before.concat(data, this.unhandled.after);\n\t\t}\n\n\t\treturn data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Unit.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type,\n\t\t\tdirty: true\n\t\t});\n\n\t\t// If container is a fake \"fragment\", strip element naked\n\t\tif (Mavo.is(\"documentFragment\", item.element)) {\n\t\t\titem.element = new Mavo.Fragment(item.element);\n\t\t}\n\t\t// Add delete & add buttons\n\t\telse if (this.mutable) {\n\t\t\tthis.mavo.permissions.can(\"edit\", () => {\n\t\t\t\t$.create({\n\t\t\t\t\tclassName: \"mv-item-controls mv-ui\",\n\t\t\t\t\tcontents: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttitle: \"Delete this \" + this.name,\n\t\t\t\t\t\t\tclassName: \"delete\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\"click\": evt => this.delete(item)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttitle: `Add new ${this.name.replace(/s$/i, \"\")} ${this.bottomUp? \"after\" : \"before\"}`,\n\t\t\t\t\t\t\tclassName: \"add\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\"click\": evt => this.add(null, this.items.indexOf(item)).edit()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\tinside: element\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Unit} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Unit.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (index in this.items) {\n\t\t\tif (this.bottomUp) {\n\t\t\t\tindex++;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t}\n\n\t\tif (!item.element.parentNode) {\n\t\t\t// Add it to the DOM, if not already in\n\t\t\tvar nextItem = this.items[index];\n\n\t\t\titem.element._.before(nextItem && nextItem.element || this.marker);\n\t\t}\n\n\t\t// Update internal data model\n\t\tthis.items.splice(index, 0, item);\n\n\t\tfor (let i = index - 1; i < this.length; i++) {\n\t\t\tlet item = this.items[i];\n\n\t\t\tif (item) {\n\t\t\t\titem.index = i;\n\n\t\t\t\tif (!o.silent) {\n\t\t\t\t\titem.element._.fire(\"mavo:datachange\", {\n\t\t\t\t\t\tnode: this,\n\t\t\t\t\t\tmavo: this.mavo,\n\t\t\t\t\t\taction: \"add\",\n\t\t\t\t\t\titem\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!o.silent) {\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t}\n\n\t\treturn item;\n\t},\n\n\tpropagate: function() {\n\t\tthis.items.forEach(item => item.call.apply(item, arguments));\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.items.splice(this.items.indexOf(item), 1);\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.element._.fire(\"mavo:datachange\", {\n\t\t\t\tnode: this,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\taction: \"delete\",\n\t\t\t\titem: item\n\t\t\t});\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\tedit: function() {\n\t\tif (this.length === 0 && this.required) {\n\t\t\t// Nested collection with no items, add one\n\t\t\tvar item = this.add(null, null, true);\n\n\t\t\titem.placeholder = true;\n\t\t\titem.walk(obj => obj.unsavedChanges = false);\n\n\t\t\t$.once(item.element, \"mavo:datachange\", evt => {\n\t\t\t\titem.unsavedChanges = true;\n\t\t\t\titem.placeholder = false;\n\t\t\t});\n\t\t}\n\n\t\tthis.propagate(obj => obj[obj.preEdit? \"preEdit\" : \"edit\"]());\n\t},\n\n\t/**\n\t * Delete all items in the collection.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.element.remove) {\n\t\t\t\t\titem.element.remove();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Document fragment, remove all children\n\t\t\t\t\tfor (let node of item.element.childNodes) {\n\t\t\t\t\t\tnode => node.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.items = [];\n\n\t\t\tthis.marker._.fire(\"mavo:datachange\", {\n\t\t\t\tnode: this,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\taction: \"clear\"\n\t\t\t});\n\t\t}\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.items) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = item.dirty = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tdone: function() {\n\t\tfor (let item of this.items) {\n\t\t\tif (item.placeholder) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\", \"done\"],\n\n\trevert: function() {\n\t\tfor (let item of this.items) {\n\t\t\t// Delete added items\n\t\t\tif (item.unsavedChanges && !item.placeholder) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Bring back deleted items\n\t\t\t\tif (item.deleted) {\n\t\t\t\t\titem.deleted = false;\n\t\t\t\t}\n\n\t\t\t\t// Revert all properties\n\t\t\t\titem.revert();\n\t\t\t}\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tthis.unhandled = {before: [], after: []};\n\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.items.forEach((item, i) => item.render(data && data[i]));\n\n\t\t\tif (data) {\n\t\t\t\tthis.unhandled.after = data.slice(this.items.length);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.clear();\n\n\t\t\t// Using document fragments improved rendering performance by 60%\n\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\tdata.forEach((datum, i) => {\n\t\t\t\tvar item = this.createItem();\n\n\t\t\t\titem.render(datum);\n\n\t\t\t\tthis.items.push(item);\n\t\t\t\titem.index = i;\n\n\t\t\t\tfragment.appendChild(item.element);\n\t\t\t});\n\n\t\t\tthis.marker.parentNode.insertBefore(fragment, this.marker);\n\t\t}\n\n\t\tthis.save();\n\t},\n\n\tfind: function(property) {\n\t\tvar items = this.items.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has data-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\tthis.mavo.needsEdit = true;\n\n\t\t\t\tthis.required = this.templateElement.matches(Mavo.selectors.required);\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = $.create(\"div\", {\n\t\t\t\t\thidden: true,\n\t\t\t\t\tclassName: \"mv-marker\",\n\t\t\t\t\tafter: this.templateElement\n\t\t\t\t});\n\n\t\t\t\tthis.templateElement.classList.add(\"mv-item\");\n\n\t\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\t\tthis.addButton._.before($.value(this.items[0], \"element\") || this.marker);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\n\t\t\t\t\t\tif (containerSelector) {\n\t\t\t\t\t\t\tvar after = this.marker.closest(containerSelector);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.addButton._.after(after && after.parentNode? after : this.marker);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"data-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.templateElement) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.item);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.add-${this.property}`;\n\t\t\tvar scope = this.closestCollection || this.marker.closest(Mavo.selectors.scope);\n\n\t\t\tif (scope) {\n\t\t\t\tvar button = $$(selector, scope).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.add().edit();\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t}\n});\n\n// TODO\nMavo.Fragment = $.Class({\n\tconstructor: function(element) {\n\t\tthis.childNodes = [];\n\n\t\tfor (let node of element.childNodes) {\n\t\t\tthis.appendChild(node);\n\t\t}\n\t},\n\n\tappendChild: function(node) {\n\t\tthis.childNodes.push(node);\n\t},\n\n\tclassList: {toggle: () => {}, add: () => {}, remove: () => {}, contains: () => {}}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}