{"version":3,"sources":["expressions.js"],"names":["_typeof","Symbol","iterator","obj","constructor","$","$$","Mavo","attributes","push","_","Expressions","Class","group","_this","this","expressions","all","hooks","run","template","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_step","_iterator","next","done","et","value","Expression","Text","err","syntax","Syntax","create","element","closest","traverse","dependents","Set","active","addEventListener","evt","update","isDeleted","length","size","env","context","data","getRelativeData","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","ref","changedBy","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","exp","extract","node","attribute","path","name","directives","indexOf","test","textContent","slice","split","map","i","_this2","arguments","nodeType","is","ESCAPE","forEach","childNodes","child","static","self","Proxy","add","_this3","options","relative","get","property","proxy","index","mavo","id","has","ret","walkUp","children","find","Array","isArray","item","filter","Node","set","Error","prototype","getData","store","null","unhandled","_this4","requestAnimationFrame","Bliss","Primitive","getValueAttribute","fallback","getValue","expression","getAttribute","parsed","start","end"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nMavo.attributes.push(\"mv-value\", \"mv-if\");\n\nvar _ = Mavo.Expressions = $.Class({\n\tconstructor: function(group) {\n\t\tif (group) {\n\t\t\tthis.group = group;\n\t\t\tthis.group.expressions = this;\n\t\t}\n\n\t\tthis.all = []; // all Expression.Text objects in this group\n\n\t\tMavo.hooks.run(\"expressions-init-start\", this);\n\n\t\tif (this.group) {\n\t\t\tvar template = this.group.template;\n\n\t\t\tif (template && template.expressions) {\n\t\t\t\t// We know which expressions we have, don't traverse again\n\t\t\t\tfor (let et of template.expressions.all) {\n\t\t\t\t\tthis.all.push(new Mavo.Expression.Text({\n\t\t\t\t\t\ttemplate: et,\n\t\t\t\t\t\tgroup: this.group\n\t\t\t\t\t}));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tvar syntax = Mavo.Expression.Syntax.create(this.group.element.closest(\"[mv-expressions]\")) || Mavo.Expression.Syntax.default;\n\t\t\t\tthis.traverse(this.group.element, undefined, syntax);\n\t\t\t}\n\t\t}\n\n\t\tthis.dependents = new Set();\n\n\t\tthis.active = true;\n\n\t\t// Watch changes and update value\n\t\tthis.group.element.addEventListener(\"mavo:datachange\", evt => this.update(evt));\n\t},\n\n\t/**\n\t * Update all expressions in this group\n\t */\n\tupdate: function callee(evt) {\n\t\tif (!this.active || this.group.isDeleted() || this.all.length + this.dependents.size === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar env = { context: this, data: this.group.getRelativeData() };\n\n\t\tMavo.hooks.run(\"expressions-update-start\", env);\n\n\t\tfor (let ref of this.all) {\n\t\t\tif (ref.changedBy(evt)) {\n\t\t\t\tref.update(env.data, evt);\n\t\t\t}\n\t\t}\n\n\t\tfor (let exp of this.dependents) {\n\t\t\texp.update();\n\t\t}\n\t},\n\n\textract: function(node, attribute, path, syntax) {\n\t\tif (attribute && attribute.name == \"mv-expressions\") {\n\t\t\treturn;\n\t\t}\n\n\t\tif ((attribute && _.directives.indexOf(attribute.name) > -1) ||\n\t\t    syntax.test(attribute? attribute.value : node.textContent)\n\t\t) {\n\t\t\tthis.all.push(new Mavo.Expression.Text({\n\t\t\t\tnode, syntax,\n\t\t\t\tpath: path? path.slice(1).split(\"/\").map(i => +i) : [],\n\t\t\t\tattribute: attribute && attribute.name,\n\t\t\t\tgroup: this.group\n\t\t\t}));\n\t\t}\n\t},\n\n\t// Traverse an element, including attribute nodes, text nodes and all descendants\n\ttraverse: function(node, path = \"\", syntax) {\n\t\tif (node.nodeType === 8) {\n\t\t\t// We don't want expressions to be picked up from comments!\n\t\t\t// Commenting stuff out is a common debugging technique\n\t\t\treturn;\n\t\t}\n\n\t\tif (node.nodeType === 3) { // Text node\n\t\t\t// Leaf node, extract references from content\n\t\t\tthis.extract(node, null, path, syntax);\n\t\t}\n\t\t// Traverse children and attributes as long as this is NOT the root of a child group\n\t\t// (otherwise, it will be taken care of its own Expressions object)\n\t\telse if (node == this.group.element || !Mavo.is(\"group\", node)) {\n\t\t\tsyntax = Mavo.Expression.Syntax.create(node) || syntax;\n\n\t\t\tif (syntax === Mavo.Expression.Syntax.ESCAPE) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t$$(node.attributes).forEach(attribute => this.extract(node, attribute, path, syntax));\n\t\t\t$$(node.childNodes).forEach((child, i) => this.traverse(child, `${path}/${i}`, syntax));\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdirectives: []\n\t}\n});\n\nif (self.Proxy) {\n\tMavo.hooks.add(\"node-getdata-end\", function(env) {\n\t\tif (env.options.relative && env.data && typeof env.data === \"object\") {\n\t\t\tenv.data = new Proxy(env.data, {\n\t\t\t\tget: (data, property, proxy) => {\n\t\t\t\t\t// Checking if property is in proxy might add it to the data\n\t\t\t\t\tif (property in data || (property in proxy && property in data)) {\n\t\t\t\t\t\treturn data[property];\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == \"$index\") {\n\t\t\t\t\t\treturn this.index + 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == this.mavo.id) {\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\thas: (data, property) => {\n\t\t\t\t\tif (property in data) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Property does not exist, look for it elsewhere\n\n\t\t\t\t\tif (property == \"$index\" || property == this.mavo.id) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// First look in ancestors\n\t\t\t\t\tvar ret = this.walkUp(group => {\n\t\t\t\t\t\tif (property in group.children) {\n\t\t\t\t\t\t\treturn group.children[property];\n\t\t\t\t\t\t};\n\t\t\t\t\t});\n\n\t\t\t\t\tif (ret === undefined) {\n\t\t\t\t\t\t// Still not found, look in descendants\n\t\t\t\t\t\tret = this.find(property);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (ret !== undefined) {\n\t\t\t\t\t\tif (Array.isArray(ret)) {\n\t\t\t\t\t\t\tret = ret.map(item => item.getRelativeData(env.options))\n\t\t\t\t\t\t\t\t\t .filter(item => item !== null);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (ret instanceof Mavo.Node) {\n\t\t\t\t\t\t\tret = ret.getRelativeData(env.options);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdata[property] = ret;\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\n\t\t\t\tset: function(data, property, value) {\n\t\t\t\t\tthrow Error(\"You can’t set data via expressions.\");\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n}\n\nMavo.Node.prototype.getRelativeData = function() {\n\treturn this.getData({\n\t\trelative: true,\n\t\tstore: \"*\",\n\t\tnull: true,\n\t\tunhandled: this.mavo.unhandled\n\t});\n};\n\nMavo.hooks.add(\"group-init-start\", function() {\n\tnew Mavo.Expressions(this);\n});\n\nMavo.hooks.add(\"group-init-end\", function() {\n\tthis.expressions.update();\n});\n\n\n// Disable expressions during rendering, for performance\nMavo.hooks.add(\"group-render-start\", function() {\n\tthis.expressions.active = false;\n});\n\nMavo.hooks.add(\"group-render-end\", function() {\n\trequestAnimationFrame(() => {\n\t\tthis.expressions.active = true;\n\t\tthis.expressions.update();\n\t});\n});\n\n})(Bliss, Bliss.$);\n\n// mv-value plugin\nMavo.Expressions.directives.push(\"mv-value\");\n\nMavo.hooks.add(\"expressiontext-init-start\", function() {\n\tif (this.attribute == \"mv-value\") {\n\t\tthis.attribute = Mavo.Primitive.getValueAttribute(this.element);\n\t\tthis.fallback = this.fallback || Mavo.Primitive.getValue(this.element, {attribute: this.attribute});\n\t\tthis.expression = this.element.getAttribute(\"mv-value\");\n\n\t\tthis.parsed = [new Mavo.Expression(this.expression)];\n\t\tthis.expression = this.syntax.start + this.expression + this.syntax.end;\n\t}\n});\n"],"sourceRoot":"/source/"}