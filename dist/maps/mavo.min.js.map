{"version":3,"sources":["unit.js"],"names":["$","$$","Mavo","Unit","Class","abstract","extends","Node","constructor","element","mavo","o","arguments","length","undefined","this","all","set","collection","dirty","group","parentGroup","fromTemplate","required","is","hooks","run","isDeleted","deleted","getData","isNull","walkUp","saved","store","lazy","closestCollection","live","value","toggleAttribute","_this","classList","toggle","elementContents","document","createDocumentFragment","childNodes","forEach","node","appendChild","contents","tag","className","textContent","events","click","evt","remove","parentNode","name","_deleted","fire","unit","action","item","unsavedChanges","editing","static","get","prioritizePrimitive","Group","Primitive","create","TypeError","Bliss"],"mappings":"AAAA,cAGA,SAAUA,EAAGC,GAELC,KAAKC,KAAOH,EAAEI,OACrBC,YAAU,EACVC,UAASJ,KAAKK,KACdC,YAAa,SAASC,EAASC,GAAc,GAARC,GAAQC,UAAAC,QAAA,GAAAC,SAAAF,UAAA,MAAAA,UAAA,EAC5CG,MAAKP,YAAYQ,IAAIC,IAAIF,KAAKN,QAASM,MAEvCA,KAAKG,WAAaP,EAAEO,WACpBH,KAAKI,MAAQR,EAAEQ,MAEXJ,KAAKG,aAERH,KAAKK,MAAQL,KAAKM,YAAcN,KAAKG,WAAWG,aAG5CN,KAAKO,aAAa,cACtBP,KAAKQ,SAAWrB,KAAKsB,GAAG,WAAYT,KAAKN,UAG1CP,KAAKuB,MAAMC,IAAI,gBAAiBX,OAMjCY,UAAW,WACAZ,KAAKa,OAEf,SAAIb,KAAKa,WAIAb,KAAKM,aAAeN,KAAKM,YAAYM,aAG/CE,QAAS,SAASlB,GAGjB,MAFAA,GAAIA,MAEAI,KAAKe,OAAOnB,GACR,SAIRI,MAAKgB,OAAO,SAAAX,GACX,GAAIA,EAAMU,OAAOnB,GAChB,MAAO,SAKVmB,OAAQ,SAASnB,GAChB,MAAOI,MAAKI,QAAUR,EAAEQ,OACpBJ,KAAKa,SAAWjB,EAAEQ,QACjBJ,KAAKiB,OAAqB,KAAXrB,EAAEsB,OAGvBC,MACCC,kBAAmB,WAClB,MAAOpB,MAAKG,YACLH,KAAKK,MAAMF,aACVH,KAAKM,YAAaN,KAAKM,YAAYc,kBAAoB,QAIjEC,MACCH,MAAO,SAASI,GACfrC,EAAEsC,gBAAgBvB,KAAKN,QAAS,aAAc4B,IAG/CT,QAAS,SAASS;AAAO,GAAAE,GAAAxB,IACxBA,MAAKN,QAAQ+B,UAAUC,OAAO,UAAWJ,GAErCA,GAGHtB,KAAK2B,gBAAkBC,SAASC,yBAChC3C,EAAGc,KAAKN,QAAQoC,YAAYC,QAAQ,SAAAC,GACnCR,EAAKG,gBAAgBM,YAAYD,KAGlC/C,EAAEiD,SAASlC,KAAKN,UAEdyC,IAAK,SACLC,UAAW,cACXC,YAAa,IACbC,QACCC,MAAS,SAASC,GACjBvD,EAAEwD,OAAOzC,KAAK0C,eAIjB,WAAa1C,KAAK2C,MAEjBR,IAAK,SACLC,UAAW,aACXC,YAAa,OACbC,QACCC,MAAS,SAAAC,GAAA,MAAOhB,GAAKX,SAAU,OAKlCb,KAAKN,QAAQ+B,UAAUgB,OAAO,iBAEtBzC,KAAKa,UAEbb,KAAKN,QAAQ2C,YAAc,GAC3BrC,KAAKN,QAAQuC,YAAYjC,KAAK2B,iBAI9B3B,KAAK4C,UAAW,EAEhB3D,EAAE4D,KAAK7C,KAAKN,QAAS,mBACpBoD,KAAM9C,KAAKG,WACXR,KAAMK,KAAKL,KACXoD,OAAQ,WACRC,KAAMhD,SAKTiD,eAAgB,SAAS3B,GAOxB,OANIA,GAAWtB,KAAKiB,OAAUjB,KAAKkD,UAClC5B,GAAQ,GAGTtB,KAAKN,QAAQ+B,UAAUC,OAAO,kBAAmBJ,GAE1CA,IAIT6B,UACCC,IAAK,SAAS1D,EAAS2D,GACtB,GAAIhD,GAAQlB,KAAKmE,MAAMrD,IAAImD,IAAI1D,EAE/B,OAAQ2D,KAAwBhD,EAAQlB,KAAKoE,UAAUtD,IAAImD,IAAI1D,GAAWW,GAG3EmD,OAAQ,SAAS9D,EAASC,GAAc,GAARC,GAAQC,UAAAC,QAAA,GAAAC,SAAAF,UAAA,MAAAA,UAAA;AACvC,IAAKH,IAAYC,EAChB,KAAM,IAAI8D,WAAU,oEAGrB,OAAO,KAAItE,KAAKA,KAAKsB,GAAG,QAASf,GAAU,QAAU,cAAaA,EAASC,EAAMC,QAKjF8D,MAAOA,MAAMzE","file":"mavo.min.js","sourcesContent":["/*\n * Mavo Unit: Super class that Group and Primitive inherit from\n */\n(function($, $$) {\n\nvar _ = Mavo.Unit = $.Class({\n\tabstract: true,\n\textends: Mavo.Node,\n\tconstructor: function(element, mavo, o = {}) {\n\t\tthis.constructor.all.set(this.element, this);\n\n\t\tthis.collection = o.collection;\n\t\tthis.dirty = o.dirty;\n\n\t\tif (this.collection) {\n\t\t\t// This is a collection item\n\t\t\tthis.group = this.parentGroup = this.collection.parentGroup;\n\t\t}\n\n\t\tif (!this.fromTemplate(\"required\")) {\n\t\t\tthis.required = Mavo.is(\"required\", this.element);\n\t\t}\n\n\t\tMavo.hooks.run(\"unit-init-end\", this);\n\t},\n\n\t/**\n\t * Check if this unit is either deleted or inside a deleted group\n\t */\n\tisDeleted: function() {\n\t\tvar ret = this.deleted;\n\n\t\tif (this.deleted) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn !!this.parentGroup && this.parentGroup.isDeleted();\n\t},\n\n\tgetData: function(o) {\n\t\to = o || {};\n\n\t\tif (this.isNull(o)) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Check if any of the parent groups doesn't return data\n\t\tthis.walkUp(group => {\n\t\t\tif (group.isNull(o)) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t});\n\t},\n\n\tisNull: function(o) {\n\t\treturn this.dirty && !o.dirty ||\n\t\t\t   this.deleted && o.dirty ||\n\t\t\t   !this.saved && (o.store != \"*\");\n\t},\n\n\tlazy: {\n\t\tclosestCollection: function() {\n\t\t\treturn this.collection ||\n\t\t\t       this.group.collection ||\n\t\t\t       (this.parentGroup? this.parentGroup.closestCollection : null);\n\t\t}\n\t},\n\n\tlive: {\n\t\tstore: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"data-store\", value);\n\t\t},\n\n\t\tdeleted: function(value) {\n\t\t\tthis.element.classList.toggle(\"deleted\", value);\n\n\t\t\tif (value) {\n\t\t\t\t// Soft delete, store element contents in a fragment\n\t\t\t\t// and replace them with an undo prompt.\n\t\t\t\tthis.elementContents = document.createDocumentFragment();\n\t\t\t\t$$(this.element.childNodes).forEach(node => {\n\t\t\t\t\tthis.elementContents.appendChild(node);\n\t\t\t\t});\n\n\t\t\t\t$.contents(this.element, [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\tclassName: \"close mv-ui\",\n\t\t\t\t\t\ttextContent: \"Ã—\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": function(evt) {\n\t\t\t\t\t\t\t\t$.remove(this.parentNode);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t\"Deleted \" + this.name,\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\tclassName: \"undo mv-ui\",\n\t\t\t\t\t\ttextContent: \"Undo\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.deleted = false\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]);\n\n\t\t\t\tthis.element.classList.remove(\"delete-hover\");\n\t\t\t}\n\t\t\telse if (this.deleted) {\n\t\t\t\t// Undelete\n\t\t\t\tthis.element.textContent = \"\";\n\t\t\t\tthis.element.appendChild(this.elementContents);\n\n\t\t\t\t// otherwise expressions won't update because this will still seem as deleted\n\t\t\t\t// Alternatively, we could fire datachange with a timeout.\n\t\t\t\tthis._deleted = false;\n\n\t\t\t\t$.fire(this.element, \"mavo:datachange\", {\n\t\t\t\t\tunit: this.collection,\n\t\t\t\t\tmavo: this.mavo,\n\t\t\t\t\taction: \"undelete\",\n\t\t\t\t\titem: this\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tif (value && (!this.saved || !this.editing)) {\n\t\t\t\tvalue = false;\n\t\t\t}\n\n\t\t\tthis.element.classList.toggle(\"unsaved-changes\", value);\n\n\t\t\treturn value;\n\t\t}\n\t},\n\n\tstatic: {\n\t\tget: function(element, prioritizePrimitive) {\n\t\t\tvar group = Mavo.Group.all.get(element);\n\n\t\t\treturn (prioritizePrimitive || !group)? Mavo.Primitive.all.get(element) : group;\n\t\t},\n\n\t\tcreate: function(element, mavo, o = {}) {\n\t\t\tif (!element || !mavo) {\n\t\t\t\tthrow new TypeError(\"Mavo.Unit.create() requires an element argument and a mavo object\");\n\t\t\t}\n\n\t\t\treturn new Mavo[Mavo.is(\"group\", element)? \"Group\" : \"Primitive\"](element, mavo, o);\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}