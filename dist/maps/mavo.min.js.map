{"version":3,"sources":["collection.js"],"names":["$","$$","Mavo","Collection","Class","extends","Node","constructor","element","mavo","o","this","templateElement","items","fromTemplate","properties","selectors","property","map","getProperty","mutable","matches","multiple","cloneNode","item","createItem","add","itemTemplate","template","hooks","run","length","containsTemplate","getData","arguments","undefined","env","context","options","data","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","Symbol","iterator","next","done","value","deleted","itemData","push","err","unhandled","before","concat","after","_this","Unit","create","collection","type","permissions","can","className","contents","tag","title","name","events","click","evt","replace","bottomUp","indexOf","edit","inside","index","get","parentNode","nextItem","_","marker","splice","i","_item","silent","fire","node","action","unsavedChanges","propagate","_arguments","forEach","call","apply","delete","hard","_this2","remove","transition","opacity","then","style","obj","preEdit","clear","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","childNodes","save","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","_item2","propagated","revert","_iteratorNormalCompletion4","_didIteratorError4","_iteratorError4","_step4","_iterator4","_item3","render","_this3","toArray","fragment","document","createDocumentFragment","datum","appendChild","insertBefore","slice","find","filter","ret","flatten","live","_mutable","needsEdit","required","hidden","classList","addButton","tagName","toLowerCase","containerSelector","container","closest","lazy","order","getAttribute","test","compareDocumentPosition","DOCUMENT_POSITION_FOLLOWING","closestCollection","parent","_this4","selector","group","button","contains","textContent","addEventListener","preventDefault","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.items = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.items.length;\n\t},\n\n\t// Collection still contains its template as data\n\tget containsTemplate() {\n\t\treturn this.items.length && this.items[0].element === this.element;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: []\n\t\t};\n\n\t\tfor (item of this.items) {\n\t\t\tif (!item.deleted) {\n\t\t\t\tlet itemData = item.getData(env.options);\n\n\t\t\t\tif (itemData) {\n\t\t\t\t\tenv.data.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this.unhandled && env.options.unhandled) {\n\t\t\tenv.data = this.unhandled.before.concat(env.data, this.unhandled.after);\n\t\t}\n\n\t\tif (!this.mutable && env.data.length == 1) {\n\t\t\t// See https://github.com/LeaVerou/mavo/issues/50#issuecomment-266079652\n\t\t\tenv.data = env.data[0];\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Unit.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type\n\t\t});\n\n\t\t// Add delete & add buttons\n\t\tif (this.mutable) {\n\t\t\tthis.mavo.permissions.can(\"edit\", () => {\n\t\t\t\t$.create({\n\t\t\t\t\tclassName: \"mv-item-controls mv-ui\",\n\t\t\t\t\tcontents: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttitle: \"Delete this \" + this.name,\n\t\t\t\t\t\t\tclassName: \"delete\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\"click\": evt => this.delete(item)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttitle: `Add new ${this.name.replace(/s$/i, \"\")} ${this.bottomUp? \"after\" : \"before\"}`,\n\t\t\t\t\t\t\tclassName: \"add\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\"click\": evt => this.add(null, this.items.indexOf(item)).edit()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\tinside: element\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Unit} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Unit.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (index in this.items) {\n\t\t\tif (this.bottomUp) {\n\t\t\t\tindex++;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t}\n\n\t\tif (!item.element.parentNode) {\n\t\t\t// Add it to the DOM, if not already in\n\t\t\tvar nextItem = this.items[index];\n\n\t\t\titem.element._.before(nextItem && nextItem.element || this.marker);\n\t\t}\n\n\t\t// Update internal data model\n\t\tthis.items.splice(index, 0, item);\n\n\t\tfor (let i = index - 1; i < this.length; i++) {\n\t\t\tlet item = this.items[i];\n\n\t\t\tif (item) {\n\t\t\t\titem.index = i;\n\n\t\t\t\tif (!o.silent) {\n\t\t\t\t\titem.element._.fire(\"mavo:datachange\", {\n\t\t\t\t\t\tnode: this,\n\t\t\t\t\t\tmavo: this.mavo,\n\t\t\t\t\t\taction: \"add\",\n\t\t\t\t\t\titem\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!o.silent) {\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t}\n\n\t\treturn item;\n\t},\n\n\tpropagate: function() {\n\t\tthis.items.forEach(item => item.call.apply(item, arguments));\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.items.splice(this.items.indexOf(item), 1);\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.element._.fire(\"mavo:datachange\", {\n\t\t\t\tnode: this,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\taction: \"delete\",\n\t\t\t\titem: item\n\t\t\t});\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\tedit: function() {\n\t\tthis.propagate(obj => obj[obj.preEdit? \"preEdit\" : \"edit\"]());\n\t},\n\n\t/**\n\t * Delete all items in the collection.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.element.remove) {\n\t\t\t\t\titem.element.remove();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Document fragment, remove all children\n\t\t\t\t\tfor (let node of item.element.childNodes) {\n\t\t\t\t\t\tnode => node.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.items = [];\n\n\t\t\tthis.marker._.fire(\"mavo:datachange\", {\n\t\t\t\tnode: this,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\taction: \"clear\"\n\t\t\t});\n\t\t}\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.items) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tdone: function() {\n\n\t},\n\n\tpropagated: [\"save\", \"done\"],\n\n\trevert: function() {\n\t\tfor (let item of this.items) {\n\t\t\t// Delete added items\n\t\t\tif (item.unsavedChanges) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Bring back deleted items\n\t\t\t\tif (item.deleted) {\n\t\t\t\t\titem.deleted = false;\n\t\t\t\t}\n\n\t\t\t\t// Revert all properties\n\t\t\t\titem.revert();\n\t\t\t}\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tthis.unhandled = {before: [], after: []};\n\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.items.forEach((item, i) => item.render(data && data[i]));\n\n\t\t\tif (data) {\n\t\t\t\tthis.unhandled.after = data.slice(this.items.length);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.clear();\n\n\t\t\t// Using document fragments improved rendering performance by 60%\n\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\tdata.forEach((datum, i) => {\n\t\t\t\tvar item = this.createItem();\n\n\t\t\t\titem.render(datum);\n\n\t\t\t\tthis.items.push(item);\n\t\t\t\titem.index = i;\n\n\t\t\t\tfragment.appendChild(item.element);\n\t\t\t});\n\n\t\t\tthis.marker.parentNode.insertBefore(fragment, this.marker);\n\t\t}\n\n\t\tthis.save();\n\t},\n\n\tfind: function(property) {\n\t\tvar items = this.items.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has data-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\tthis.mavo.needsEdit = true;\n\n\t\t\t\tthis.required = this.templateElement.matches(Mavo.selectors.required);\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = $.create(\"div\", {\n\t\t\t\t\thidden: true,\n\t\t\t\t\tclassName: \"mv-marker\",\n\t\t\t\t\tafter: this.templateElement\n\t\t\t\t});\n\n\t\t\t\tthis.templateElement.classList.add(\"mv-item\");\n\n\t\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\t\tthis.addButton._.before($.value(this.items[0], \"element\") || this.marker);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\n\t\t\t\t\t\tif (containerSelector) {\n\t\t\t\t\t\t\tvar after = this.marker.closest(containerSelector);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.addButton._.after(after && after.parentNode? after : this.marker);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"data-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.templateElement) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.item);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.add-${this.property}`;\n\t\t\tvar group = this.closestCollection || this.marker.closest(Mavo.selectors.group);\n\n\t\t\tif (group) {\n\t\t\t\tvar button = $$(selector, group).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.add().edit();\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}