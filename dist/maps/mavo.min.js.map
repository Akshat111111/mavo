{"version":3,"sources":["mavo.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","$$","_","self","Mavo","Class","constructor","element","_this","this","treeBuilt","defer","index","all","push","id","getAttribute","Node","getProperty","setAttribute","unhandled","classList","contains","autoEdit","has","storage","urlParam","source","test","Backend","create","permissions","Permissions","addEventListener","evt","keyCode","superKey","preventDefault","save","selectors","primitive","forEach","isGroup","not","formControl","property","is","Primitive","getValueAttribute","ui","bar","className","start","status","inside","authControls","can","loginHash","login","tag","href","textContent","events","click","after","location","hash","history","replaceState","document","title","URL","window","remove","unbind","backend","innerHTML","contents","name","e","logout","needsEdit","hooks","run","root","Group","resolve","setUnsavedChanges","onchange","_ref","action","value","toggle","edit","onclick","editing","done","mouseenter focus","add","mouseleave blur","revert","disabled","unsavedChanges","clear","appendChild","cannot","read","load","on","fire","off","debouncedSave","debounce","callback","node","saved","requestAnimationFrame","removeEventListener","data","getData","o","toJSON","arguments","undefined","render","context","confirm","store","target","matches","item","closest","type","parent","parentNode","walk","obj","_this2","inProgress","ready","then","get","err","Promise","reject","response","JSON","parse","xhr","console","error","log","stack","_this3","put","file","dataString","lastSaved","Date","now","live","toggleAttribute","static","navigator","platform","indexOf","init","container","filter","map","Hooks","s","specificProperty","group","multiple","option","li","tr","dt","dd","selector","split","join","or","selector1","selector2","and","ret","s1","apply","s2","andNot","extend","rootGroup","output","autoMultiple","include","Intl","documentElement","Stretchy","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function ($, $$) {\n\n\"use strict\";\n\nvar _ = self.Mavo = $.Class({\n\tconstructor: function (element) {\n\t\tthis.treeBuilt = Mavo.defer();\n\n\t\t// Index among other mavos in the page, 1 is first\n\t\tthis.index = _.all.push(this);\n\n\t\t// Assign a unique (for the page) id to this mavo instance\n\t\tthis.id = element.getAttribute(\"data-mavo\") || Mavo.Node.getProperty(element) || element.id || `mavo${this.index}`;\n\t\telement.setAttribute(\"data-mavo\", this.id);\n\n\t\tthis.unhandled = element.classList.contains(\"mv-keep-unhandled\");\n\t\tthis.autoEdit = _.has(\"mv-autoedit\", element);\n\n\t\tthis.element = element;\n\n\t\tif (this.index == 1) {\n\t\t\tthis.storage = _.urlParam(\"store\");\n\t\t\tthis.source = _.urlParam(\"source\");\n\t\t}\n\n\t\tthis.storage = this.storage || _.urlParam(`${this.id}_store`) || element.getAttribute(\"data-store\") || null;\n\t\tthis.source = this.source || _.urlParam(`${this.id}_source`) || element.getAttribute(\"data-source\") || null;\n\n\t\tif (this.storage && !/^\\s*none\\s*$/i.test(this.storage)) {\n\t\t\tthis.storage = _.Backend.create(this.storage, this);\n\t\t}\n\n\t\tif (this.source) {\n\t\t\tthis.source = _.Backend.create(this.source, this);\n\t\t}\n\n\t\tthis.permissions = this.storage ? this.storage.permissions : new Mavo.Permissions();\n\n\t\t// Ctrl + S or Cmd + S to save\n\t\tthis.element.addEventListener(\"keydown\", evt => {\n\t\t\tif (evt.keyCode == 83 && evt[_.superKey]) {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.save();\n\t\t\t}\n\t\t});\n\n\t\tthis.element.setAttribute(\"typeof\", \"\");\n\n\t\t// Apply heuristic for groups\n\t\t$$(_.selectors.primitive, element).forEach(element => {\n\t\t\tvar isGroup = $(`${_.selectors.not(_.selectors.formControl)}, ${_.selectors.property}`, element) && (// Contains other properties or non-form elements and...\n\t\t\t                Mavo.is(\"multiple\", element) || // is a collection...\n\t\t\t                Mavo.Primitive.getValueAttribute(element) === null  // ...or its content is not in an attribute\n\t\t\t\t\t\t);\n\n\t\t\tif (isGroup) {\n\t\t\t\telement.setAttribute(\"typeof\", \"\");\n\t\t\t}\n\t\t});\n\n\t\tthis.ui = {\n\t\t\tbar: $(\".mv-bar\", this.element) || $.create({\n\t\t\t\tclassName: \"mv-bar mv-ui\",\n\t\t\t\tstart: this.element\n\t\t\t})\n\t\t};\n\n\t\tthis.ui.status = $(\".mv-status\", this.ui.bar) || $.create(\"span\", {\n\t\t\tclassName: \"mv-status\",\n\t\t\tinside: this.ui.bar\n\t\t});\n\n\t\tif (this.storage) {\n\t\t\t// Reflect backend permissions in global permissions\n\t\t\tthis.authControls = {};\n\n\t\t\tthis.permissions.can(\"login\", () => {\n\t\t\t\t// #login authenticates if only 1 mavo on the page, or if the first.\n\t\t\t\t// Otherwise, we have to generate a slightly more complex hash\n\t\t\t\tthis.loginHash = \"#login\" + (Mavo.all[0] === this? \"\" : \"-\" + this.id);\n\n\t\t\t\tthis.authControls.login = $.create({\n\t\t\t\t\ttag: \"a\",\n\t\t\t\t\thref: this.loginHash,\n\t\t\t\t\ttextContent: \"Login\",\n\t\t\t\t\tclassName: \"mv-login mv-button\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: evt => {\n\t\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\t\tthis.storage.login();\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tafter: $(\".mv-status\", this.ui.bar)\n\t\t\t\t});\n\n\t\t\t\t// We also support a hash to trigger login, in case the user doesn't want visible login UI\n\t\t\t\tvar login;\n\t\t\t\t(login = () => {\n\t\t\t\t\tif (location.hash === this.loginHash) {\n\t\t\t\t\t\t// This just does location.hash = \"\" without getting a pointless # at the end of the URL\n\t\t\t\t\t\thistory.replaceState(null, document.title, new URL(\"\", location) + \"\");\n\t\t\t\t\t\tthis.storage.login();\n\t\t\t\t\t}\n\t\t\t\t})();\n\t\t\t\twindow.addEventListener(\"hashchange.mavo\", login);\n\t\t\t}, () => {\n\t\t\t\t$.remove(this.authControls.login);\n\t\t\t\tthis.element._.unbind(\"hashchange.mavo\");\n\t\t\t});\n\n\t\t\t// Update login status\n\t\t\tthis.element.addEventListener(\"mavo:login.mavo\", evt => {\n\t\t\t\tif (evt.backend == this.storage) { // ignore logins from source backend\n\t\t\t\t\tvar status = $(\".mv-status\", this.ui.bar);\n\t\t\t\t\tstatus.innerHTML = \"\";\n\t\t\t\t\tstatus._.contents([\n\t\t\t\t\t\t\"Logged in to \" + evt.backend.id + \" as \",\n\t\t\t\t\t\t{tag: \"strong\", innerHTML: evt.name},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttextContent: \"Logout\",\n\t\t\t\t\t\t\tclassName: \"mv-logout\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\tclick: e => evt.backend.logout()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}\n\t\t\t\t\t]);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.element.addEventListener(\"mavo:logout.mavo\", evt => {\n\t\t\t\t$(\".mv-status\", this.ui.bar).textContent = \"\";\n\t\t\t});\n\t\t}\n\n\t\t// Is there any control that requires an edit button?\n\t\tthis.needsEdit = false;\n\n\t\t// Build mavo objects\n\t\tMavo.hooks.run(\"init-tree-before\", this);\n\n\t\tthis.root = new Mavo.Group(this.element, this);\n\t\tthis.treeBuilt.resolve();\n\n\t\tMavo.hooks.run(\"init-tree-after\", this);\n\n\t\tthis.setUnsavedChanges(false);\n\n\t\tthis.permissions.onchange(({action, value}) => {\n\t\t\tthis.element.classList.toggle(`mv-can-${action}`, !!value);\n\t\t});\n\n\t\tthis.permissions.can([\"edit\", \"add\", \"delete\"], () => {\n\t\t\tthis.ui.edit = $.create(\"button\", {\n\t\t\t\tclassName: \"mv-edit\",\n\t\t\t\ttextContent: \"Edit\",\n\t\t\t\tonclick: e => this.editing? this.done() : this.edit(),\n\t\t\t\tinside: this.ui.bar\n\t\t\t});\n\n\t\t\tif (this.autoEdit) {\n\t\t\t\tthis.element.addEventListener(\"mavo:load\", evt => this.ui.edit.click());\n\t\t\t}\n\t\t}, () => { // cannot\n\t\t\t$.remove(this.ui.edit);\n\n\t\t\tif (this.editing) {\n\t\t\t\tthis.done();\n\t\t\t}\n\t\t});\n\n\t\tif (this.needsEdit) {\n\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\tthis.ui.save = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-save\",\n\t\t\t\t\ttextContent: \"Save\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.save(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tthis.element.classList.add(\"mv-save-hovered\");\n\t\t\t\t\t\t\tthis.setUnsavedChanges();\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.element.classList.remove(\"mv-save-hovered\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\n\t\t\t\tthis.ui.revert = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-revert\",\n\t\t\t\t\ttextContent: \"Revert\",\n\t\t\t\t\tdisabled: true,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.revert(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tif (!this.unsavedChanges) {\n\t\t\t\t\t\t\t\tthis.element.classList.add(\"mv-revert-hovered\");\n\t\t\t\t\t\t\t\tthis.setUnsavedChanges();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.element.classList.remove(\"mv-revert-hovered\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\t\t\t}, () => {\n\t\t\t\t$.remove([this.ui.save, this.ui.revert]);\n\t\t\t\tthis.ui.save = this.ui.revert = null;\n\t\t\t});\n\t\t}\n\n\t\tthis.permissions.can(\"delete\", () => {\n\t\t\tthis.ui.clear = $.create(\"button\", {\n\t\t\t\tclassName: \"mv-clear\",\n\t\t\t\ttextContent: \"Clear\",\n\t\t\t\tonclick: e => this.clear()\n\t\t\t});\n\n\t\t\tthis.ui.bar.appendChild(this.ui.clear);\n\t\t});\n\n\t\tthis.permissions.cannot([\"delete\", \"edit\"], () => {\n\t\t\t$.remove(this.ui.clear);\n\t\t});\n\n\t\tif (this.storage || this.source) {\n\t\t\t// Fetch existing data\n\t\t\tif (!this.storage) {\n\t\t\t\tthis.source.permissions.can(\"read\", () => this.permissions.read = true);\n\t\t\t}\n\n\t\t\tthis.permissions.can(\"read\", () => this.load());\n\t\t}\n\t\telse {\n\t\t\t// No storage\n\t\t\tthis.permissions.on([\"read\", \"edit\"]);\n\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t}\n\n\t\tif (!this.needsEdit) {\n\t\t\tthis.permissions.off([\"edit\", \"add\", \"delete\"]);\n\n\t\t\t// If there's no edit mode, we must save immediately when properties change\n\t\t\tthis.element.addEventListener(\"mavo:load\", evt => {\n\t\t\t\tvar debouncedSave = _.debounce(() => {\n\t\t\t\t\tthis.save();\n\t\t\t\t}, 1000);\n\n\t\t\t\tvar callback = evt => {\n\t\t\t\t\tif (evt.node.saved) {\n\t\t\t\t\t\tdebouncedSave();\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\t\t\tthis.element.addEventListener(\"mavo:datachange\", callback);\n\t\t\t\t\t}, () => {\n\t\t\t\t\t\tthis.element.removeEventListener(\"mavo:datachange\", callback);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tMavo.hooks.run(\"init-end\", this);\n\t},\n\n\tget editing() {\n\t\treturn this.root.editing;\n\t},\n\n\tget data() {\n\t\treturn this.getData();\n\t},\n\n\tgetData: function(o) {\n\t\treturn this.root.getData(o);\n\t},\n\n\ttoJSON: function(data = this.data) {\n\t\treturn _.toJSON(data);\n\t},\n\n\trender: function(data) {\n\t\t_.hooks.run(\"render-start\", {context: this, data});\n\n\t\tif (data) {\n\t\t\tif (this.editing) { // TODO this logic should go to Node\n\t\t\t\tthis.done();\n\t\t\t\tthis.root.render(data);\n\t\t\t\tthis.edit();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.root.render(data);\n\t\t\t}\n\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tclear: function() {\n\t\tif (confirm(\"This will delete all your data. Are you sure?\")) {\n\t\t\tthis.store(null);\n\t\t\tthis.root.clear();\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.root.edit();\n\n\t\t$.events(this.element, \"mouseenter.mavo:edit mouseleave.mavo:edit\", evt => {\n\t\t\tif (evt.target.matches(\".mv-item-controls .mv-delete\")) {\n\t\t\t\tvar item = evt.target.closest(_.selectors.item);\n\t\t\t\titem.classList.toggle(\"mv-delete-hover\", evt.type == \"mouseenter\");\n\t\t\t}\n\n\t\t\tif (evt.target.matches(_.selectors.item)) {\n\t\t\t\tevt.target.classList.remove(\"mv-has-hovered-item\");\n\n\t\t\t\tvar parent = evt.target.parentNode.closest(_.selectors.item);\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tparent.classList.toggle(\"mv-has-hovered-item\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\t\t}, true);\n\n\t\tthis.setUnsavedChanges();\n\t},\n\n\t/**\n\t * Set this mavo instance’s unsavedChanges flag.\n\t * @param {Boolean} [value]\n\t *        If true, just sets the flag to true, no traversal.\n\t *        If false, sets the flag of the Mavo instance and every tree node to false\n\t *        If not provided, traverses the tree and recalculates the flag value.\n\t */\n\tsetUnsavedChanges: function(value) {\n\t\tvar unsavedChanges = !!value;\n\n\t\tif (!value) {\n\t\t\tthis.walk(obj => {\n\t\t\t\tif (obj.unsavedChanges) {\n\t\t\t\t\tunsavedChanges = true;\n\n\t\t\t\t\tif (value === false) {\n\t\t\t\t\t\tobj.unsavedChanges = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this.unsavedChanges = unsavedChanges;\n\t},\n\n\t// Conclude editing\n\tdone: function() {\n\t\tthis.root.done();\n\t\t$.unbind(this.element, \".mavo:edit\");\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t/**\n\t * load - Fetch data from source and render it.\n\t *\n\t * @return {Promise}  A promise that resolves when the data is loaded.\n\t */\n\tload: function() {\n\t\tthis.inProgress = \"Loading\";\n\n\t\tvar backend = this.storage || this.source;\n\n\t\treturn backend.ready.then(() => backend.get())\n\t\t.catch(err => {\n\t\t\t// Try again with source\n\t\t\tif (this.source && backend !== this.source) {\n\t\t\t\treturn this.source.ready.then(() => this.source.get());\n\t\t\t}\n\n\t\t\treturn Promise.reject(err);\n\t\t})\n\t\t.then(response => {\n\t\t\tif (response && $.type(response) == \"string\") {\n\t\t\t\tresponse = JSON.parse(response);\n\t\t\t}\n\n\t\t\tthis.render(response);\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tif (err.xhr && err.xhr.status == 404) {\n\t\t\t\t\tthis.render(\"\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// TODO display error to user\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t\tconsole.log(err.stack);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t});\n\t},\n\n\tstore: function() {\n\t\tif (!this.storage) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.inProgress = \"Saving\";\n\n\t\tthis.storage.login()\n\t\t.then(() => this.storage.put())\n\t\t.then(file => {\n\t\t\t$.fire(this.element, \"mavo:save\", {\n\t\t\t\tdata: file.data,\n\t\t\t\tdataString: file.dataString\n\t\t\t});\n\n\t\t\tthis.lastSaved = Date.now();\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tconsole.error(err);\n\t\t\t\tconsole.log(err.stack);\n\t\t\t}\n\t\t})\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t});\n\t},\n\n\tsave: function() {\n\t\tthis.root.save();\n\n\t\tthis.store();\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\trevert: function() {\n\t\tthis.root.revert();\n\t},\n\n\twalk: function(callback) {\n\t\tthis.root.walk(callback);\n\t},\n\n\tlive: {\n\t\tinProgress: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"data-mv-progress\", value, value);\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tthis.element.classList.toggle(\"mv-unsaved-changes\", value);\n\n\t\t\tif (this.ui && this.ui.save) {\n\t\t\t\tthis.ui.save.disabled = !value;\n\t\t\t\tthis.ui.revert.disabled = !value;\n\t\t\t}\n\t\t},\n\n\t\tneedsEdit: function(value) {\n\t\t\t$.toggleAttribute(this.ui.bar, \"hidden\", \"\", !value);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: [],\n\n\t\tsuperKey: navigator.platform.indexOf(\"Mac\") === 0? \"metaKey\" : \"ctrlKey\",\n\n\t\tinit: function(container) {\n\t\t\treturn $$(_.selectors.init, container || document)\n\t\t\t\t.filter(element => !element.parentNode.closest(_.selectors.init))\n\t\t\t\t.map(element => new _(element));\n\t\t},\n\n\t\thooks: new $.Hooks()\n\t}\n});\n\n{\n\nlet s = _.selectors = {\n\tinit: \".mavo, [mavo], [data-mavo], [data-store]\",\n\tproperty: \"[property], [itemprop]\",\n\tspecificProperty: name => `[property=${name}], [itemprop=${name}]`,\n\tgroup: \"[typeof], [itemscope], [itemtype], .mv-group\",\n\tmultiple: \"[multiple], [data-multiple], .mv-multiple\",\n\tformControl: \"input, select, option, textarea\",\n\titem: \".mv-item\",\n\tui: \".mv-ui\",\n\toption: name => `[${name}], [data-${name}], .${name}`,\n\tcontainer: {\n\t\t\"li\": \"ul, ol\",\n\t\t\"tr\": \"table\",\n\t\t\"option\": \"select\",\n\t\t\"dt\": \"dl\",\n\t\t\"dd\": \"dl\"\n\t}\n};\n\nlet arr = s.arr = selector => selector.split(/\\s*,\\s*/g);\nlet not = s.not = selector => arr(selector).map(s => `:not(${s})`).join(\"\");\nlet or = s.or = (selector1, selector2) => selector1 + \", \" + selector2;\nlet and = s.and = (selector1, selector2) => {\n\tvar ret = [], arr2 = arr(selector2);\n\n\tarr(selector1).forEach(s1 => ret.push(...arr2.map(s2 => s1 + s2)));\n\n\treturn ret.join(\", \");\n};\nlet andNot = s.andNot = (selector1, selector2) => and(selector1, not(selector2));\n\n$.extend(_.selectors, {\n\tprimitive: andNot(s.property, s.group),\n\trootGroup: andNot(s.group, s.property),\n\toutput: or(s.specificProperty(\"output\"), \".mv-output, .mv-value\"),\n\tautoMultiple: and(\"li, tr, option\", \":only-of-type\")\n});\n\n}\n\n// Init mavo\nPromise.all([\n\t$.ready(),\n\t$.include(Array.from && window.Intl && document.documentElement.closest, \"https://cdn.polyfill.io/v2/polyfill.min.js?features=blissfuljs,Intl.~locale.en\")\n])\n.catch(err => console.error(err))\n.then(() => Mavo.init());\n\nStretchy.selectors.filter = \".mv-editor:not([property])\";\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}