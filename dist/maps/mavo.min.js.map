{"version":3,"sources":["expressions.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","_typeof","Symbol","iterator","obj","constructor","$","$$","_","Mavo","Expressions","Class","mavo","_this","this","expressions","syntax","Expression","Syntax","create","element","closest","traverse","undefined","scheduled","Set","treeBuilt","then","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","next","done","et","value","group","Node","get","selectors","push","mavoNode","Primitive","attribute","primitive","store","modes","err","addEventListener","evt","action","node","closestCollection","has","property","setTimeout","update","PROPERTYCHANGE_THROTTLE","add","requestAnimationFrame","_this2","root","Element","rootGroup","data","getData","relative","null","unhandled","walk","path","Group","isDeleted","env","context","apply","concat","hooks","run","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","changedBy","extract","name","directives","indexOf","test","textContent","Text","slice","split","map","_this3","arguments","nodeType","normalize","ESCAPE","is","attributes","forEach","childNodes","child","static","self","Proxy","_this4","options","proxy","index","id","ret","walkUp","children","find","item","filter","set","Error","_this5","template","Bliss","getValueAttribute","fallback","getValue","expression","getAttribute","parsed","start","end"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Expressions = $.Class({\n\tconstructor: function(mavo) {\n\t\tthis.mavo = mavo;\n\n\t\tthis.expressions = [];\n\n\t\tvar syntax = Mavo.Expression.Syntax.create(this.mavo.element.closest(\"[mv-expressions]\")) || Mavo.Expression.Syntax.default;\n\t\tthis.traverse(this.mavo.element, undefined, syntax);\n\n\t\tthis.scheduled = new Set();\n\n\t\t// Watch changes and update value\n\t\tthis.mavo.treeBuilt.then(() => {\n\t\t\tfor (let et of this.expressions) {\n\t\t\t\tet.group = Mavo.Node.get(et.element.closest(Mavo.selectors.group));\n\t\t\t\tet.group.expressions = et.group.expressions || [];\n\t\t\t\tet.group.expressions.push(et);\n\n\t\t\t\tvar mavoNode = Mavo.Node.get(et.element, true);\n\n\t\t\t\tif (mavoNode && mavoNode instanceof Mavo.Primitive && mavoNode.attribute == et.attribute) {\n\t\t\t\t\tet.primitive = mavoNode;\n\t\t\t\t\tmavoNode.store = mavoNode.store || \"none\";\n\t\t\t\t\tmavoNode.modes = \"read\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.mavo.element.addEventListener(\"mavo:datachange\", evt => {\n\t\t\t\tif (evt.action == \"propertychange\" && evt.node.closestCollection) {\n\t\t\t\t\t// Throttle propertychange events in collections\n\t\t\t\t\tif (!this.scheduled.has(evt.property)) {\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tthis.scheduled.delete(evt.property);\n\t\t\t\t\t\t\tthis.update(evt);\n\t\t\t\t\t\t}, _.PROPERTYCHANGE_THROTTLE);\n\n\t\t\t\t\t\tthis.scheduled.add(evt.property);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\trequestAnimationFrame(() => this.update(evt));\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.update();\n\t\t});\n\t},\n\n\tupdate: function callee(evt) {\n\t\tvar root = this.mavo.element;\n\n\t\tif (evt instanceof Element) {\n\t\t\troot = evt.closest(Mavo.selectors.group);\n\t\t\tevt = null;\n\t\t}\n\n\t\tvar rootGroup = Mavo.Node.get(root);\n\n\t\tvar data = rootGroup.getData({\n\t\t\trelative: true,\n\t\t\tstore: \"*\",\n\t\t\tnull: true,\n\t\t\tunhandled: this.mavo.unhandled\n\t\t});\n\n\t\trootGroup.walk((obj, path) => {\n\t\t\tif (obj instanceof Mavo.Group && obj.expressions && obj.expressions.length && !obj.isDeleted()) {\n\t\t\t\tlet env = { context: this, data: $.value(data, ...path) };\n\n\t\t\t\tMavo.hooks.run(\"expressions-update-start\", env);\n\n\t\t\t\tfor (let et of obj.expressions) {\n\t\t\t\t\tif (et.changedBy(evt)) {\n\t\t\t\t\t\tet.update(env.data, evt);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\textract: function(node, attribute, path, syntax) {\n\t\tif (attribute && attribute.name == \"mv-expressions\") {\n\t\t\treturn;\n\t\t}\n\n\t\tif ((attribute && _.directives.indexOf(attribute.name) > -1) ||\n\t\t    syntax.test(attribute? attribute.value : node.textContent)\n\t\t) {\n\t\t\tthis.expressions.push(new Mavo.Expression.Text({\n\t\t\t\tnode, syntax,\n\t\t\t\tpath: path? path.slice(1).split(\"/\").map(i => +i) : [],\n\t\t\t\tattribute: attribute && attribute.name,\n\t\t\t\tmavo: this.mavo\n\t\t\t}));\n\t\t}\n\t},\n\n\t// Traverse an element, including attribute nodes, text nodes and all descendants\n\ttraverse: function(node, path = \"\", syntax) {\n\t\tif (node.nodeType === 8) {\n\t\t\t// We don't want expressions to be picked up from comments!\n\t\t\t// Commenting stuff out is a common debugging technique\n\t\t\treturn;\n\t\t}\n\n\t\tif (node.nodeType === 3) { // Text node\n\t\t\t// Leaf node, extract references from content\n\t\t\tthis.extract(node, null, path, syntax);\n\t\t}\n\t\telse {\n\t\t\tnode.normalize();\n\n\t\t\tsyntax = Mavo.Expression.Syntax.create(node) || syntax;\n\n\t\t\tif (syntax === Mavo.Expression.Syntax.ESCAPE) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (Mavo.is(\"group\", node)) {\n\t\t\t\tpath = \"\";\n\t\t\t}\n\n\t\t\t$$(node.attributes).forEach(attribute => this.extract(node, attribute, path, syntax));\n\t\t\t$$(node.childNodes).forEach((child, i) => this.traverse(child, `${path}/${i}`, syntax));\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdirectives: [],\n\n\t\tPROPERTYCHANGE_THROTTLE: 50\n\t}\n});\n\nif (self.Proxy) {\n\tMavo.hooks.add(\"node-getdata-end\", function(env) {\n\t\tif (env.options.relative && env.data && typeof env.data === \"object\") {\n\t\t\tenv.data = new Proxy(env.data, {\n\t\t\t\tget: (data, property, proxy) => {\n\t\t\t\t\t// Checking if property is in proxy might add it to the data\n\t\t\t\t\tif (property in data || (property in proxy && property in data)) {\n\t\t\t\t\t\treturn data[property];\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == \"$index\") {\n\t\t\t\t\t\treturn this.index + 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == this.mavo.id) {\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\thas: (data, property) => {\n\t\t\t\t\tif (property in data) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Property does not exist, look for it elsewhere\n\n\t\t\t\t\tif (property == \"$index\" || property == this.mavo.id) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// First look in ancestors\n\t\t\t\t\tvar ret = this.walkUp(group => {\n\t\t\t\t\t\tif (property in group.children) {\n\t\t\t\t\t\t\treturn group.children[property];\n\t\t\t\t\t\t};\n\t\t\t\t\t});\n\n\t\t\t\t\tif (ret === undefined) {\n\t\t\t\t\t\t// Still not found, look in descendants\n\t\t\t\t\t\tret = this.find(property);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (ret !== undefined) {\n\t\t\t\t\t\tif (Array.isArray(ret)) {\n\t\t\t\t\t\t\tret = ret.map(item => item.getData(env.options))\n\t\t\t\t\t\t\t\t\t .filter(item => item !== null);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (ret instanceof Mavo.Node) {\n\t\t\t\t\t\t\tret = ret.getData(env.options);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdata[property] = ret;\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\n\t\t\t\tset: function(data, property, value) {\n\t\t\t\t\tthrow Error(\"You can’t set data via expressions.\");\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n}\n\nMavo.hooks.add(\"init-tree-before\", function() {\n\tthis.expressions = new Mavo.Expressions(this);\n});\n\n// Must be on start so that collections don't have a marker yet which messes up paths\nMavo.hooks.add(\"group-init-start\", function() {\n\tvar template = this.template;\n\n\tif (template && template.expressions) {\n\t\t// We know which expressions we have, don't traverse again\n\t\tthis.expressions = template.expressions.map(et => new Mavo.Expression.Text({\n\t\t\ttemplate: et,\n\t\t\tgroup: this,\n\t\t\tmavo: this.mavo\n\t\t}));\n\t}\n});\n\n// TODO what about granular rendering?\nMavo.hooks.add(\"render-end\", function() {\n\tthis.expressions.update();\n});\n\nMavo.hooks.add(\"collection-add-end\", function(env) {\n\tthis.mavo.expressions.update(env.item.element);\n});\n\n})(Bliss, Bliss.$);\n\n// mv-value plugin\nMavo.attributes.push(\"mv-value\");\nMavo.Expressions.directives.push(\"mv-value\");\n\nMavo.hooks.add(\"expressiontext-init-start\", function() {\n\tif (this.attribute == \"mv-value\") {\n\t\tthis.attribute = Mavo.Primitive.getValueAttribute(this.element);\n\t\tthis.fallback = this.fallback || Mavo.Primitive.getValue(this.element, {attribute: this.attribute});\n\t\tthis.expression = this.element.getAttribute(\"mv-value\");\n\n\t\tthis.parsed = [new Mavo.Expression(this.expression)];\n\t\tthis.expression = this.syntax.start + this.expression + this.syntax.end;\n\t}\n});\n"],"sourceRoot":"/source/"}