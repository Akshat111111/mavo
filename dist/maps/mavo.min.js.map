{"version":3,"sources":["expressiontext.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","_","Mavo","Expression","Text","Class","constructor","o","arguments","undefined","this","mavo","template","_arr","_i","prop","node","path","reduce","index","childNodes","group","element","attribute","hooks","run","expression","nodeType","parentNode","children","normalize","getAttribute","trim","firstChild","whitespace","textContent","match","splitText","after","lastChild","insertBefore","parsed","syntax","tokenize","oldValue","value","map","x","elements","set","concat","get","changedBy","evt","every","expr","update","_this","data","ret","env","context","eval","Error","fallback","presentational","join","Primitive","formatNumber","primitive","datatype","setValue","static","WeakMap","search","all","filter","et","add","expressionText","store","modes","item","itemTemplate","expressions","push","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($) {\n\nvar _ = Mavo.Expression.Text = $.Class({\n\tconstructor: function(o = {}) {\n\t\tthis.mavo = o.mavo;\n\t\tthis.template = o.template && o.template.template || o.template;\n\n\t\tfor (let prop of [\"group\", \"path\", \"syntax\", \"fallback\", \"attribute\"]) {\n\t\t\tthis[prop] = o[prop] === undefined && this.template? this.template[prop] : o[prop];\n\t\t}\n\n\t\tthis.node = o.node;\n\n\t\tif (!this.node) {\n\t\t\t// No node provided, figure it out from path\n\t\t\tthis.node = this.path.reduce((node, index) => {\n\t\t\t\treturn node.childNodes[index];\n\t\t\t}, this.group.element);\n\t\t}\n\n\t\tthis.element = this.node;\n\t\tthis.attribute = this.attribute || null;\n\n\t\tMavo.hooks.run(\"expressiontext-init-start\", this);\n\n\t\tif (!this.expression) { // Still unhandled?\n\t\t\tif (this.node.nodeType === 3) {\n\t\t\t\tthis.element = this.node.parentNode;\n\n\t\t\t\t// If no element siblings make this.node the element, which is more robust\n\t\t\t\t// Same if attribute, there are no attributes on a text node!\n\t\t\t\tif (!this.node.parentNode.children.length || this.attribute) {\n\t\t\t\t\tthis.node = this.element;\n\t\t\t\t\tthis.element.normalize();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.attribute) {\n\t\t\t\tthis.expression = this.node.getAttribute(this.attribute).trim();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Move whitespace outside to prevent it from messing with types\n\t\t\t\tthis.node.normalize();\n\n\t\t\t\tif (this.node.firstChild && this.node.childNodes.length === 1 && this.node.firstChild.nodeType === 3) {\n\t\t\t\t\tvar whitespace = this.node.firstChild.textContent.match(/^\\s*|\\s*$/g);\n\n\t\t\t\t\tif (whitespace[1]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(this.node.firstChild.textContent.length - whitespace[1].length);\n\t\t\t\t\t\t$.after(this.node.lastChild, this.node);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (whitespace[0]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(whitespace[0].length);\n\t\t\t\t\t\tthis.node.parentNode.insertBefore(this.node.firstChild, this.node);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.expression = this.node.textContent;\n\t\t\t}\n\n\n\t\t\tthis.parsed = o.template? o.template.parsed : this.syntax.tokenize(this.expression);\n\t\t}\n\n\t\tthis.oldValue = this.value = this.parsed.map(x => x instanceof Mavo.Expression? x.expression : x);\n\n\t\tMavo.hooks.run(\"expressiontext-init-end\", this);\n\n\t\t_.elements.set(this.element, [...(_.elements.get(this.element) || []), this]);\n\t},\n\n\tchangedBy: function(evt) {\n\t\treturn !this.parsed.every(expr => !(expr instanceof Mavo.Expression) || !expr.changedBy(evt));\n\t},\n\n\tupdate: function(data = this.data, evt) {\n\t\tthis.data = data;\n\n\t\tvar ret = {};\n\n\t\tMavo.hooks.run(\"expressiontext-update-start\", this);\n\n\t\tthis.oldValue = this.value;\n\n\t\tret.value = this.value = this.parsed.map((expr, i) => {\n\t\t\tif (expr instanceof Mavo.Expression) {\n\n\t\t\t\tif (expr.changedBy(evt)) {\n\t\t\t\t\tvar env = {context: this, expr};\n\n\t\t\t\t\tMavo.hooks.run(\"expressiontext-update-beforeeval\", env);\n\n\t\t\t\t\tenv.value = env.expr.eval(data);\n\n\t\t\t\t\tMavo.hooks.run(\"expressiontext-update-aftereval\", env);\n\n\t\t\t\t\tif (env.value instanceof Error) {\n\t\t\t\t\t\treturn this.fallback !== undefined? this.fallback : env.expr.expression;\n\t\t\t\t\t}\n\t\t\t\t\tif (env.value === undefined || env.value === null) {\n\t\t\t\t\t\t// Donâ€™t print things like \"undefined\" or \"null\"\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn env.value;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn this.oldValue[i];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn expr;\n\t\t});\n\n\t\tif (!this.attribute) {\n\t\t\t// Separate presentational & actual values only apply when content is variable\n\t\t\tret.presentational = this.value.map(value => {\n\t\t\t\tif (Array.isArray(value)) {\n\t\t\t\t\treturn value.join(\", \");\n\t\t\t\t}\n\n\t\t\t\tif (typeof value == \"number\") {\n\t\t\t\t\treturn Mavo.Primitive.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t});\n\n\t\t\tret.presentational = ret.presentational.length === 1? ret.presentational[0] : ret.presentational.join(\"\");\n\t\t}\n\n\t\tret.value = ret.value.length === 1? ret.value[0] : ret.value.join(\"\");\n\n\t\tif (this.primitive && this.parsed.length === 1) {\n\t\t\tif (typeof ret.value === \"number\") {\n\t\t\t\tthis.primitive.datatype = \"number\";\n\t\t\t}\n\t\t\telse if (typeof ret.value === \"boolean\") {\n\t\t\t\tthis.primitive.datatype = \"boolean\";\n\t\t\t}\n\t\t}\n\n\t\tif (ret.presentational === ret.value) {\n\t\t\tret = ret.value;\n\t\t}\n\n\t\tif (this.primitive) {\n\t\t\tthis.primitive.value = ret;\n\t\t}\n\t\telse {\n\t\t\tMavo.Primitive.setValue(this.node, ret, {attribute: this.attribute});\n\t\t}\n\n\t\tMavo.hooks.run(\"expressiontext-update-end\", this);\n\t},\n\n\tstatic: {\n\t\telements: new WeakMap(),\n\n\t\t/**\n\t\t * Search for Mavo.Expression.Text object(s) associated with a given element\n\t\t * and optionally an attribute.\n\t\t *\n\t\t * @return If one argument, array of matching Expression.Text objects.\n\t\t *         If two arguments, the matching Expression.Text object or null\n\t\t */\n\t\tsearch: function(element, attribute) {\n\t\t\tvar all = _.elements.get(element) || [];\n\n\t\t\tif (arguments.length > 1) {\n\t\t\t\tif (!all.length) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn all.filter(et => et.attribute === attribute)[0] || null;\n\t\t\t}\n\n\t\t\treturn all;\n\t\t}\n\t}\n});\n\n// Link primitive with its expressionText object\nMavo.hooks.add(\"primitive-init-start\", function() {\n\tthis.expressionText = Mavo.Expression.Text.search(this.element, this.attribute);\n\n\tif (this.expressionText) {\n\t\tthis.expressionText.primitive = this;\n\t\tthis.store = this.store || \"none\";\n\t\tthis.modes = \"read\";\n\t}\n});\n\n// Fix expressions on primitive collections\nMavo.hooks.add(\"collection-add-end\", function(env) {\n\tif (env.item instanceof Mavo.Primitive && this.itemTemplate) {\n\t\tvar et = Mavo.Expression.Text.search(this.itemTemplate.element)[0];\n\n\t\tif (et) {\n\t\t\tet.group.expressions.push(new Mavo.Expression.Text({\n\t\t\t\tnode: env.item.element,\n\t\t\t\ttemplate: et,\n\t\t\t\tmavo: this.mavo\n\t\t\t}));\n\t\t}\n\t}\n});\n\n})(Bliss);\n"],"sourceRoot":"/source/"}