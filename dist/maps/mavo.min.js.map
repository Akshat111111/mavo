{"version":3,"sources":["collection.js"],"names":["$","$$","Mavo","Collection","Class","extends","Node","constructor","element","mavo","o","this","templateElement","items","fromTemplate","properties","selectors","property","map","getProperty","mutable","matches","multiple","cloneNode","item","createItem","add","itemTemplate","template","hooks","run","length","containsTemplate","getData","data","forEach","deleted","itemData","push","dirty","unhandled","before","concat","after","_this","Unit","create","collection","type","permissions","can","className","contents","tag","title","name","events","click","evt","replace","bottomUp","indexOf","edit","inside","index","arguments","undefined","get","parentNode","nextItem","_","marker","splice","i","_item","silent","fire","node","action","unsavedChanges","propagate","_arguments","call","apply","delete","hard","_this2","remove","transition","opacity","then","style","required","placeholder","walk","obj","once","preEdit","clear","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","childNodes","Symbol","iterator","next","done","value","err","save","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","propagated","revert","_iteratorNormalCompletion4","_didIteratorError4","_iteratorError4","_step4","_iterator4","render","_this3","toArray","fragment","document","createDocumentFragment","datum","appendChild","insertBefore","slice","find","filter","ret","flatten","live","_mutable","needsEdit","hidden","classList","addButton","tagName","toLowerCase","containerSelector","container","closest","lazy","order","getAttribute","test","compareDocumentPosition","DOCUMENT_POSITION_FOLLOWING","closestCollection","parent","_this4","selector","scope","button","contains","textContent","addEventListener","preventDefault","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.items = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.items.length;\n\t},\n\n\t// Collection still contains its template as data\n\tget containsTemplate() {\n\t\treturn this.items.length && this.items[0].element === this.element;\n\t},\n\n\tgetData: function(o) {\n\t\to = o || {};\n\n\t\tvar data = [];\n\n\t\tthis.items.forEach(item => {\n\t\t\tif (!item.deleted) {\n\t\t\t\tvar itemData = item.getData(o);\n\n\t\t\t\tif (itemData) {\n\t\t\t\t\tdata.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (!o.dirty && this.unhandled) {\n\t\t\tdata = this.unhandled.before.concat(data, this.unhandled.after);\n\t\t}\n\n\t\treturn data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Unit.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type,\n\t\t\tdirty: true\n\t\t});\n\n\t\t// Add delete & add buttons\n\t\tif (this.mutable) {\n\t\t\tthis.mavo.permissions.can(\"edit\", () => {\n\t\t\t\t$.create({\n\t\t\t\t\tclassName: \"mv-item-controls mv-ui\",\n\t\t\t\t\tcontents: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttitle: \"Delete this \" + this.name,\n\t\t\t\t\t\t\tclassName: \"delete\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\"click\": evt => this.delete(item)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttitle: `Add new ${this.name.replace(/s$/i, \"\")} ${this.bottomUp? \"after\" : \"before\"}`,\n\t\t\t\t\t\t\tclassName: \"add\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\"click\": evt => this.add(null, this.items.indexOf(item)).edit()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\tinside: element\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Unit} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Unit.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (index in this.items) {\n\t\t\tif (this.bottomUp) {\n\t\t\t\tindex++;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t}\n\n\t\tif (!item.element.parentNode) {\n\t\t\t// Add it to the DOM, if not already in\n\t\t\tvar nextItem = this.items[index];\n\n\t\t\titem.element._.before(nextItem && nextItem.element || this.marker);\n\t\t}\n\n\t\t// Update internal data model\n\t\tthis.items.splice(index, 0, item);\n\n\t\tfor (let i = index - 1; i < this.length; i++) {\n\t\t\tlet item = this.items[i];\n\n\t\t\tif (item) {\n\t\t\t\titem.index = i;\n\n\t\t\t\tif (!o.silent) {\n\t\t\t\t\titem.element._.fire(\"mavo:datachange\", {\n\t\t\t\t\t\tnode: this,\n\t\t\t\t\t\tmavo: this.mavo,\n\t\t\t\t\t\taction: \"add\",\n\t\t\t\t\t\titem\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!o.silent) {\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t}\n\n\t\treturn item;\n\t},\n\n\tpropagate: function() {\n\t\tthis.items.forEach(item => item.call.apply(item, arguments));\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.items.splice(this.items.indexOf(item), 1);\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.element._.fire(\"mavo:datachange\", {\n\t\t\t\tnode: this,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\taction: \"delete\",\n\t\t\t\titem: item\n\t\t\t});\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\tedit: function() {\n\t\tif (this.length === 0 && this.required) {\n\t\t\t// Nested collection with no items, add one\n\t\t\tvar item = this.add(null, null, true);\n\n\t\t\titem.placeholder = true;\n\t\t\titem.walk(obj => obj.unsavedChanges = false);\n\n\t\t\t$.once(item.element, \"mavo:datachange\", evt => {\n\t\t\t\titem.unsavedChanges = true;\n\t\t\t\titem.placeholder = false;\n\t\t\t});\n\t\t}\n\n\t\tthis.propagate(obj => obj[obj.preEdit? \"preEdit\" : \"edit\"]());\n\t},\n\n\t/**\n\t * Delete all items in the collection.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.element.remove) {\n\t\t\t\t\titem.element.remove();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Document fragment, remove all children\n\t\t\t\t\tfor (let node of item.element.childNodes) {\n\t\t\t\t\t\tnode => node.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.items = [];\n\n\t\t\tthis.marker._.fire(\"mavo:datachange\", {\n\t\t\t\tnode: this,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\taction: \"clear\"\n\t\t\t});\n\t\t}\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.items) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = item.dirty = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tdone: function() {\n\t\tfor (let item of this.items) {\n\t\t\tif (item.placeholder) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\", \"done\"],\n\n\trevert: function() {\n\t\tfor (let item of this.items) {\n\t\t\t// Delete added items\n\t\t\tif (item.unsavedChanges && !item.placeholder) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Bring back deleted items\n\t\t\t\tif (item.deleted) {\n\t\t\t\t\titem.deleted = false;\n\t\t\t\t}\n\n\t\t\t\t// Revert all properties\n\t\t\t\titem.revert();\n\t\t\t}\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tthis.unhandled = {before: [], after: []};\n\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.items.forEach((item, i) => item.render(data && data[i]));\n\n\t\t\tif (data) {\n\t\t\t\tthis.unhandled.after = data.slice(this.items.length);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.clear();\n\n\t\t\t// Using document fragments improved rendering performance by 60%\n\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\tdata.forEach((datum, i) => {\n\t\t\t\tvar item = this.createItem();\n\n\t\t\t\titem.render(datum);\n\n\t\t\t\tthis.items.push(item);\n\t\t\t\titem.index = i;\n\n\t\t\t\tfragment.appendChild(item.element);\n\t\t\t});\n\n\t\t\tthis.marker.parentNode.insertBefore(fragment, this.marker);\n\t\t}\n\n\t\tthis.save();\n\t},\n\n\tfind: function(property) {\n\t\tvar items = this.items.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has data-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\tthis.mavo.needsEdit = true;\n\n\t\t\t\tthis.required = this.templateElement.matches(Mavo.selectors.required);\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = $.create(\"div\", {\n\t\t\t\t\thidden: true,\n\t\t\t\t\tclassName: \"mv-marker\",\n\t\t\t\t\tafter: this.templateElement\n\t\t\t\t});\n\n\t\t\t\tthis.templateElement.classList.add(\"mv-item\");\n\n\t\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\t\tthis.addButton._.before($.value(this.items[0], \"element\") || this.marker);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\n\t\t\t\t\t\tif (containerSelector) {\n\t\t\t\t\t\t\tvar after = this.marker.closest(containerSelector);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.addButton._.after(after && after.parentNode? after : this.marker);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"data-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.templateElement) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.item);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.add-${this.property}`;\n\t\t\tvar scope = this.closestCollection || this.marker.closest(Mavo.selectors.scope);\n\n\t\t\tif (scope) {\n\t\t\t\tvar button = $$(selector, scope).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.add().edit();\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}