{"version":3,"sources":["expressiontext.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","_","Mavo","Expression","Text","Class","constructor","o","arguments","undefined","this","template","_arr","_i","prop","node","path","reduce","index","childNodes","group","element","attribute","hooks","run","expression","nodeType","parentNode","children","normalize","getAttribute","trim","firstChild","whitespace","textContent","match","splitText","after","lastChild","insertBefore","parsed","syntax","tokenize","elements","set","concat","get","dependsOn","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","Symbol","iterator","next","done","value","err","update","_this","data","evt","ret","console","log","map","expr","changedBy","env","context","eval","Error","fallback","presentational","join","Primitive","formatNumber","primitive","datatype","setValue","static","WeakMap","search","all","filter","et","add","expressionText","store","modes","item","itemTemplate","expressions","push","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($) {\n\nvar _ = Mavo.Expression.Text = $.Class({\n\tconstructor: function(o = {}) {\n\t\tthis.template = o.template && o.template.template || o.template;\n\n\t\tfor (let prop of [\"group\", \"path\", \"syntax\", \"fallback\", \"attribute\"]) {\n\t\t\tthis[prop] = o[prop] === undefined && this.template? this.template[prop] : o[prop];\n\t\t}\n\n\t\tthis.node = o.node;\n\n\t\tif (!this.node) {\n\t\t\t// No node provided, figure it out from path\n\t\t\tthis.node = this.path.reduce((node, index) => {\n\t\t\t\treturn node.childNodes[index];\n\t\t\t}, this.group.element);\n\t\t}\n\n\t\tthis.element = this.node;\n\t\tthis.attribute = this.attribute || null;\n\n\t\tMavo.hooks.run(\"expressiontext-init-start\", this);\n\n\t\tif (!this.expression) { // Still unhandled?\n\t\t\tif (this.node.nodeType === 3) {\n\t\t\t\tthis.element = this.node.parentNode;\n\n\t\t\t\t// If no element siblings make this.node the element, which is more robust\n\t\t\t\t// Same if attribute, there are no attributes on a text node!\n\t\t\t\tif (!this.node.parentNode.children.length || this.attribute) {\n\t\t\t\t\tthis.node = this.element;\n\t\t\t\t\tthis.element.normalize();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.attribute) {\n\t\t\t\tthis.expression = this.node.getAttribute(this.attribute).trim();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Move whitespace outside to prevent it from messing with types\n\t\t\t\tthis.node.normalize();\n\n\t\t\t\tif (this.node.firstChild && this.node.childNodes.length === 1 && this.node.firstChild.nodeType === 3) {\n\t\t\t\t\tvar whitespace = this.node.firstChild.textContent.match(/^\\s*|\\s*$/g);\n\n\t\t\t\t\tif (whitespace[1]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(this.node.firstChild.textContent.length - whitespace[1].length);\n\t\t\t\t\t\t$.after(this.node.lastChild, this.node);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (whitespace[0]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(whitespace[0].length);\n\t\t\t\t\t\tthis.node.parentNode.insertBefore(this.node.firstChild, this.node);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.expression = this.node.textContent;\n\t\t\t}\n\n\n\t\t\tthis.parsed = o.template? o.template.parsed : this.syntax.tokenize(this.expression);\n\t\t}\n\n\t\tMavo.hooks.run(\"expressiontext-init-end\", this);\n\n\t\t_.elements.set(this.element, [...(_.elements.get(this.element) || []), this]);\n\t},\n\n\tdependsOn: function(...ids) {\n\t\tfor (let exp of this.parsed) {\n\n\t\t}\n\t},\n\n\tupdate: function(data = this.data, evt) {\n\t\tthis.data = data;\n\n\t\tvar ret = {};\n\n\t\tMavo.hooks.run(\"expressiontext-update-start\", this);\nif (this.expression == \"[if(absolute, uppercase(type), type)] [arcFlags] [x] [y]\") {\n\tconsole.log(data, this.element.getAttribute(\"content\"), this.group.element);\n}\n\t\tret.value = this.value = this.parsed.map(expr => {\n\t\t\tif (expr instanceof Mavo.Expression) {\n\t\t\t\tif (expr.changedBy(evt)) {\n\t\t\t\t\tvar env = {context: this, expr};\n\n\t\t\t\t\tMavo.hooks.run(\"expressiontext-update-beforeeval\", env);\n\n\t\t\t\t\tenv.value = env.expr.eval(data);\n\n\t\t\t\t\tMavo.hooks.run(\"expressiontext-update-aftereval\", env);\n\n\t\t\t\t\tif (env.value instanceof Error) {\n\t\t\t\t\t\treturn this.fallback !== undefined? this.fallback : env.expr.expression;\n\t\t\t\t\t}\n\t\t\t\t\tif (env.value === undefined || env.value === null) {\n\t\t\t\t\t\t// Donâ€™t print things like \"undefined\" or \"null\"\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn env.value;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn expr.value;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn expr;\n\t\t});\n\n\t\tif (!this.attribute) {\n\t\t\t// Separate presentational & actual values only apply when content is variable\n\t\t\tret.presentational = this.value.map(value => {\n\t\t\t\tif (Array.isArray(value)) {\n\t\t\t\t\treturn value.join(\", \");\n\t\t\t\t}\n\n\t\t\t\tif (typeof value == \"number\") {\n\t\t\t\t\treturn Mavo.Primitive.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t});\n\n\t\t\tret.presentational = ret.presentational.length === 1? ret.presentational[0] : ret.presentational.join(\"\");\n\t\t}\n\n\t\tret.value = ret.value.length === 1? ret.value[0] : ret.value.join(\"\");\n\n\t\tif (this.primitive && this.parsed.length === 1) {\n\t\t\tif (typeof ret.value === \"number\") {\n\t\t\t\tthis.primitive.datatype = \"number\";\n\t\t\t}\n\t\t\telse if (typeof ret.value === \"boolean\") {\n\t\t\t\tthis.primitive.datatype = \"boolean\";\n\t\t\t}\n\t\t}\n\n\t\tif (ret.presentational === ret.value) {\n\t\t\tret = ret.value;\n\t\t}\n\n\t\tif (this.primitive) {\n\t\t\tthis.primitive.value = ret;\n\t\t}\n\t\telse {\n\t\t\tMavo.Primitive.setValue(this.node, ret, {attribute: this.attribute});\n\t\t}\n\n\t\tMavo.hooks.run(\"expressiontext-update-end\", this);\n\t},\n\n\tstatic: {\n\t\telements: new WeakMap(),\n\n\t\t/**\n\t\t * Search for Mavo.Expression.Text object(s) associated with a given element\n\t\t * and optionally an attribute.\n\t\t *\n\t\t * @return If one argument, array of matching Expression.Text objects.\n\t\t *         If two arguments, the matching Expression.Text object or null\n\t\t */\n\t\tsearch: function(element, attribute) {\n\t\t\tvar all = _.elements.get(element) || [];\n\n\t\t\tif (arguments.length > 1) {\n\t\t\t\tif (!all.length) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn all.filter(et => et.attribute === attribute)[0] || null;\n\t\t\t}\n\n\t\t\treturn all;\n\t\t}\n\t}\n});\n\n// Link primitive with its expressionText object\nMavo.hooks.add(\"primitive-init-start\", function() {\n\tthis.expressionText = Mavo.Expression.Text.search(this.element, this.attribute);\n\n\tif (this.expressionText) {\n\t\tthis.expressionText.primitive = this;\n\t\tthis.store = this.store || \"none\";\n\t\tthis.modes = \"read\";\n\t}\n});\n\n// Fix expressions on primitive collections\nMavo.hooks.add(\"collection-add-end\", function(env) {\n\tif (env.item instanceof Mavo.Primitive && this.itemTemplate) {\n\t\tvar et = Mavo.Expression.Text.search(this.itemTemplate.element)[0];\n\n\t\tif (et) {\n\t\t\tet.group.expressions.all.push(new Mavo.Expression.Text({\n\t\t\t\tnode: env.item.element,\n\t\t\t\ttemplate: et\n\t\t\t}));\n\t\t}\n\t}\n});\n\n})(Bliss);\n"],"sourceRoot":"/source/"}