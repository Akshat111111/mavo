{"version":3,"sources":["primitive.js"],"names":["_typeof","Symbol","iterator","obj","constructor","$","$$","_","Mavo","Primitive","Class","extends","Unit","element","mavo","o","_this","this","fromTemplate","defaults","getDefaults","attribute","getValueAttribute","humanReadable","datatype","modes","mode","hooks","run","init","call","changeEvents","events","evt","target","value","getValue","constant","needsEdit","editor","children","filter","el","matches","selectors","formControl","property","textContent","editorValue","remove","hasAttribute","original","getAttribute","is","cloneNode","template","Observer","records","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_step","_iterator","copies","next","done","primitive","setValue","force","silent","err","templateValue","emptyValue","record","collection","swapUI","callback","sneak","ui","inside","ret","forEach","descriptor","Object","getOwnPropertyDescriptor","Node","prototype","defineProperty","get","_this2","set","_this3","observer","editing","getEditorValue","output","all","has","setEditorValue","editorDefaults","getData","arguments","length","env","context","options","data","save","savedValue","unsavedChanges","_this4","popup","close","prevTabindex","tabIndex","removeAttribute","revert","initEdit","_this5","Elements","create","type","input change","focus","select","mavo:datachange","stopPropagation","fire","placeholder","label","dataInput","attributes","test","name","setAttribute","replace","Popup","classList","add","edit","_this6","Promise","resolve","reject","empty","click.mavo:preedit","e","focus.mavo:preedit","click.mavo:edit","preventDefault","timer","mouseenter.mavo:preedit","clearTimeout","setTimeout","mouseleave.mavo:preedit","then","unbind","show","parentNode","appendChild","clear","render","Array","isArray","closestCollection","find","lazy","readable","_this7","presentational","safeCast","_value","document","activeElement","selectedOptions","saved","requestAnimationFrame","node","action","live","hide","toggle","static","WeakMap","selector","cast","_ref","_ref$defaults","_ref$attribute","_ref$datatype","useProperty","_ref2","nodeType","toggleAttribute","formatNumber","indexOf","namespaceURI","numberFormat","Intl","NumberFormat","maximumFractionDigits","Infinity","format","_this8","className","hidden","contents","keyup","keyCode","contains","size","Math","min","_this9","shown","hideCallback","position","bounds","getBoundingClientRect","x","left","y","bottom","style","top","body","window","addEventListener","_this10","removeEventListener","parseFloat","getComputedStyle","transitionDuration","click.mavo:showpopup","keyup.mavo:showpopup","proxy","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Primitive = $.Class({\n\textends: Mavo.Unit,\n\tconstructor: function (element, mavo, o) {\n\t\tif (!this.fromTemplate(\"defaults\", \"attribute\", \"templateValue\")) {\n\t\t\tthis.defaults = _.getDefaults(element);\n\n\t\t\t// Which attribute holds the data, if any?\n\t\t\t// \"null\" or null for none (i.e. data is in content).\n\t\t\tthis.attribute = _.getValueAttribute(this.element, this.defaults);\n\t\t}\n\n\t\tthis.humanReadable = this.defaults.humanReadable;\n\t\tthis.datatype = this.defaults.datatype;\n\t\tthis.modes = this.modes || this.defaults.modes;\n\t\tthis.mode = this.modes || \"read\";\n\n\t\tMavo.hooks.run(\"primitive-init-start\", this);\n\n\t\tif (this.defaults.init) {\n\t\t\tthis.defaults.init.call(this, this.element);\n\t\t}\n\n\t\tif (this.defaults.changeEvents) {\n\t\t\t$.events(this.element, this.defaults.changeEvents, evt => {\n\t\t\t\tif (evt.target === this.element) {\n\t\t\t\t\tthis.value = this.getValue();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Set up input widget\n\t\t */\n\n\t\tif (!this.constant) {\n\t\t\tthis.mavo.needsEdit = true;\n\t\t}\n\n\t\t// Nested widgets\n\t\tif (!this.editor && !this.attribute) {\n\t\t\tthis.editor = $$(this.element.children).filter(function (el) {\n\t\t\t    return el.matches(Mavo.selectors.formControl) && !el.matches(Mavo.selectors.property);\n\t\t\t})[0];\n\n\t\t\tif (this.editor) {\n\t\t\t\tthis.element.textContent = this.editorValue;\n\t\t\t\t$.remove(this.editor);\n\t\t\t}\n\t\t}\n\n\t\t// Linked widgets\n\t\tif (!this.editor && this.element.hasAttribute(\"data-edit\")) {\n\t\t\tvar original = $(this.element.getAttribute(\"data-edit\"));\n\n\t\t\tif (original && Mavo.is(\"formControl\", original)) {\n\t\t\t\tthis.editor = original.cloneNode(true);\n\n\t\t\t\t// Update editor if original mutates\n\t\t\t\tif (!this.template) {\n\t\t\t\t\tnew Mavo.Observer(original, \"all\", records => {\n\t\t\t\t\t\tfor (let primitive of this.copies) {\n\t\t\t\t\t\t\tprimitive.editor = original.cloneNode(true);\n\t\t\t\t\t\t\tprimitive.setValue(primitive.value, {force: true, silent: true});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.templateValue = this.getValue();\n\n\t\tthis.default = this.element.getAttribute(\"data-default\");\n\n\t\tif (this.constant || this.default === \"\") { // attribute exists, no value, default is template value\n\t\t\tthis.default = this.templateValue;\n\t\t}\n\t\telse if (this.default === null) { // attribute does not exist\n\t\t\tthis.default = this.editor? this.editorValue : this.emptyValue;\n\t\t}\n\t\telse {\n\t\t\tnew Mavo.Observer(this.element, \"data-default\", record => {\n\t\t\t\tthis.default = this.element.getAttribute(\"data-default\");\n\t\t\t});\n\t\t}\n\n\t\tif (this.collection) {\n\t\t\t// Collection of primitives, deal with setting textContent etc without the UI interfering.\n\t\t\tvar swapUI = callback => {\n\t\t\t\tthis.sneak(() => {\n\t\t\t\t\tvar ui = $.remove($(\".mv-item-controls\", this.element));\n\n\t\t\t\t\tvar ret = callback();\n\n\t\t\t\t\t$.inside(ui, this.element);\n\t\t\t\t});\n\n\t\t\t\treturn ret;\n\t\t\t};\n\n\t\t\t// Intercept certain properties so that any Mavo UI inside this primitive will not be destroyed\n\t\t\t[\"textContent\", \"innerHTML\"].forEach(property => {\n\t\t\t\tvar descriptor = Object.getOwnPropertyDescriptor(Node.prototype, property);\n\n\t\t\t\tObject.defineProperty(this.element, property, {\n\t\t\t\t\tget: function() {\n\t\t\t\t\t\treturn swapUI(() => descriptor.get.call(this));\n\t\t\t\t\t},\n\n\t\t\t\t\tset: function(value) {\n\t\t\t\t\t\tswapUI(() => descriptor.set.call(this, value));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tif (!this.constant) {\n\t\t\tthis.setValue(this.templateValue, {silent: true});\n\t\t}\n\n\t\tthis.setValue(this.template? this.default : this.templateValue, {silent: true});\n\n\t\t// Observe future mutations to this property, if possible\n\t\t// Properties like input.checked or input.value cannot be observed that way\n\t\t// so we cannot depend on mutation observers for everything :(\n\t\tthis.observer = new Mavo.Observer(this.element, this.attribute, records => {\n\t\t\tif (this.attribute || !this.editing) {\n\t\t\t\tthis.value = this.getValue();\n\t\t\t}\n\t\t});\n\t},\n\n\tget editorValue() {\n\t\tif (this.getEditorValue) {\n\t\t\tvar value = this.getEditorValue();\n\n\t\t\tif (value !== undefined) {\n\t\t\t\treturn value;\n\t\t\t}\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\treturn _.getValue(this.editor, {datatype: this.datatype});\n\t\t\t}\n\n\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\tif (output) {\n\t\t\t\treturn _.all.has(output)? _.all.get(output).value : _.getValue(output);\n\t\t\t}\n\t\t}\n\t},\n\n\tset editorValue(value) {\n\t\tif (this.setEditorValue && this.setEditorValue(value) !== undefined) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\t_.setValue(this.editor, value, {defaults: this.editorDefaults});\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\t\tif (output) {\n\t\t\t\t\tif (_.all.has(output)) {\n\t\t\t\t\t\t_.all.get(output).value = value;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t_.setValue(output, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: this.super.getData.call(this, o)\n\t\t};\n\n\t\tif (env.data !== undefined) {\n\t\t\treturn env.data;\n\t\t}\n\n\t\tenv.data = this.value;\n\n\t\tif (env.data === \"\") {\n\t\t\tenv.data = null;\n\t\t}\n\n\t\tMavo.hooks.run(\"primitive-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\tsave: function() {\n\t\tthis.savedValue = this.value;\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tdone: function () {\n\t\tthis.super.done.call(this);\n\n\t\tthis.sneak(() => {\n\t\t\tif (this.defaults.done) {\n\t\t\t\tthis.defaults.done.call(this);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.popup) {\n\t\t\t\tthis.popup.close();\n\t\t\t}\n\t\t\telse if (!this.attribute && this.editor) {\n\t\t\t\t$.remove(this.editor);\n\t\t\t\tthis.element.textContent = this.editorValue;\n\t\t\t}\n\t\t});\n\n\t\t// Revert tabIndex\n\t\tif (this.element._.data.prevTabindex !== null) {\n\t\t\tthis.element.tabIndex = this.element._.data.prevTabindex;\n\t\t}\n\t\telse {\n\t\t\tthis.element.removeAttribute(\"tabindex\");\n\t\t}\n\t},\n\n\trevert: function() {\n\t\tif (this.unsavedChanges && this.savedValue !== undefined) {\n\t\t\t// FIXME if we have a collection of properties (notgroups), this will cause\n\t\t\t// cancel to not remove new unsaved items\n\t\t\t// This should be fixed by handling this on the collection level.\n\t\t\tthis.value = this.savedValue;\n\t\t\tthis.unsavedChanges = false;\n\t\t}\n\t},\n\n\tsneak: function(callback) {\n\t\tthis.observer? this.observer.sneak(callback) : callback();\n\t},\n\n\t// Called only the first time this primitive is edited\n\tinitEdit: function () {\n\t\tif (!this.editor) {\n\t\t\t// No editor provided, use default for element type\n\t\t\t// Find default editor for datatype\n\t\t\tvar editor = this.defaults.editor || Mavo.Elements[\"*\"].editor;\n\n\t\t\tif (this.defaults.setEditorValue) {\n\t\t\t\t// TODO Temporary hack; refactor soon\n\t\t\t\tthis.setEditorValue = this.defaults.setEditorValue;\n\t\t\t}\n\n\t\t\tthis.editor = $.create($.type(editor) === \"function\"? editor.call(this) : editor);\n\t\t\tthis.editorValue = this.value;\n\t\t}\n\n\t\t$.events(this.editor, {\n\t\t\t\"input change\": evt => {\n\t\t\t\tthis.value = this.editorValue;\n\t\t\t},\n\t\t\t\"focus\": evt => {\n\t\t\t\tthis.editor.select && this.editor.select();\n\t\t\t},\n\t\t\t\"mavo:datachange\": evt => {\n\t\t\t\tif (evt.property === \"output\") {\n\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t$.fire(this.editor, \"input\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (\"placeholder\" in this.editor) {\n\t\t\tthis.editor.placeholder = \"(\" + this.label + \")\";\n\t\t}\n\n\t\t// Copy any data-input-* attributes from the element to the editor\n\t\tvar dataInput = /^data-edit-/i;\n\t\t$$(this.element.attributes).forEach(function (attribute) {\n\t\t\tif (dataInput.test(attribute.name)) {\n\t\t\t\tthis.editor.setAttribute(attribute.name.replace(dataInput, \"\"), attribute.value);\n\t\t\t}\n\t\t}, this);\n\n\t\tif (this.attribute) {\n\t\t\tthis.popup = new _.Popup(this);\n\t\t}\n\n\t\tif (!this.popup) {\n\t\t\tthis.editor.classList.add(\"mv-editor\");\n\t\t}\n\n\t\tthis.initEdit = null;\n\t},\n\n\tedit: function () {\n\t\tif (this.constant) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.super.edit.call(this);\n\n\t\t// Make element focusable, so it can actually receive focus\n\t\tthis.element._.data.prevTabindex = this.element.getAttribute(\"tabindex\");\n\t\tthis.element.tabIndex = 0;\n\n\t\tif (this.defaults.edit) {\n\t\t\tthis.defaults.edit.call(this);\n\t\t\treturn;\n\t\t}\n\n\t\t(new Promise((resolve, reject) => {\n\t\t\t// Prepare for edit\n\n\t\t\t// Empty properties should become editable immediately\n\t\t\t// otherwise they could be invisible!\n\t\t\tif (this.empty && !this.attribute) {\n\t\t\t\tresolve();\n\t\t\t}\n\n\t\t\tthis.element._.events({\n\t\t\t\t// click is needed too because it works with the keyboard as well\n\t\t\t\t\"click.mavo:preedit\": e => this.edit(),\n\t\t\t\t\"focus.mavo:preedit\": e => {\n\t\t\t\t\tresolve();\n\t\t\t\t},\n\t\t\t\t\"click.mavo:edit\": evt => {\n\t\t\t\t\t// Prevent default actions while editing\n\t\t\t\t\t// e.g. following links etc\n\t\t\t\t\tevt.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvar timer;\n\n\t\t\tif (!this.attribute) {\n\t\t\t\t// Hovering over the element for over 150ms will trigger edit\n\t\t\t\tthis.element._.events({\n\t\t\t\t\t\"mouseenter.mavo:preedit\": e => {\n\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t\ttimer = setTimeout(resolve, 150);\n\t\t\t\t\t},\n\t\t\t\t\t\"mouseleave.mavo:preedit\": e => {\n\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t})).then(() => {\n\t\t\t// Actual edit\n\t\t\tthis.element._.unbind(\".mavo:preedit\");\n\n\t\t\tif (this.initEdit) {\n\t\t\t\tthis.initEdit();\n\t\t\t}\n\n\t\t\tif (this.popup) {\n\t\t\t\tthis.popup.show();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.editor.focus();\n\t\t\t}\n\n\t\t\tif (!this.attribute) {\n\t\t\t\tif (this.editor.parentNode != this.element) {\n\t\t\t\t\tthis.editorValue = this.value;\n\t\t\t\t\tthis.element.textContent = \"\";\n\n\t\t\t\t\tthis.element.appendChild(this.editor);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}, // edit\n\n\tclear: function() {\n\t\tif (!this.constant) {\n\t\t\tthis.value = this.emptyValue;\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tif (Array.isArray(data)) {\n\t\t\tdata = data[0]; // TODO what is gonna happen to the rest? Lost?\n\t\t}\n\n\t\tif (typeof data === \"object\") {\n\t\t\tdata = data[this.property];\n\t\t}\n\n\t\tif (data === undefined) {\n\t\t\t// New property has been added to the schema and nobody has saved since\n\t\t\tthis.value = this.closestCollection? this.default : this.templateValue;\n\t\t}\n\t\telse {\n\t\t\tthis.value = data;\n\t\t}\n\n\t\tthis.save();\n\t},\n\n\tfind: function(property) {\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\t},\n\n\t/**\n\t * Get value from the DOM\n\t */\n\tgetValue: function(o) {\n\t\treturn _.getValue(this.element, {\n\t\t\tdefaults: this.defaults,\n\t\t\tattribute: this.attribute,\n\t\t\tdatatype: this.datatype\n\t\t});\n\t},\n\n\tlazy: {\n\t\tlabel: function() {\n\t\t\treturn Mavo.readable(this.property);\n\t\t},\n\n\t\temptyValue: function() {\n\t\t\tswitch (this.datatype) {\n\t\t\t\tcase \"boolean\":\n\t\t\t\t\treturn false;\n\t\t\t\tcase \"number\":\n\t\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\treturn \"\";\n\t\t},\n\n\t\teditorDefaults: function() {\n\t\t\treturn this.editor && _.getDefaults(this.editor);\n\t\t}\n\t},\n\n\tsetValue: function (value, o = {}) {\n\t\tthis.sneak(() => {\n\t\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\t\tvar presentational = value.presentational;\n\t\t\t\tvalue = value.value;\n\t\t\t}\n\n\t\t\tvalue = value || value === 0? value : \"\";\n\t\t\tvalue = _.safeCast(value, this.datatype);\n\n\t\t\tif (value == this._value && !o.force) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (this.editor && document.activeElement != this.editor) {\n\t\t\t\tthis.editorValue = value;\n\t\t\t}\n\n\t\t\tif (this.humanReadable && this.attribute) {\n\t\t\t\tpresentational = this.humanReadable(value);\n\t\t\t}\n\n\t\t\tif (!this.editing || this.attribute) {\n\t\t\t\tif (this.editor && this.editor.matches(\"select\") && this.editor.selectedOptions[0]) {\n\t\t\t\t\tpresentational = this.editor.selectedOptions[0].textContent;\n\t\t\t\t}\n\n\t\t\t\t_.setValue(this.element, {value, presentational}, {\n\t\t\t\t\tdefaults: this.defaults,\n\t\t\t\t\tattribute: this.attribute,\n\t\t\t\t\tdatatype: this.datatype\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.empty = value === \"\";\n\n\t\t\tthis._value = value;\n\n\t\t\tif (!o.silent) {\n\t\t\t\tif (this.saved) {\n\t\t\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t\t\t}\n\n\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\t$.fire(this.element, \"mavo:datachange\", {\n\t\t\t\t\t\tproperty: this.property,\n\t\t\t\t\t\tvalue: value,\n\t\t\t\t\t\tmavo: this.mavo,\n\t\t\t\t\t\tnode: this,\n\t\t\t\t\t\taction: \"propertychange\"\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\treturn value;\n\t},\n\n\tlive: {\n\t\tvalue: function (value) {\n\t\t\treturn this.setValue(value);\n\t\t},\n\n\t\tempty: function (value) {\n\t\t\tvar hide = value && // is empty\n\t\t\t!this.constant && // and editable\n\t\t\t!(this.attribute && $(Mavo.selectors.property, this.element)); // and has no property inside\n\n\t\t\tthis.element.classList.toggle(\"mv-empty\", hide);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tgetDefaults: function (element) {\n\t\t\tvar ret = null;\n\n\t\t\tfor (var selector in Mavo.Elements) {\n\t\t\t\tif (element.matches(selector)) {\n\t\t\t\t\tret = Mavo.Elements[selector];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\tgetValueAttribute: function (element, defaults = _.getDefaults(element)) {\n\t\t\tvar ret = element.getAttribute(\"data-attribute\") || defaults.attribute;\n\n\t\t\tif (!ret || ret === \"null\") {\n\t\t\t\tret = null;\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\t/**\n\t\t * Only cast if conversion is lossless\n\t\t */\n\t\tsafeCast: function(value, datatype) {\n\t\t\tvar existingType = typeof value;\n\t\t\tvar cast = _.cast(value, datatype);\n\n\t\t\tif (value === null || value === undefined) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"boolean\") {\n\t\t\t\tif (value === \"false\" || value === 0 || value === \"\") {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif (value === \"true\" || value > 0) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"number\") {\n\t\t\t\tif (/^[-+]?[0-9.e]+$/i.test(value + \"\")) {\n\t\t\t\t\treturn cast;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\treturn cast;\n\t\t},\n\n\t\t/**\n\t\t * Cast to a different primitive datatype\n\t\t */\n\t\tcast: function(value, datatype) {\n\t\t\tswitch (datatype) {\n\t\t\t\tcase \"number\": return +value;\n\t\t\t\tcase \"boolean\": return !!value;\n\t\t\t\tcase \"string\": return value + \"\";\n\t\t\t}\n\n\t\t\treturn value;\n\t\t},\n\n\t\tgetValue: function (element, {\n\t\t\tdefaults = _.getDefaults(element),\n\t\t\tattribute = _.getValueAttribute(element, defaults),\n\t\t\tdatatype = defaults.datatype\n\t\t}) {\n\t\t\tif (defaults.getValue && attribute == defaults.attribute) {\n\t\t\t\treturn defaults.getValue(element);\n\t\t\t}\n\n\t\t\tvar ret;\n\n\t\t\tif (attribute in element && _.useProperty(element, attribute)) {\n\t\t\t\t// Returning properties (if they exist) instead of attributes\n\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\tret = element[attribute];\n\t\t\t}\n\t\t\telse if (attribute) {\n\t\t\t\tret = element.getAttribute(attribute);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tret = element.getAttribute(\"content\") || element.textContent || null;\n\t\t\t}\n\n\t\t\treturn _.safeCast(ret, datatype);\n\t\t},\n\n\t\tsetValue: function (element, value, {defaults, attribute, datatype}) {\n\t\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\t\tvar presentational = value.presentational;\n\t\t\t\tvalue = value.value;\n\t\t\t}\n\n\t\t\tif (element.nodeType === 1) {\n\t\t\t\tdefaults = defaults || _.getDefaults(element);\n\t\t\t\tattribute = attribute !== undefined? attribute : _.getValueAttribute(element, defaults);\n\t\t\t\tdatatype = datatype !== undefined? datatype : defaults.datatype;\n\n\t\t\t\tif (defaults.setValue && attribute == defaults.attribute) {\n\t\t\t\t\treturn defaults.setValue(element, value);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (attribute) {\n\t\t\t\tif (attribute in element && _.useProperty(element, attribute) && element[attribute] != value) {\n\t\t\t\t\t// Setting properties (if they exist) instead of attributes\n\t\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\t\ttry {\n\t\t\t\t\t\telement[attribute] = value;\n\t\t\t\t\t}\n\t\t\t\t\tcatch (e) {}\n\t\t\t\t}\n\n\t\t\t\t// Set attribute anyway, even if we set a property because when\n\t\t\t\t// they're not in sync it gets really fucking confusing.\n\t\t\t\tif (datatype == \"boolean\") {\n\t\t\t\t\tif (value != element.hasAttribute(attribute)) {\n\t\t\t\t\t\t$.toggleAttribute(element, attribute, value, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (element.getAttribute(attribute) != value) {  // intentionally non-strict, e.g. \"3.\" !== 3\n\t\t\t\t\telement.setAttribute(attribute, value);\n\n\t\t\t\t\tif (presentational) {\n\t\t\t\t\t\telement.textContent = presentational;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (datatype === \"number\" && !presentational) {\n\t\t\t\t\tpresentational = _.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\telement.textContent = presentational || value;\n\n\t\t\t\tif (presentational && element.setAttribute) {\n\t\t\t\t\telement.setAttribute(\"content\", value);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t *  Set/get a property or an attribute?\n\t\t * @return {Boolean} true to use a property, false to use the attribute\n\t\t */\n\t\tuseProperty: function(element, attribute) {\n\t\t\tif ([\"href\", \"src\"].indexOf(attribute) > -1) {\n\t\t\t\t// URL properties resolve \"\" as location.href, fucking up emptiness checks\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (element.namespaceURI == \"http://www.w3.org/2000/svg\") {\n\t\t\t\t// SVG has a fucked up DOM, do not use these properties\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\n\t\tlazy: {\n\t\t\tformatNumber: () => {\n\t\t\t\tvar numberFormat = new Intl.NumberFormat(\"en-US\", {maximumFractionDigits:2});\n\n\t\t\t\treturn function(value) {\n\t\t\t\t\tif (value === Infinity || value === -Infinity) {\n\t\t\t\t\t\t// Pretty print infinity\n\t\t\t\t\t\treturn value < 0? \"-∞\" : \"∞\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn numberFormat.format(value);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n});\n\n_.Popup = $.Class({\n\tconstructor: function(primitive) {\n\t\tthis.primitive = primitive;\n\n\t\tthis.popup = $.create(\"div\", {\n\t\t\tclassName: \"mv-popup\",\n\t\t\thidden: true,\n\t\t\tcontents: [\n\t\t\t\tthis.primitive.label + \":\",\n\t\t\t\tthis.editor\n\t\t\t],\n\t\t\tevents: {\n\t\t\t\tkeyup: evt => {\n\t\t\t\t\tif (evt.keyCode == 13 || evt.keyCode == 27) {\n\t\t\t\t\t\tif (this.popup.contains(document.activeElement)) {\n\t\t\t\t\t\t\tthis.element.focus();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t\tthis.hide();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// No point in having a dropdown in a popup\n\t\tif (this.editor.matches(\"select\")) {\n\t\t\tthis.editor.size = Math.min(10, this.editor.children.length);\n\t\t}\n\t},\n\n\tshow: function() {\n\t\t$.unbind([this.element, this.popup], \".mavo:showpopup\");\n\n\t\tthis.shown = true;\n\n\t\tthis.hideCallback = evt => {\n\t\t\tif (!this.popup.contains(evt.target) && !this.element.contains(evt.target)) {\n\t\t\t\tthis.hide();\n\t\t\t}\n\t\t};\n\n\t\tthis.position = evt => {\n\t\t\tvar bounds = this.element.getBoundingClientRect();\n\t\t\tvar x = bounds.left;\n\t\t\tvar y = bounds.bottom;\n\n\t\t\t // TODO what if it doesn’t fit?\n\t\t\t$.style(this.popup, { top:  `${y}px`, left: `${x}px` });\n\t\t};\n\n\t\tthis.position();\n\n\t\tdocument.body.appendChild(this.popup);\n\n\t\trequestAnimationFrame(e => this.popup.removeAttribute(\"hidden\")); // trigger transition\n\n\t\t$.events(document, \"focus click\", this.hideCallback, true);\n\t\twindow.addEventListener(\"scroll\", this.position);\n\t},\n\n\thide: function() {\n\t\t$.unbind(document, \"focus click\", this.hideCallback, true);\n\t\twindow.removeEventListener(\"scroll\", this.position);\n\t\tthis.popup.setAttribute(\"hidden\", \"\"); // trigger transition\n\t\tthis.shown = false;\n\n\t\tsetTimeout(() => {\n\t\t\t$.remove(this.popup);\n\t\t}, parseFloat(getComputedStyle(this.popup).transitionDuration) * 1000 || 400); // TODO transition-duration could override this\n\n\t\t$.events(this.element, {\n\t\t\t\"click.mavo:showpopup\": evt => {\n\t\t\t\tthis.show();\n\t\t\t},\n\t\t\t\"keyup.mavo:showpopup\": evt => {\n\t\t\t\tif ([13, 113].indexOf(evt.keyCode) > -1) { // Enter or F2\n\t\t\t\t\tthis.show();\n\t\t\t\t\tthis.editor.focus();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\tclose: function() {\n\t\tthis.hide();\n\t\t$.unbind(this.element, \".mavo:edit .mavo:preedit .mavo:showpopup\");\n\t},\n\n\tproxy: {\n\t\t\"editor\": \"primitive\",\n\t\t\"element\": \"primitive\"\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}