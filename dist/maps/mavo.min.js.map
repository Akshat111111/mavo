{"version":3,"sources":["mavo.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","$$","_","self","Mavo","Class","constructor","element","_this","this","treeBuilt","defer","index","all","push","id","getAttribute","Node","getProperty","setAttribute","unhandled","classList","contains","autoEdit","has","storage","urlParam","source","test","Backend","create","permissions","Permissions","addEventListener","evt","keyCode","superKey","preventDefault","save","selectors","primitive","forEach","isGroup","not","formControl","property","is","Primitive","getValueAttribute","matches","ui","bar","className","start","status","inside","authControls","can","loginHash","login","tag","href","textContent","events","click","after","location","hash","history","replaceState","document","title","URL","window","remove","unbind","backend","innerHTML","contents","name","e","logout","needsEdit","hooks","run","root","Group","resolve","setUnsavedChanges","onchange","_ref","action","value","toggle","edit","onclick","editing","done","mouseenter focus","add","mouseleave blur","revert","disabled","unsavedChanges","clear","appendChild","cannot","read","load","on","fire","off","debouncedSave","debounce","callback","node","saved","requestAnimationFrame","removeEventListener","data","getData","o","toJSON","arguments","undefined","render","context","confirm","store","target","item","closest","type","parent","parentNode","walk","obj","_this2","inProgress","ready","then","get","err","Promise","reject","response","JSON","parse","xhr","console","error","log","stack","_this3","put","file","dataString","lastSaved","Date","now","live","toggleAttribute","static","navigator","platform","indexOf","init","container","filter","map","Hooks","s","specificProperty","group","multiple","option","li","tr","dt","dd","selector","split","join","or","selector1","selector2","and","ret","s1","apply","s2","andNot","extend","rootGroup","output","autoMultiple","include","Intl","documentElement","Stretchy","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function ($, $$) {\n\n\"use strict\";\n\nvar _ = self.Mavo = $.Class({\n\tconstructor: function (element) {\n\t\tthis.treeBuilt = Mavo.defer();\n\n\t\t// Index among other mavos in the page, 1 is first\n\t\tthis.index = _.all.push(this);\n\n\t\t// Assign a unique (for the page) id to this mavo instance\n\t\tthis.id = element.getAttribute(\"data-mavo\") || Mavo.Node.getProperty(element) || element.id || `mavo${this.index}`;\n\t\telement.setAttribute(\"data-mavo\", this.id);\n\n\t\tthis.unhandled = element.classList.contains(\"mv-keep-unhandled\");\n\t\tthis.autoEdit = _.has(\"mv-autoedit\", element);\n\n\t\tthis.element = element;\n\n\t\tif (this.index == 1) {\n\t\t\tthis.storage = _.urlParam(\"store\");\n\t\t\tthis.source = _.urlParam(\"source\");\n\t\t}\n\n\t\tthis.storage = this.storage || _.urlParam(`${this.id}_store`) || element.getAttribute(\"data-store\") || null;\n\t\tthis.source = this.source || _.urlParam(`${this.id}_source`) || element.getAttribute(\"data-source\") || null;\n\n\t\tif (this.storage && !/^\\s*none\\s*$/i.test(this.storage)) {\n\t\t\tthis.storage = _.Backend.create(this.storage, this);\n\t\t}\n\n\t\tif (this.source) {\n\t\t\tthis.source = _.Backend.create(this.source, this);\n\t\t}\n\n\t\tthis.permissions = this.storage ? this.storage.permissions : new Mavo.Permissions();\n\n\t\t// Ctrl + S or Cmd + S to save\n\t\tthis.element.addEventListener(\"keydown\", evt => {\n\t\t\tif (evt.keyCode == 83 && evt[_.superKey]) {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.save();\n\t\t\t}\n\t\t});\n\n\t\tthis.element.setAttribute(\"typeof\", \"\");\n\n\t\t// Apply heuristic for groups\n\t\t$$(_.selectors.primitive, element).forEach(element => {\n\t\t\tvar isGroup = $(`${_.selectors.not(_.selectors.formControl)}, ${_.selectors.property}`, element) && (// Contains other properties or non-form elements and...\n\t\t\t                Mavo.is(\"multiple\", element) || // is a collection...\n\t\t\t                Mavo.Primitive.getValueAttribute(element) === null  // ...or its content is not in an attribute\n\t\t\t\t\t\t) || element.matches(\"template\");\n\n\t\t\tif (isGroup) {\n\t\t\t\telement.setAttribute(\"typeof\", \"\");\n\t\t\t}\n\t\t});\n\n\t\tthis.ui = {\n\t\t\tbar: $(\".mv-bar\", this.element) || $.create({\n\t\t\t\tclassName: \"mv-bar mv-ui\",\n\t\t\t\tstart: this.element\n\t\t\t})\n\t\t};\n\n\t\tthis.ui.status = $(\".mv-status\", this.ui.bar) || $.create(\"span\", {\n\t\t\tclassName: \"mv-status\",\n\t\t\tinside: this.ui.bar\n\t\t});\n\n\t\tif (this.storage) {\n\t\t\t// Reflect backend permissions in global permissions\n\t\t\tthis.authControls = {};\n\n\t\t\tthis.permissions.can(\"login\", () => {\n\t\t\t\t// #login authenticates if only 1 mavo on the page, or if the first.\n\t\t\t\t// Otherwise, we have to generate a slightly more complex hash\n\t\t\t\tthis.loginHash = \"#login\" + (Mavo.all[0] === this? \"\" : \"-\" + this.id);\n\n\t\t\t\tthis.authControls.login = $.create({\n\t\t\t\t\ttag: \"a\",\n\t\t\t\t\thref: this.loginHash,\n\t\t\t\t\ttextContent: \"Login\",\n\t\t\t\t\tclassName: \"mv-login mv-button\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: evt => {\n\t\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\t\tthis.storage.login();\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tafter: $(\".mv-status\", this.ui.bar)\n\t\t\t\t});\n\n\t\t\t\t// We also support a hash to trigger login, in case the user doesn't want visible login UI\n\t\t\t\tvar login;\n\t\t\t\t(login = () => {\n\t\t\t\t\tif (location.hash === this.loginHash) {\n\t\t\t\t\t\t// This just does location.hash = \"\" without getting a pointless # at the end of the URL\n\t\t\t\t\t\thistory.replaceState(null, document.title, new URL(\"\", location) + \"\");\n\t\t\t\t\t\tthis.storage.login();\n\t\t\t\t\t}\n\t\t\t\t})();\n\t\t\t\twindow.addEventListener(\"hashchange.mavo\", login);\n\t\t\t}, () => {\n\t\t\t\t$.remove(this.authControls.login);\n\t\t\t\tthis.element._.unbind(\"hashchange.mavo\");\n\t\t\t});\n\n\t\t\t// Update login status\n\t\t\tthis.element.addEventListener(\"mavo:login.mavo\", evt => {\n\t\t\t\tif (evt.backend == this.storage) { // ignore logins from source backend\n\t\t\t\t\tvar status = $(\".mv-status\", this.ui.bar);\n\t\t\t\t\tstatus.innerHTML = \"\";\n\t\t\t\t\tstatus._.contents([\n\t\t\t\t\t\t\"Logged in to \" + evt.backend.id + \" as \",\n\t\t\t\t\t\t{tag: \"strong\", innerHTML: evt.name},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttextContent: \"Logout\",\n\t\t\t\t\t\t\tclassName: \"mv-logout\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\tclick: e => evt.backend.logout()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}\n\t\t\t\t\t]);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.element.addEventListener(\"mavo:logout.mavo\", evt => {\n\t\t\t\t$(\".mv-status\", this.ui.bar).textContent = \"\";\n\t\t\t});\n\t\t}\n\n\t\t// Is there any control that requires an edit button?\n\t\tthis.needsEdit = false;\n\n\t\t// Build mavo objects\n\t\tMavo.hooks.run(\"init-tree-before\", this);\n\n\t\tthis.root = new Mavo.Group(this.element, this);\n\t\tthis.treeBuilt.resolve();\n\n\t\tMavo.hooks.run(\"init-tree-after\", this);\n\n\t\tthis.setUnsavedChanges(false);\n\n\t\tthis.permissions.onchange(({action, value}) => {\n\t\t\tthis.element.classList.toggle(`mv-can-${action}`, !!value);\n\t\t});\n\n\t\tthis.permissions.can([\"edit\", \"add\", \"delete\"], () => {\n\t\t\tthis.ui.edit = $.create(\"button\", {\n\t\t\t\tclassName: \"mv-edit\",\n\t\t\t\ttextContent: \"Edit\",\n\t\t\t\tonclick: e => this.editing? this.done() : this.edit(),\n\t\t\t\tinside: this.ui.bar\n\t\t\t});\n\n\t\t\tif (this.autoEdit) {\n\t\t\t\tthis.element.addEventListener(\"mavo:load\", evt => this.ui.edit.click());\n\t\t\t}\n\t\t}, () => { // cannot\n\t\t\t$.remove(this.ui.edit);\n\n\t\t\tif (this.editing) {\n\t\t\t\tthis.done();\n\t\t\t}\n\t\t});\n\n\t\tif (this.needsEdit) {\n\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\tthis.ui.save = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-save\",\n\t\t\t\t\ttextContent: \"Save\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.save(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tthis.element.classList.add(\"mv-save-hovered\");\n\t\t\t\t\t\t\tthis.setUnsavedChanges();\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.element.classList.remove(\"mv-save-hovered\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\n\t\t\t\tthis.ui.revert = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-revert\",\n\t\t\t\t\ttextContent: \"Revert\",\n\t\t\t\t\tdisabled: true,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.revert(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tif (!this.unsavedChanges) {\n\t\t\t\t\t\t\t\tthis.element.classList.add(\"mv-revert-hovered\");\n\t\t\t\t\t\t\t\tthis.setUnsavedChanges();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.element.classList.remove(\"mv-revert-hovered\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\t\t\t}, () => {\n\t\t\t\t$.remove([this.ui.save, this.ui.revert]);\n\t\t\t\tthis.ui.save = this.ui.revert = null;\n\t\t\t});\n\t\t}\n\n\t\tthis.permissions.can(\"delete\", () => {\n\t\t\tthis.ui.clear = $.create(\"button\", {\n\t\t\t\tclassName: \"mv-clear\",\n\t\t\t\ttextContent: \"Clear\",\n\t\t\t\tonclick: e => this.clear()\n\t\t\t});\n\n\t\t\tthis.ui.bar.appendChild(this.ui.clear);\n\t\t});\n\n\t\tthis.permissions.cannot([\"delete\", \"edit\"], () => {\n\t\t\t$.remove(this.ui.clear);\n\t\t});\n\n\t\tif (this.storage || this.source) {\n\t\t\t// Fetch existing data\n\t\t\tif (!this.storage) {\n\t\t\t\tthis.source.permissions.can(\"read\", () => this.permissions.read = true);\n\t\t\t}\n\n\t\t\tthis.permissions.can(\"read\", () => this.load());\n\t\t}\n\t\telse {\n\t\t\t// No storage\n\t\t\tthis.permissions.on([\"read\", \"edit\"]);\n\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t}\n\n\t\tif (!this.needsEdit) {\n\t\t\tthis.permissions.off([\"edit\", \"add\", \"delete\"]);\n\n\t\t\t// If there's no edit mode, we must save immediately when properties change\n\t\t\tthis.element.addEventListener(\"mavo:load\", evt => {\n\t\t\t\tvar debouncedSave = _.debounce(() => {\n\t\t\t\t\tthis.save();\n\t\t\t\t}, 1000);\n\n\t\t\t\tvar callback = evt => {\n\t\t\t\t\tif (evt.node.saved) {\n\t\t\t\t\t\tdebouncedSave();\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\t\t\tthis.element.addEventListener(\"mavo:datachange\", callback);\n\t\t\t\t\t}, () => {\n\t\t\t\t\t\tthis.element.removeEventListener(\"mavo:datachange\", callback);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tMavo.hooks.run(\"init-end\", this);\n\t},\n\n\tget editing() {\n\t\treturn this.root.editing;\n\t},\n\n\tget data() {\n\t\treturn this.getData();\n\t},\n\n\tgetData: function(o) {\n\t\treturn this.root.getData(o);\n\t},\n\n\ttoJSON: function(data = this.data) {\n\t\treturn _.toJSON(data);\n\t},\n\n\trender: function(data) {\n\t\t_.hooks.run(\"render-start\", {context: this, data});\n\n\t\tif (data) {\n\t\t\tif (this.editing) { // TODO this logic should go to Node\n\t\t\t\tthis.done();\n\t\t\t\tthis.root.render(data);\n\t\t\t\tthis.edit();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.root.render(data);\n\t\t\t}\n\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tclear: function() {\n\t\tif (confirm(\"This will delete all your data. Are you sure?\")) {\n\t\t\tthis.store(null);\n\t\t\tthis.root.clear();\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.root.edit();\n\n\t\t$.events(this.element, \"mouseenter.mavo:edit mouseleave.mavo:edit\", evt => {\n\t\t\tif (evt.target.matches(\".mv-item-controls .mv-delete\")) {\n\t\t\t\tvar item = evt.target.closest(_.selectors.item);\n\t\t\t\titem.classList.toggle(\"mv-delete-hover\", evt.type == \"mouseenter\");\n\t\t\t}\n\n\t\t\tif (evt.target.matches(_.selectors.item)) {\n\t\t\t\tevt.target.classList.remove(\"mv-has-hovered-item\");\n\n\t\t\t\tvar parent = evt.target.parentNode.closest(_.selectors.item);\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tparent.classList.toggle(\"mv-has-hovered-item\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\t\t}, true);\n\n\t\tthis.setUnsavedChanges();\n\t},\n\n\t/**\n\t * Set this mavo instance’s unsavedChanges flag.\n\t * @param {Boolean} [value]\n\t *        If true, just sets the flag to true, no traversal.\n\t *        If false, sets the flag of the Mavo instance and every tree node to false\n\t *        If not provided, traverses the tree and recalculates the flag value.\n\t */\n\tsetUnsavedChanges: function(value) {\n\t\tvar unsavedChanges = !!value;\n\n\t\tif (!value) {\n\t\t\tthis.walk(obj => {\n\t\t\t\tif (obj.unsavedChanges) {\n\t\t\t\t\tunsavedChanges = true;\n\n\t\t\t\t\tif (value === false) {\n\t\t\t\t\t\tobj.unsavedChanges = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this.unsavedChanges = unsavedChanges;\n\t},\n\n\t// Conclude editing\n\tdone: function() {\n\t\tthis.root.done();\n\t\t$.unbind(this.element, \".mavo:edit\");\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t/**\n\t * load - Fetch data from source and render it.\n\t *\n\t * @return {Promise}  A promise that resolves when the data is loaded.\n\t */\n\tload: function() {\n\t\tthis.inProgress = \"Loading\";\n\n\t\tvar backend = this.storage || this.source;\n\n\t\treturn backend.ready.then(() => backend.get())\n\t\t.catch(err => {\n\t\t\t// Try again with source\n\t\t\tif (this.source && backend !== this.source) {\n\t\t\t\treturn this.source.ready.then(() => this.source.get());\n\t\t\t}\n\n\t\t\treturn Promise.reject(err);\n\t\t})\n\t\t.then(response => {\n\t\t\tif (response && $.type(response) == \"string\") {\n\t\t\t\tresponse = JSON.parse(response);\n\t\t\t}\n\n\t\t\tthis.render(response);\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tif (err.xhr && err.xhr.status == 404) {\n\t\t\t\t\tthis.render(\"\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// TODO display error to user\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t\tconsole.log(err.stack);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t});\n\t},\n\n\tstore: function() {\n\t\tif (!this.storage) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.inProgress = \"Saving\";\n\n\t\tthis.storage.login()\n\t\t.then(() => this.storage.put())\n\t\t.then(file => {\n\t\t\t$.fire(this.element, \"mavo:save\", {\n\t\t\t\tdata: file.data,\n\t\t\t\tdataString: file.dataString\n\t\t\t});\n\n\t\t\tthis.lastSaved = Date.now();\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tconsole.error(err);\n\t\t\t\tconsole.log(err.stack);\n\t\t\t}\n\t\t})\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t});\n\t},\n\n\tsave: function() {\n\t\tthis.root.save();\n\n\t\tthis.store();\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\trevert: function() {\n\t\tthis.root.revert();\n\t},\n\n\twalk: function(callback) {\n\t\tthis.root.walk(callback);\n\t},\n\n\tlive: {\n\t\tinProgress: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"data-mv-progress\", value, value);\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tthis.element.classList.toggle(\"mv-unsaved-changes\", value);\n\n\t\t\tif (this.ui && this.ui.save) {\n\t\t\t\tthis.ui.save.disabled = !value;\n\t\t\t\tthis.ui.revert.disabled = !value;\n\t\t\t}\n\t\t},\n\n\t\tneedsEdit: function(value) {\n\t\t\t$.toggleAttribute(this.ui.bar, \"hidden\", \"\", !value);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: [],\n\n\t\tsuperKey: navigator.platform.indexOf(\"Mac\") === 0? \"metaKey\" : \"ctrlKey\",\n\n\t\tinit: function(container) {\n\t\t\treturn $$(_.selectors.init, container || document)\n\t\t\t\t.filter(element => !element.parentNode.closest(_.selectors.init))\n\t\t\t\t.map(element => new _(element));\n\t\t},\n\n\t\thooks: new $.Hooks()\n\t}\n});\n\n{\n\nlet s = _.selectors = {\n\tinit: \".mavo, [mavo], [data-mavo], [data-store]\",\n\tproperty: \"[property], [itemprop]\",\n\tspecificProperty: name => `[property=${name}], [itemprop=${name}]`,\n\tgroup: \"[typeof], [itemscope], [itemtype], .mv-group\",\n\tmultiple: \"[multiple], [data-multiple], .mv-multiple\",\n\tformControl: \"input, select, option, textarea\",\n\titem: \".mv-item\",\n\tui: \".mv-ui\",\n\toption: name => `[${name}], [data-${name}], .${name}`,\n\tcontainer: {\n\t\t\"li\": \"ul, ol\",\n\t\t\"tr\": \"table\",\n\t\t\"option\": \"select\",\n\t\t\"dt\": \"dl\",\n\t\t\"dd\": \"dl\"\n\t}\n};\n\nlet arr = s.arr = selector => selector.split(/\\s*,\\s*/g);\nlet not = s.not = selector => arr(selector).map(s => `:not(${s})`).join(\"\");\nlet or = s.or = (selector1, selector2) => selector1 + \", \" + selector2;\nlet and = s.and = (selector1, selector2) => {\n\tvar ret = [], arr2 = arr(selector2);\n\n\tarr(selector1).forEach(s1 => ret.push(...arr2.map(s2 => s1 + s2)));\n\n\treturn ret.join(\", \");\n};\nlet andNot = s.andNot = (selector1, selector2) => and(selector1, not(selector2));\n\n$.extend(_.selectors, {\n\tprimitive: andNot(s.property, s.group),\n\trootGroup: andNot(s.group, s.property),\n\toutput: or(s.specificProperty(\"output\"), \".mv-output, .mv-value\"),\n\tautoMultiple: and(\"li, tr, option\", \":only-of-type\")\n});\n\n}\n\n// Init mavo\nPromise.all([\n\t$.ready(),\n\t$.include(Array.from && window.Intl && document.documentElement.closest, \"https://cdn.polyfill.io/v2/polyfill.min.js?features=blissfuljs,Intl.~locale.en\")\n])\n.catch(err => console.error(err))\n.then(() => Mavo.init());\n\nStretchy.selectors.filter = \".mv-editor:not([property])\";\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}