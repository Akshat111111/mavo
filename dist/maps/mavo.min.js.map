{"version":3,"sources":["primitive.js"],"names":["_typeof","Symbol","iterator","obj","constructor","$","$$","_","Mavo","Primitive","Class","extends","Unit","element","mavo","o","_this","this","fromTemplate","attribute","getValueAttribute","humanReadable","datatype","getDatatype","hooks","run","is","events","evt","target","value","getValue","constant","needsEdit","editor","children","filter","el","matches","selectors","formControl","property","editorType","textContent","editorValue","remove","hasAttribute","original","getAttribute","cloneNode","template","Observer","records","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_step","_iterator","copies","next","done","primitive","setValue","force","silent","err","templateValue","emptyValue","record","collection","swapUI","callback","sneak","ui","inside","ret","forEach","descriptor","Object","getOwnPropertyDescriptor","Node","prototype","defineProperty","get","_this2","call","set","_this3","observer","editing","getEditorValue","output","all","has","setEditorValue","getData","arguments","length","env","context","options","data","save","savedValue","unsavedChanges","_this4","popup","close","prevTabindex","tabIndex","removeAttribute","revert","initEdit","_this5","getMatch","editors","create","extend","type","input change","focus","select","mavo:datachange","stopPropagation","fire","placeholder","label","dataInput","attributes","test","name","setAttribute","replace","Popup","classList","add","edit","_this6","Promise","resolve","reject","empty","click.mavo:preedit","e","focus.mavo:preedit","click.mavo:edit","preventDefault","timer","mouseenter.mavo:preedit","clearTimeout","setTimeout","mouseleave.mavo:preedit","then","unbind","show","parentNode","appendChild","clear","render","Array","isArray","closestCollection","find","lazy","readable","_this7","presentational","safeCast","_value","document","activeElement","selectedOptions","saved","requestAnimationFrame","node","action","live","hide","toggle","static","WeakMap","selector","String","datatypes","cast","useProperty","toggleAttribute","formatNumber","indexOf","namespaceURI","register","init","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","toArray","id","numberFormat","Intl","NumberFormat","maximumFractionDigits","Infinity","format","img, video, audio","a, link","select, input, meter, progress","input[type=checkbox]","time","date","Date","isNaN","day","month","year","hour","minute","datetime-local","timeZone","toLocaleString","meta","checked","input[type=range], input[type=number], meter, progress","*","tag",".number",".boolean","a, img, video, audio, .url","p, div, li, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address, .multiline","display","getComputedStyle","width","offsetWidth","cs","whiteSpace","meter, progress","min","max","time, .date","types","week","datetime","_this8","className","hidden","contents","keyup","keyCode","contains","size","Math","_this9","shown","hideCallback","position","bounds","getBoundingClientRect","x","left","y","bottom","style","top","body","window","addEventListener","_this10","removeEventListener","parseFloat","transitionDuration","click.mavo:showpopup","keyup.mavo:showpopup","proxy","Bliss","_this11","clicked"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Primitive = $.Class({\n\textends: Mavo.Unit,\n\tconstructor: function (element, mavo, o) {\n\t\tif (!this.fromTemplate(\"attribute\", \"datatype\", \"humanReadable\", \"templateValue\")) {\n\t\t\t// Which attribute holds the data, if any?\n\t\t\t// \"null\" or null for none (i.e. data is in content).\n\t\t\tthis.attribute = _.getValueAttribute(this.element);\n\n\t\t\tif (this.attribute) {\n\t\t\t\tthis.humanReadable = this.attribute.humanReadable;\n\t\t\t}\n\n\t\t\tthis.datatype = _.getDatatype(this.element, this.attribute);\n\t\t}\n\n\t\tMavo.hooks.run(\"primitive-init-start\", this);\n\n\t\t/**\n\t\t * Set up input widget\n\t\t */\n\n\t\t// Exposed widgets (visible always)\n\t\tif (Mavo.is(\"formControl\", this.element)) {\n\t\t\t$.events(this.element, \"input change\", evt => {\n\t\t\t\tif (evt.target === this.element) {\n\t\t\t\t\tthis.value = this.getValue();\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.constant = true;\n\t\t}\n\t\telse if (!this.constant) {\n\t\t\tthis.mavo.needsEdit = true;\n\t\t}\n\n\t\t// Nested widgets\n\t\tif (!this.editor && !this.attribute) {\n\t\t\tthis.editor = $$(this.element.children).filter(function (el) {\n\t\t\t    return el.matches(Mavo.selectors.formControl) && !el.matches(Mavo.selectors.property);\n\t\t\t})[0];\n\n\t\t\tif (this.editor) {\n\t\t\t\tthis.editorType = \"nested\";\n\t\t\t\tthis.element.textContent = this.editorValue;\n\t\t\t\t$.remove(this.editor);\n\t\t\t}\n\t\t}\n\n\t\t// Linked widgets\n\t\tif (!this.editor && this.element.hasAttribute(\"data-edit\")) {\n\t\t\tthis.editorType = \"linked\";\n\n\t\t\tvar original = $(this.element.getAttribute(\"data-edit\"));\n\n\t\t\tif (original && Mavo.is(\"formControl\", original)) {\n\t\t\t\tthis.editor = original.cloneNode(true);\n\n\t\t\t\t// Update editor if original mutates\n\t\t\t\tif (!this.template) {\n\t\t\t\t\tnew Mavo.Observer(original, \"all\", records => {\n\t\t\t\t\t\tfor (let primitive of this.copies) {\n\t\t\t\t\t\t\tprimitive.editor = original.cloneNode(true);\n\t\t\t\t\t\t\tprimitive.setValue(primitive.value, {force: true, silent: true});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.templateValue = this.getValue();\n\n\t\tthis.default = this.element.getAttribute(\"data-default\");\n\n\t\tif (this.constant || this.default === \"\") { // attribute exists, no value, default is template value\n\t\t\tthis.default = this.templateValue;\n\t\t}\n\t\telse if (this.default === null) { // attribute does not exist\n\t\t\tthis.default = this.editor? this.editorValue : this.emptyValue;\n\t\t}\n\t\telse {\n\t\t\tnew Mavo.Observer(this.element, \"data-default\", record => {\n\t\t\t\tthis.default = this.element.getAttribute(\"data-default\");\n\t\t\t});\n\t\t}\n\n\t\tif (this.collection) {\n\t\t\t// Collection of primitives, deal with setting textContent etc without the UI interfering.\n\t\t\tvar swapUI = callback => {\n\t\t\t\tthis.sneak(() => {\n\t\t\t\t\tvar ui = $.remove($(\".mv-item-controls\", this.element));\n\n\t\t\t\t\tvar ret = callback();\n\n\t\t\t\t\t$.inside(ui, this.element);\n\t\t\t\t});\n\n\t\t\t\treturn ret;\n\t\t\t};\n\n\t\t\t// Intercept certain properties so that any Mavo UI inside this primitive will not be destroyed\n\t\t\t[\"textContent\", \"innerHTML\"].forEach(property => {\n\t\t\t\tvar descriptor = Object.getOwnPropertyDescriptor(Node.prototype, property);\n\n\t\t\t\tObject.defineProperty(this.element, property, {\n\t\t\t\t\tget: function() {\n\t\t\t\t\t\treturn swapUI(() => descriptor.get.call(this));\n\t\t\t\t\t},\n\n\t\t\t\t\tset: function(value) {\n\t\t\t\t\t\tswapUI(() => descriptor.set.call(this, value));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tif (!this.constant) {\n\t\t\tthis.setValue(this.templateValue, {silent: true});\n\t\t}\n\n\t\tthis.setValue(this.template? this.default : this.templateValue, {silent: true});\n\n\t\t// Observe future mutations to this property, if possible\n\t\t// Properties like input.checked or input.value cannot be observed that way\n\t\t// so we cannot depend on mutation observers for everything :(\n\t\tthis.observer = new Mavo.Observer(this.element, this.attribute, records => {\n\t\t\tif (this.attribute || !this.editing) {\n\t\t\t\tthis.value = this.getValue();\n\t\t\t}\n\t\t});\n\t},\n\n\tget editorValue() {\n\t\tif (this.getEditorValue) {\n\t\t\tvar value = this.getEditorValue();\n\n\t\t\tif (value !== undefined) {\n\t\t\t\treturn value;\n\t\t\t}\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\treturn _.getValue(this.editor, undefined, this.datatype);\n\t\t\t}\n\n\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\tif (output) {\n\t\t\t\treturn _.all.has(output)? _.all.get(output).value : _.getValue(output);\n\t\t\t}\n\t\t}\n\t},\n\n\tset editorValue(value) {\n\t\tif (this.setEditorValue && this.setEditorValue(value) !== undefined) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\t_.setValue(this.editor, value);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\t\tif (output) {\n\t\t\t\t\tif (_.all.has(output)) {\n\t\t\t\t\t\t_.all.get(output).value = value;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t_.setValue(output, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: this.super.getData.call(this, o)\n\t\t};\n\n\t\tif (env.data !== undefined) {\n\t\t\treturn env.data;\n\t\t}\n\n\t\tenv.data = this.value;\n\n\t\tif (env.data === \"\") {\n\t\t\tenv.data = null;\n\t\t}\n\n\t\tMavo.hooks.run(\"primitive-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\tsave: function() {\n\t\tthis.savedValue = this.value;\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tdone: function () {\n\t\tthis.super.done.call(this);\n\n\t\tthis.sneak(() => {\n\t\t\tif (this.popup) {\n\t\t\t\tthis.popup.close();\n\t\t\t}\n\t\t\telse if (!this.attribute && this.editing) {\n\t\t\t\t$.remove(this.editor);\n\t\t\t\tthis.element.textContent = this.editorValue;\n\t\t\t}\n\n\t\t\t// Revert tabIndex\n\t\t\tif (this.element._.data.prevTabindex !== null) {\n\t\t\t\tthis.element.tabIndex = this.element._.data.prevTabindex;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.element.removeAttribute(\"tabindex\");\n\t\t\t}\n\t\t});\n\t},\n\n\trevert: function() {\n\t\tif (this.unsavedChanges && this.savedValue !== undefined) {\n\t\t\t// FIXME if we have a collection of properties (notgroups), this will cause\n\t\t\t// cancel to not remove new unsaved items\n\t\t\t// This should be fixed by handling this on the collection level.\n\t\t\tthis.value = this.savedValue;\n\t\t\tthis.unsavedChanges = false;\n\t\t}\n\t},\n\n\tsneak: function(callback) {\n\t\tthis.observer? this.observer.sneak(callback) : callback();\n\t},\n\n\t// Called only the first time this primitive is edited\n\tinitEdit: function () {\n\t\tif (!this.editor) {\n\t\t\t// No editor provided, use default for element type\n\t\t\t// Find default editor for datatype\n\t\t\tvar editor = _.getMatch(this.element, _.editors);\n\n\t\t\tif (editor.create) {\n\t\t\t\t$.extend(this, editor, property => property != \"create\");\n\t\t\t}\n\n\t\t\tvar create = editor.create || editor;\n\t\t\tthis.editor = $.create($.type(create) === \"function\"? create.call(this) : create);\n\t\t\tthis.editorValue = this.value;\n\t\t\tthis.editorType = \"created\";\n\t\t}\n\n\t\t$.events(this.editor, {\n\t\t\t\"input change\": evt => {\n\t\t\t\tthis.value = this.editorValue;\n\t\t\t},\n\t\t\t\"focus\": evt => {\n\t\t\t\tthis.editor.select && this.editor.select();\n\t\t\t},\n\t\t\t\"mavo:datachange\": evt => {\n\t\t\t\tif (evt.property === \"output\") {\n\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t$.fire(this.editor, \"input\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (\"placeholder\" in this.editor) {\n\t\t\tthis.editor.placeholder = \"(\" + this.label + \")\";\n\t\t}\n\n\t\t// Copy any data-input-* attributes from the element to the editor\n\t\tvar dataInput = /^data-input-/i;\n\t\t$$(this.element.attributes).forEach(function (attribute) {\n\t\t\tif (dataInput.test(attribute.name)) {\n\t\t\t\tthis.editor.setAttribute(attribute.name.replace(dataInput, \"\"), attribute.value);\n\t\t\t}\n\t\t}, this);\n\n\t\tif (this.attribute) {\n\t\t\tthis.popup = new _.Popup(this);\n\t\t}\n\n\t\tif (!this.popup) {\n\t\t\tthis.editor.classList.add(\"mv-editor\");\n\t\t}\n\n\t\tthis.initEdit = null;\n\t},\n\n\tedit: function () {\n\t\tif (this.constant) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.super.edit.call(this);\n\n\t\t(new Promise((resolve, reject) => {\n\t\t\t// Prepare for edit\n\n\t\t\t// Empty properties should become editable immediately\n\t\t\t// otherwise they could be invisible!\n\t\t\tif (this.empty && !this.attribute) {\n\t\t\t\tresolve();\n\t\t\t}\n\n\t\t\tthis.element._.events({\n\t\t\t\t// click is needed too because it works with the keyboard as well\n\t\t\t\t\"click.mavo:preedit\": e => this.edit(),\n\t\t\t\t\"focus.mavo:preedit\": e => {\n\t\t\t\t\tresolve();\n\t\t\t\t},\n\t\t\t\t\"click.mavo:edit\": evt => {\n\t\t\t\t\t// Prevent default actions while editing\n\t\t\t\t\t// e.g. following links etc\n\t\t\t\t\tevt.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvar timer;\n\n\t\t\tif (!this.attribute) {\n\t\t\t\t// Hovering over the element for over 150ms will trigger edit\n\t\t\t\tthis.element._.events({\n\t\t\t\t\t\"mouseenter.mavo:preedit\": e => {\n\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t\ttimer = setTimeout(resolve, 150);\n\t\t\t\t\t},\n\t\t\t\t\t\"mouseleave.mavo:preedit\": e => {\n\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Make element focusable, so it can actually receive focus\n\t\t\tthis.element._.data.prevTabindex = this.element.getAttribute(\"tabindex\");\n\t\t\tthis.element.tabIndex = 0;\n\t\t})).then(() => {\n\t\t\t// Actual edit\n\t\t\tthis.element._.unbind(\".mavo:preedit\");\n\n\t\t\tif (this.initEdit) {\n\t\t\t\tthis.initEdit();\n\t\t\t}\n\n\t\t\tif (this.popup) {\n\t\t\t\tthis.popup.show();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.editor.focus();\n\t\t\t}\n\n\t\t\tif (!this.attribute) {\n\t\t\t\tif (this.editor.parentNode != this.element) {\n\t\t\t\t\tthis.editorValue = this.value;\n\t\t\t\t\tthis.element.textContent = \"\";\n\n\t\t\t\t\tthis.element.appendChild(this.editor);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}, // edit\n\n\tclear: function() {\n\t\tthis.value = this.emptyValue;\n\t},\n\n\trender: function(data) {\n\t\tif (Array.isArray(data)) {\n\t\t\tdata = data[0]; // TODO what is gonna happen to the rest? Lost?\n\t\t}\n\n\t\tif (typeof data === \"object\") {\n\t\t\tdata = data[this.property];\n\t\t}\n\n\t\tif (data === undefined) {\n\t\t\t// New property has been added to the schema and nobody has saved since\n\t\t\tthis.value = this.closestCollection? this.default : this.templateValue;\n\t\t}\n\t\telse {\n\t\t\tthis.value = data;\n\t\t}\n\n\t\tthis.save();\n\t},\n\n\tfind: function(property) {\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\t},\n\n\t/**\n\t * Get value from the DOM\n\t */\n\tgetValue: function(o) {\n\t\treturn _.getValue(this.element, this.attribute, this.datatype, o);\n\t},\n\n\tlazy: {\n\t\tlabel: function() {\n\t\t\treturn Mavo.readable(this.property);\n\t\t},\n\n\t\temptyValue: function() {\n\t\t\tswitch (this.datatype) {\n\t\t\t\tcase \"boolean\":\n\t\t\t\t\treturn false;\n\t\t\t\tcase \"number\":\n\t\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\treturn \"\";\n\t\t}\n\t},\n\n\tsetValue: function (value, o = {}) {\n\t\tthis.sneak(() => {\n\t\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\t\tvar presentational = value.presentational;\n\t\t\t\tvalue = value.value;\n\t\t\t}\n\n\t\t\tvalue = value || value === 0? value : \"\";\n\t\t\tvalue = _.safeCast(value, this.datatype);\n\n\t\t\tif (value == this._value && !o.force) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (this.editor && document.activeElement != this.editor) {\n\t\t\t\tthis.editorValue = value;\n\t\t\t}\n\n\t\t\tif (this.humanReadable && this.attribute) {\n\t\t\t\tpresentational = this.humanReadable(value);\n\t\t\t}\n\n\t\t\tif (!this.editing || this.attribute) {\n\t\t\t\tif (this.editor && this.editor.matches(\"select\") && this.editor.selectedOptions[0]) {\n\t\t\t\t\tpresentational = this.editor.selectedOptions[0].textContent;\n\t\t\t\t}\n\n\t\t\t\t_.setValue(this.element, {value, presentational}, this.attribute, this.datatype);\n\t\t\t}\n\n\t\t\tthis.empty = value === \"\";\n\n\t\t\tthis._value = value;\n\n\t\t\tif (!o.silent) {\n\t\t\t\tif (this.saved) {\n\t\t\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t\t\t}\n\n\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\t$.fire(this.element, \"mavo:datachange\", {\n\t\t\t\t\t\tproperty: this.property,\n\t\t\t\t\t\tvalue: value,\n\t\t\t\t\t\tmavo: this.mavo,\n\t\t\t\t\t\tnode: this,\n\t\t\t\t\t\taction: \"propertychange\"\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\treturn value;\n\t},\n\n\tlive: {\n\t\tvalue: function (value) {\n\t\t\treturn this.setValue(value);\n\t\t},\n\n\t\tempty: function (value) {\n\t\t\tvar hide = value && // is empty\n\t\t\t!this.constant && // and editable\n\t\t\t!(this.attribute && $(Mavo.selectors.property, this.element)); // and has no property inside\n\n\t\t\tthis.element.classList.toggle(\"empty\", hide);\n\t\t},\n\n\t\tconstant: function (value) {\n\t\t\tthis.element.classList.toggle(\"mv-constant\", value);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tgetMatch: function (element, all) {\n\t\t\t// TODO specificity\n\t\t\tvar ret = null;\n\n\t\t\tfor (var selector in all) {\n\t\t\t\tif (element.matches(selector)) {\n\t\t\t\t\tret = all[selector];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\tgetValueAttribute: function (element) {\n\t\t\tvar ret = element.getAttribute(\"data-attribute\") || _.getMatch(element, _.attributes);\n\n\t\t\t// TODO refactor this\n\t\t\tif (ret && ret.value) {\n\t\t\t\tret = $.extend(new String(ret.value), ret);\n\t\t\t}\n\n\t\t\tif (!ret || ret === \"null\") {\n\t\t\t\tret = null;\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\tgetDatatype: function (element, attribute) {\n\t\t\tvar ret = element.getAttribute(\"datatype\");\n\n\t\t\tif (!ret) {\n\t\t\t\tfor (var selector in _.datatypes) {\n\t\t\t\t\tif (element.matches(selector)) {\n\t\t\t\t\t\tret = _.datatypes[selector][attribute];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tret = ret || \"string\";\n\n\t\t\treturn ret;\n\t\t},\n\n\t\t/**\n\t\t * Only cast if conversion is lossless\n\t\t */\n\t\tsafeCast: function(value, datatype) {\n\t\t\tvar existingType = typeof value;\n\t\t\tvar cast = _.cast(value, datatype);\n\n\t\t\tif (value === null || value === undefined) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"boolean\") {\n\t\t\t\tif (value === \"false\" || value === 0 || value === \"\") {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif (value === \"true\" || value > 0) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"number\") {\n\t\t\t\tif (/^[-+]?[0-9.e]+$/i.test(value + \"\")) {\n\t\t\t\t\treturn cast;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\treturn cast;\n\t\t},\n\n\t\t/**\n\t\t * Cast to a different primitive datatype\n\t\t */\n\t\tcast: function(value, datatype) {\n\t\t\tswitch (datatype) {\n\t\t\t\tcase \"number\": return +value;\n\t\t\t\tcase \"boolean\": return !!value;\n\t\t\t\tcase \"string\": return value + \"\";\n\t\t\t}\n\n\t\t\treturn value;\n\t\t},\n\n\t\tgetValue: function (element, attribute, datatype, o = {}) {\n\t\t\tattribute = attribute || attribute === null? attribute : _.getValueAttribute(element);\n\t\t\tdatatype = datatype || _.getDatatype(element, attribute);\n\n\t\t\tvar ret;\n\n\t\t\tif (attribute in element && _.useProperty(element, attribute)) {\n\t\t\t\t// Returning properties (if they exist) instead of attributes\n\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\tret = element[attribute];\n\t\t\t}\n\t\t\telse if (attribute) {\n\t\t\t\tret = element.getAttribute(attribute);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tret = element.getAttribute(\"content\") || element.textContent || null;\n\t\t\t}\n\n\t\t\treturn _.safeCast(ret, datatype);\n\t\t},\n\n\t\tsetValue: function (element, value, attribute, datatype) {\n\t\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\t\tvar presentational = value.presentational;\n\t\t\t\tvalue = value.value;\n\t\t\t}\n\n\t\t\tif (attribute !== null) {\n\t\t\t\tattribute = attribute ||  _.getValueAttribute(element);\n\t\t\t}\n\n\t\t\tif (attribute in element && _.useProperty(element, attribute) && element[attribute] != value) {\n\t\t\t\t// Setting properties (if they exist) instead of attributes\n\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\ttry {\n\t\t\t\t\telement[attribute] = value;\n\t\t\t\t}\n\t\t\t\tcatch (e) {}\n\t\t\t}\n\n\t\t\t// Set attribute anyway, even if we set a property because when\n\t\t\t// they're not in sync it gets really fucking confusing.\n\t\t\tif (attribute) {\n\t\t\t\tif (datatype == \"boolean\") {\n\t\t\t\t\tif (value != element.hasAttribute(attribute)) {\n\t\t\t\t\t\t$.toggleAttribute(element, attribute, value, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (element.getAttribute(attribute) != value) {  // intentionally non-strict, e.g. \"3.\" !== 3\n\t\t\t\t\telement.setAttribute(attribute, value);\n\n\t\t\t\t\tif (presentational) {\n\t\t\t\t\t\telement.textContent = presentational;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (datatype === \"number\" && !presentational) {\n\t\t\t\t\tpresentational = _.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\telement.textContent = presentational || value;\n\n\t\t\t\tif (presentational && element.setAttribute) {\n\t\t\t\t\telement.setAttribute(\"content\", value);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t *  Set/get a property or an attribute?\n\t\t * @return {Boolean} true to use a property, false to use the attribute\n\t\t */\n\t\tuseProperty: function(element, attribute) {\n\t\t\tif ([\"href\", \"src\"].indexOf(attribute) > -1) {\n\t\t\t\t// URL properties resolve \"\" as location.href, fucking up emptiness checks\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (element.namespaceURI == \"http://www.w3.org/2000/svg\") {\n\t\t\t\t// SVG has a fucked up DOM, do not use these properties\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\n\t\tregister: function(selector, o = {}) {\n\t\t\tif (o.attribute) {\n\t\t\t\tMavo.Primitive.attributes[selector] = o.attribute;\n\t\t\t}\n\n\t\t\tif (o.datatype) {\n\t\t\t\tMavo.Primitive.datatypes[selector] = o.datatype;\n\t\t\t}\n\n\t\t\tif (o.editor) {\n\t\t\t\tMavo.Primitive.editors[selector] = o.editor;\n\t\t\t}\n\n\t\t\tif (o.init) {\n\t\t\t\tMavo.hooks.add(\"primitive-init-start\", function() {\n\t\t\t\t\tif (this.element.matches(selector)) {\n\t\t\t\t\t\to.init.call(this, this.element);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tfor (let id of Mavo.toArray(o.is)) {\n\t\t\t\tMavo.selectors[id] += \", \" + selector;\n\t\t\t}\n\t\t},\n\n\t\tlazy: {\n\t\t\tformatNumber: () => {\n\t\t\t\tvar numberFormat = new Intl.NumberFormat(\"en-US\", {maximumFractionDigits:2});\n\n\t\t\t\treturn function(value) {\n\t\t\t\t\tif (value === Infinity || value === -Infinity) {\n\t\t\t\t\t\t// Pretty print infinity\n\t\t\t\t\t\treturn value < 0? \"-∞\" : \"∞\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn numberFormat.format(value);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n});\n\n// Define default attributes\n_.attributes = {\n\t\"img, video, audio\": \"src\",\n\t\"a, link\": \"href\",\n\t\"select, input, meter, progress\": \"value\",\n\t\"input[type=checkbox]\": \"checked\",\n\t\"time\": {\n\t\tvalue: \"datetime\",\n\t\thumanReadable: function (value) {\n\t\t\tvar date = new Date(value);\n\n\t\t\tif (!value || isNaN(date)) {\n\t\t\t\treturn \"(No \" + this.label + \")\";\n\t\t\t}\n\n\t\t\t// TODO do this properly (account for other datetime datatypes and different formats)\n\t\t\tvar options = {\n\t\t\t\t\"date\": {day: \"numeric\", month: \"short\", year: \"numeric\"},\n\t\t\t\t\"month\": {month: \"long\"},\n\t\t\t\t\"time\": {hour: \"numeric\", minute: \"numeric\"},\n\t\t\t\t\"datetime-local\": {day: \"numeric\", month: \"short\", year: \"numeric\", hour: \"numeric\", minute: \"numeric\"}\n\t\t\t};\n\n\t\t\tvar format = options[this.editor && this.editor.type] || options.date;\n\t\t\tformat.timeZone = \"UTC\";\n\n\t\t\treturn date.toLocaleString(\"en-GB\", format);\n\t\t}\n\t},\n\t\"meta\": \"content\"\n};\n\n// Basic datatypes per attribute\n// Only number, boolean\n_.datatypes = {\n\t\"input[type=checkbox]\": {\n\t\t\"checked\": \"boolean\"\n\t},\n\t\"input[type=range], input[type=number], meter, progress\": {\n\t\t\"value\": \"number\"\n\t}\n};\n\n_.editors = {\n\t\"*\": {\"tag\": \"input\"},\n\n\t\".number\": {\n\t\t\"tag\": \"input\",\n\t\t\"type\": \"number\"\n\t},\n\n\t\".boolean\": {\n\t\t\"tag\": \"input\",\n\t\t\"type\": \"checkbox\"\n\t},\n\n\t\"a, img, video, audio, .url\": {\n\t\t\"tag\": \"input\",\n\t\t\"type\": \"url\",\n\t\t\"placeholder\": \"http://\"\n\t},\n\n\t// Block elements\n\t\"p, div, li, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address, .multiline\": {\n\t\tcreate: function() {\n\t\t\tvar display = getComputedStyle(this.element).display;\n\t\t\tvar tag = display.indexOf(\"inline\") === 0? \"input\" : \"textarea\";\n\t\t\tvar editor = $.create(tag);\n\n\t\t\tif (tag == \"textarea\") {\n\t\t\t\t// Actually multiline\n\t\t\t\tvar width = this.element.offsetWidth;\n\n\t\t\t\tif (width) {\n\t\t\t\t\teditor.width = width;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn editor;\n\t\t},\n\n\t\tsetEditorValue: function(value) {\n\t\t\tif (this.datatype != \"string\") {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar cs = getComputedStyle(this.element);\n\t\t\tvalue = value || \"\";\n\n\t\t\tif ([\"normal\", \"nowrap\"].indexOf(cs.whiteSpace) > -1) {\n\t\t\t\t// Collapse lines\n\t\t\t\tvalue = value.replace(/\\r?\\n/g, \" \");\n\t\t\t}\n\n\t\t\tif ([\"normal\", \"nowrap\", \"pre-line\"].indexOf(cs.whiteSpace) > -1) {\n\t\t\t\t// Collapse whitespace\n\t\t\t\tvalue = value.replace(/^[ \\t]+|[ \\t]+$/gm, \"\").replace(/[ \\t]+/g, \" \");\n\t\t\t}\n\n\t\t\tthis.editor.value = value;\n\t\t\treturn true;\n\t\t}\n\t},\n\n\t\"meter, progress\": function() {\n\t\treturn $.create({\n\t\t\ttag: \"input\",\n\t\t\ttype: \"range\",\n\t\t\tmin: this.element.getAttribute(\"min\") || 0,\n\t\t\tmax: this.element.getAttribute(\"max\") || 100\n\t\t});\n\t},\n\n\t\"time, .date\": function() {\n\t\tvar types = {\n\t\t\t\"date\": /^[Y\\d]{4}-[M\\d]{2}-[D\\d]{2}$/i,\n\t\t\t\"month\": /^[Y\\d]{4}-[M\\d]{2}$/i,\n\t\t\t\"time\": /^[H\\d]{2}:[M\\d]{2}/i,\n\t\t\t\"week\": /[Y\\d]{4}-W[W\\d]{2}$/i,\n\t\t\t\"datetime-local\": /^[Y\\d]{4}-[M\\d]{2}-[D\\d]{2} [H\\d]{2}:[M\\d]{2}/i\n\t\t};\n\n\t\tvar datetime = this.element.getAttribute(\"datetime\") || \"YYYY-MM-DD\";\n\n\t\tfor (var type in types) {\n\t\t\tif (types[type].test(datetime)) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn $.create(\"input\", {type: type});\n\t}\n};\n\n_.Popup = $.Class({\n\tconstructor: function(primitive) {\n\t\tthis.primitive = primitive;\n\n\t\tthis.popup = $.create(\"div\", {\n\t\t\tclassName: \"mv-popup\",\n\t\t\thidden: true,\n\t\t\tcontents: [\n\t\t\t\tthis.primitive.label + \":\",\n\t\t\t\tthis.editor\n\t\t\t],\n\t\t\tevents: {\n\t\t\t\tkeyup: evt => {\n\t\t\t\t\tif (evt.keyCode == 13 || evt.keyCode == 27) {\n\t\t\t\t\t\tif (this.popup.contains(document.activeElement)) {\n\t\t\t\t\t\t\tthis.element.focus();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t\tthis.hide();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// No point in having a dropdown in a popup\n\t\tif (this.editor.matches(\"select\")) {\n\t\t\tthis.editor.size = Math.min(10, this.editor.children.length);\n\t\t}\n\t},\n\n\tshow: function() {\n\t\t$.unbind([this.element, this.popup], \".mavo:showpopup\");\n\n\t\tthis.shown = true;\n\n\t\tthis.hideCallback = evt => {\n\t\t\tif (!this.popup.contains(evt.target) && !this.element.contains(evt.target)) {\n\t\t\t\tthis.hide();\n\t\t\t}\n\t\t};\n\n\t\tthis.position = evt => {\n\t\t\tvar bounds = this.element.getBoundingClientRect();\n\t\t\tvar x = bounds.left;\n\t\t\tvar y = bounds.bottom;\n\n\t\t\t // TODO what if it doesn’t fit?\n\t\t\t$.style(this.popup, { top:  `${y}px`, left: `${x}px` });\n\t\t};\n\n\t\tthis.position();\n\n\t\tdocument.body.appendChild(this.popup);\n\n\t\trequestAnimationFrame(e => this.popup.removeAttribute(\"hidden\")); // trigger transition\n\n\t\t$.events(document, \"focus click\", this.hideCallback, true);\n\t\twindow.addEventListener(\"scroll\", this.position);\n\t},\n\n\thide: function() {\n\t\t$.unbind(document, \"focus click\", this.hideCallback, true);\n\t\twindow.removeEventListener(\"scroll\", this.position);\n\t\tthis.popup.setAttribute(\"hidden\", \"\"); // trigger transition\n\t\tthis.shown = false;\n\n\t\tsetTimeout(() => {\n\t\t\t$.remove(this.popup);\n\t\t}, parseFloat(getComputedStyle(this.popup).transitionDuration) * 1000 || 400); // TODO transition-duration could override this\n\n\t\t$.events(this.element, {\n\t\t\t\"click.mavo:showpopup\": evt => {\n\t\t\t\tthis.show();\n\t\t\t},\n\t\t\t\"keyup.mavo:showpopup\": evt => {\n\t\t\t\tif ([13, 113].indexOf(evt.keyCode) > -1) { // Enter or F2\n\t\t\t\t\tthis.show();\n\t\t\t\t\tthis.editor.focus();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\tclose: function() {\n\t\tthis.hide();\n\t\t$.unbind(this.element, \".mavo:edit .mavo:preedit .mavo:showpopup\");\n\t},\n\n\tproxy: {\n\t\t\"editor\": \"primitive\",\n\t\t\"element\": \"primitive\"\n\t}\n});\n\n})(Bliss, Bliss.$);\n\n// Example plugin: button\nMavo.Primitive.register(\"button, .counter\", {\n\tattribute: \"data-clicked\",\n\tdatatype: \"number\",\n\tis: \"formControl\",\n\tinit: function(element) {\n\t\tif (this.attribute === \"data-clicked\") {\n\t\t\telement.setAttribute(\"data-clicked\", \"0\");\n\n\t\t\telement.addEventListener(\"click\", evt => {\n\t\t\t\tlet clicked = +element.getAttribute(\"data-clicked\") || 0;\n\t\t\t\tthis.value = ++clicked;\n\t\t\t});\n\t\t}\n\t}\n});\n"],"sourceRoot":"/source/"}