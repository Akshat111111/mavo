{"version":3,"sources":["collection.js"],"names":[],"mappings":"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","file":"mavo.es5.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.items = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.items.length;\n\t},\n\n\t// Collection still contains its template as data\n\tget containsTemplate() {\n\t\treturn this.items.length && this.items[0].element === this.element;\n\t},\n\n\tgetData: function(o) {\n\t\to = o || {};\n\n\t\tvar data = [];\n\n\t\tthis.items.forEach(item => {\n\t\t\tif (!item.deleted) {\n\t\t\t\tvar itemData = item.getData(o);\n\n\t\t\t\tif (itemData) {\n\t\t\t\t\tdata.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (!o.dirty && this.unhandled) {\n\t\t\tdata = this.unhandled.before.concat(data, this.unhandled.after);\n\t\t}\n\n\t\treturn data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Unit.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type,\n\t\t\tdirty: true\n\t\t});\n\n\t\t// Add delete & add buttons\n\t\tif (this.mutable) {\n\t\t\tthis.mavo.permissions.can(\"edit\", () => {\n\t\t\t\t$.create({\n\t\t\t\t\tclassName: \"mv-item-controls mv-ui\",\n\t\t\t\t\tcontents: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttitle: \"Delete this \" + this.name,\n\t\t\t\t\t\t\tclassName: \"delete\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\"click\": evt => this.delete(item)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttitle: `Add new ${this.name.replace(/s$/i, \"\")} ${this.bottomUp? \"after\" : \"before\"}`,\n\t\t\t\t\t\t\tclassName: \"add\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\"click\": evt => this.add(null, this.items.indexOf(item)).edit()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\tinside: element\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Unit} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Unit.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (index in this.items) {\n\t\t\tif (this.bottomUp) {\n\t\t\t\tindex++;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t}\n\n\t\tif (!item.element.parentNode) {\n\t\t\t// Add it to the DOM, if not already in\n\t\t\tvar nextItem = this.items[index];\n\n\t\t\titem.element._.before(nextItem && nextItem.element || this.marker);\n\t\t}\n\n\t\t// Update internal data model\n\t\tthis.items.splice(index, 0, item);\n\n\t\tfor (let i = index - 1; i < this.length; i++) {\n\t\t\tlet item = this.items[i];\n\n\t\t\tif (item) {\n\t\t\t\titem.index = i;\n\n\t\t\t\tif (!o.silent) {\n\t\t\t\t\titem.element._.fire(\"mavo:datachange\", {\n\t\t\t\t\t\tnode: this,\n\t\t\t\t\t\tmavo: this.mavo,\n\t\t\t\t\t\taction: \"add\",\n\t\t\t\t\t\titem\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!o.silent) {\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t}\n\n\t\treturn item;\n\t},\n\n\tpropagate: function() {\n\t\tthis.items.forEach(item => item.call.apply(item, arguments));\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.items.splice(this.items.indexOf(item), 1);\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.element._.fire(\"mavo:datachange\", {\n\t\t\t\tnode: this,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\taction: \"delete\",\n\t\t\t\titem: item\n\t\t\t});\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\tedit: function() {\n\t\tif (this.length === 0 && this.required) {\n\t\t\t// Nested collection with no items, add one\n\t\t\tvar item = this.add(null, null, true);\n\n\t\t\titem.placeholder = true;\n\t\t\titem.walk(obj => obj.unsavedChanges = false);\n\n\t\t\t$.once(item.element, \"mavo:datachange\", evt => {\n\t\t\t\titem.unsavedChanges = true;\n\t\t\t\titem.placeholder = false;\n\t\t\t});\n\t\t}\n\n\t\tthis.propagate(obj => obj[obj.preEdit? \"preEdit\" : \"edit\"]());\n\t},\n\n\t/**\n\t * Delete all items in the collection.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.element.remove) {\n\t\t\t\t\titem.element.remove();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Document fragment, remove all children\n\t\t\t\t\tfor (let node of item.element.childNodes) {\n\t\t\t\t\t\tnode => node.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.items = [];\n\n\t\t\tthis.marker._.fire(\"mavo:datachange\", {\n\t\t\t\tnode: this,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\taction: \"clear\"\n\t\t\t});\n\t\t}\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.items) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = item.dirty = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tdone: function() {\n\t\tfor (let item of this.items) {\n\t\t\tif (item.placeholder) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\", \"done\"],\n\n\trevert: function() {\n\t\tfor (let item of this.items) {\n\t\t\t// Delete added items\n\t\t\tif (item.unsavedChanges && !item.placeholder) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Bring back deleted items\n\t\t\t\tif (item.deleted) {\n\t\t\t\t\titem.deleted = false;\n\t\t\t\t}\n\n\t\t\t\t// Revert all properties\n\t\t\t\titem.revert();\n\t\t\t}\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tthis.unhandled = {before: [], after: []};\n\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.items.forEach((item, i) => item.render(data && data[i]));\n\n\t\t\tif (data) {\n\t\t\t\tthis.unhandled.after = data.slice(this.items.length);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.clear();\n\n\t\t\t// Using document fragments improved rendering performance by 60%\n\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\tdata.forEach((datum, i) => {\n\t\t\t\tvar item = this.createItem();\n\n\t\t\t\titem.render(datum);\n\n\t\t\t\tthis.items.push(item);\n\t\t\t\titem.index = i;\n\n\t\t\t\tfragment.appendChild(item.element);\n\t\t\t});\n\n\t\t\tthis.marker.parentNode.insertBefore(fragment, this.marker);\n\t\t}\n\n\t\tthis.save();\n\t},\n\n\tfind: function(property) {\n\t\tvar items = this.items.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has data-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\tthis.mavo.needsEdit = true;\n\n\t\t\t\tthis.required = this.templateElement.matches(Mavo.selectors.required);\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = $.create(\"div\", {\n\t\t\t\t\thidden: true,\n\t\t\t\t\tclassName: \"mv-marker\",\n\t\t\t\t\tafter: this.templateElement\n\t\t\t\t});\n\n\t\t\t\tthis.templateElement.classList.add(\"mv-item\");\n\n\t\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\t\tthis.addButton._.before($.value(this.items[0], \"element\") || this.marker);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\n\t\t\t\t\t\tif (containerSelector) {\n\t\t\t\t\t\t\tvar after = this.marker.closest(containerSelector);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.addButton._.after(after && after.parentNode? after : this.marker);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"data-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.templateElement) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.item);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.add-${this.property}`;\n\t\t\tvar scope = this.closestCollection || this.marker.closest(Mavo.selectors.scope);\n\n\t\t\tif (scope) {\n\t\t\t\tvar button = $$(selector, scope).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.add().edit();\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}