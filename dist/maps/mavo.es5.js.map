{"version":3,"sources":["expression.js"],"names":[],"mappings":"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","file":"mavo.es5.js","sourcesContent":["(function($, $$) {\n\nMavo.attributes.push(\"mv-expressions\", \"mv-value\", \"mv-if\");\n\nvar _ = Mavo.Expression = $.Class({\n\tconstructor: function(expression) {\n\t\tthis.expression = expression;\n\t},\n\n\teval: function(data) {\n\t\tthis.oldValue = this.value;\n\n\t\tMavo.hooks.run(\"expression-eval-beforeeval\", this);\n\n\t\ttry {\n\t\t\tif (!this.function) {\n\t\t\t\tthis.function = _.compile(this.expression);\n\t\t\t}\n\n\t\t\tthis.value = this.function(data);\n\t\t}\n\t\tcatch (exception) {\n\t\t\tMavo.hooks.run(\"expression-eval-error\", {context: this, exception});\n\n\t\t\tthis.value = exception;\n\t\t}\n\n\t\treturn this.value;\n\t},\n\n\ttoString() {\n\t\treturn this.expression;\n\t},\n\n\tlive: {\n\t\texpression: function(value) {\n\t\t\tvar code = value = value;\n\n\t\t\tthis.function = null;\n\t\t}\n\t},\n\n\tstatic: {\n\t\t/**\n\t\t * These serializers transform the AST into JS\n\t\t */\n\t\tserializers: {\n\t\t\t\"BinaryExpression\": node => `${_.serialize(node.left)} ${node.operator} ${_.serialize(node.right)}`,\n\t\t\t\"UnaryExpression\": node => `${node.operator}${_.serialize(node.argument)}`,\n\t\t\t\"CallExpression\": node => `${_.serialize(node.callee)}(${node.arguments.map(_.serialize).join(\", \")})`,\n\t\t\t\"ConditionalExpression\": node => `${_.serialize(node.test)}? ${_.serialize(node.consequent)} : ${_.serialize(node.alternate)}`,\n\t\t\t\"MemberExpression\": node => `${_.serialize(node.object)}[\"${node.property.name || node.property.value}\"]`,\n\t\t\t\"ArrayExpression\": node => `[${node.elements.map(_.serialize).join(\", \")}]`,\n\t\t\t\"Literal\": node => node.raw,\n\t\t\t\"Identifier\": node => node.name,\n\t\t\t\"ThisExpression\": node => \"this\",\n\t\t\t\"Compound\": node => node.body.map(_.serialize).join(\" \")\n\t\t},\n\n\t\t/**\n\t\t * These are run before the serializers and transform the expression to support MavoScript\n\t\t */\n\t\ttransformations: {\n\t\t\t\"BinaryExpression\": node => {\n\t\t\t\tlet name = Mavo.Script.getOperatorName(node.operator);\n\t\t\t\tlet details = Mavo.Script.operators[name];\n\n\t\t\t\t// Flatten same operator calls\n\t\t\t\tvar nodeLeft = node;\n\t\t\t\tvar args = [];\n\n\t\t\t\tdo {\n\t\t\t\t\targs.unshift(nodeLeft.right);\n\t\t\t\t\tnodeLeft = nodeLeft.left;\n\t\t\t\t} while (Mavo.Script.getOperatorName(nodeLeft.operator) === name);\n\n\t\t\t\targs.unshift(nodeLeft);\n\n\t\t\t\tif (args.length > 1) {\n\t\t\t\t\treturn `${name}(${args.map(_.serialize).join(\", \")})`;\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"CallExpression\": node => {\n\t\t\t\tif (node.callee.type == \"Identifier\" && node.callee.name == \"if\") {\n\t\t\t\t\tnode.callee.name = \"iff\";\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\tserialize: node => {\n\t\t\tif (_.transformations[node.type]) {\n\t\t\t\tvar ret = _.transformations[node.type](node);\n\n\t\t\t\tif (ret !== undefined) {\n\t\t\t\t\treturn ret;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn _.serializers[node.type](node);\n\t\t},\n\n\t\trewrite: function(code) {\n\t\t\ttry {\n\t\t\t\treturn _.serialize(_.parse(code));\n\t\t\t}\n\t\t\tcatch (e) {\n\t\t\t\t// Parsing as MavoScript failed, falling back to plain JS\n\t\t\t\treturn code;\n\t\t\t}\n\t\t},\n\n\t\tcompile: function(code) {\n\t\t\tcode = _.rewrite(code);\n\n\t\t\treturn new Function(\"data\", `with(Mavo.Functions._Trap)\n\t\t\t\t\twith(data) {\n\t\t\t\t\t\treturn ${code};\n\t\t\t\t\t}`);\n\t\t},\n\n\t\tparse: self.jsep,\n\t}\n});\n\nif (self.jsep) {\n\tjsep.addBinaryOp(\"and\", 2);\n\tjsep.addBinaryOp(\"or\", 2);\n\tjsep.addBinaryOp(\"=\", 6);\n\tjsep.removeBinaryOp(\"===\");\n}\n\n_.serializers.LogicalExpression = _.serializers.BinaryExpression;\n_.transformations.LogicalExpression = _.transformations.BinaryExpression;\n\n(function() {\nvar _ = Mavo.Expression.Syntax = $.Class({\n\tconstructor: function(start, end) {\n\t\tthis.start = start;\n\t\tthis.end = end;\n\t\tthis.regex = RegExp(`${Mavo.escapeRegExp(start)}([\\\\S\\\\s]+?)${Mavo.escapeRegExp(end)}`, \"gi\");\n\t},\n\n\ttest: function(str) {\n\t\tthis.regex.lastIndex = 0;\n\n\t\treturn this.regex.test(str);\n\t},\n\n\ttokenize: function(str) {\n\t\tvar match, ret = [], lastIndex = 0;\n\n\t\tthis.regex.lastIndex = 0;\n\n\t\twhile ((match = this.regex.exec(str)) !== null) {\n\t\t\t// Literal before the expression\n\t\t\tif (match.index > lastIndex) {\n\t\t\t\tret.push(str.substring(lastIndex, match.index));\n\t\t\t}\n\n\t\t\tlastIndex = this.regex.lastIndex;\n\n\t\t\tret.push(new Mavo.Expression(match[1]));\n\t\t}\n\n\t\t// Literal at the end\n\t\tif (lastIndex < str.length) {\n\t\t\tret.push(str.substring(lastIndex));\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\tstatic: {\n\t\tcreate: function(element) {\n\t\t\tif (element) {\n\t\t\t\tvar syntax = element.getAttribute(\"mv-expressions\");\n\n\t\t\t\tif (syntax) {\n\t\t\t\t\tsyntax = syntax.trim();\n\t\t\t\t\treturn /\\s/.test(syntax)? new _(...syntax.split(/\\s+/)) : _.ESCAPE;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\tESCAPE: -1\n\t}\n});\n\n_.default = new _(\"[\", \"]\");\n\n})();\n\n(function() {\n\nvar _ = Mavo.Expression.Text = $.Class({\n\tconstructor: function(o) {\n\t\tthis.group = o.group;\n\t\tthis.node = o.node;\n\t\tthis.path = o.path;\n\t\tthis.syntax = o.syntax;\n\t\tthis.fallback = o.fallback;\n\n\t\tif (!this.node) {\n\t\t\t// No node provided, figure it out from path\n\t\t\tthis.node = this.path.reduce((node, index) => {\n\t\t\t\treturn node.childNodes[index];\n\t\t\t}, this.group.element);\n\t\t}\n\n\t\tthis.element = this.node;\n\t\tthis.attribute = o.attribute || null;\n\n\t\tMavo.hooks.run(\"expressiontext-init-start\", this);\n\n\t\tif (!this.expression) { // Still unhandled?\n\t\t\tif (this.node.nodeType === 3) {\n\t\t\t\tthis.element = this.node.parentNode;\n\n\t\t\t\t// If no element siblings make this.node the element, which is more robust\n\t\t\t\t// Same if attribute, there are no attributes on a text node!\n\t\t\t\tif (!this.node.parentNode.children.length || this.attribute) {\n\t\t\t\t\tthis.node = this.element;\n\t\t\t\t\tthis.element.normalize();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.attribute) {\n\t\t\t\tthis.expression = this.node.getAttribute(this.attribute).trim();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Move whitespace outside to prevent it from messing with types\n\t\t\t\tthis.node.normalize();\n\n\t\t\t\tif (this.node.firstChild && this.node.childNodes.length === 1 && this.node.firstChild.nodeType === 3) {\n\t\t\t\t\tvar whitespace = this.node.firstChild.textContent.match(/^\\s*|\\s*$/g);\n\n\t\t\t\t\tif (whitespace[1]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(this.node.firstChild.textContent.length - whitespace[1].length);\n\t\t\t\t\t\t$.after(this.node.lastChild, this.node);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (whitespace[0]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(whitespace[0].length);\n\t\t\t\t\t\tthis.node.parentNode.insertBefore(this.node.firstChild, this.node);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.expression = this.node.textContent;\n\t\t\t}\n\n\n\t\t\tthis.template = o.template? o.template.template : this.syntax.tokenize(this.expression);\n\t\t}\n\n\t\tMavo.hooks.run(\"expressiontext-init-end\", this);\n\n\t\t_.elements.set(this.element, [...(_.elements.get(this.element) || []), this]);\n\t},\n\n\tupdate: function(data = this.data) {\n\t\tthis.data = data;\n\n\t\tvar ret = {};\n\n\t\tMavo.hooks.run(\"expressiontext-update-start\", this);\n\n\t\tret.value = this.value = this.template.map(expr => {\n\t\t\tif (expr instanceof Mavo.Expression) {\n\t\t\t\tvar env = {context: this, expr};\n\n\t\t\t\tMavo.hooks.run(\"expressiontext-update-beforeeval\", env);\n\n\t\t\t\tenv.value = env.expr.eval(data);\n\n\t\t\t\tMavo.hooks.run(\"expressiontext-update-aftereval\", env);\n\n\t\t\t\tif (env.value instanceof Error) {\n\t\t\t\t\treturn this.fallback !== undefined? this.fallback : env.expr.expression;\n\t\t\t\t}\n\t\t\t\tif (env.value === undefined || env.value === null) {\n\t\t\t\t\t// Don’t print things like \"undefined\" or \"null\"\n\t\t\t\t\treturn \"\";\n\t\t\t\t}\n\n\t\t\t\treturn env.value;\n\t\t\t}\n\n\t\t\treturn expr;\n\t\t});\n\n\t\tif (!this.attribute) {\n\t\t\t// Separate presentational & actual values only apply when content is variable\n\t\t\tret.presentational = this.value.map(value => {\n\t\t\t\tif (Array.isArray(value)) {\n\t\t\t\t\treturn value.join(\", \");\n\t\t\t\t}\n\n\t\t\t\tif (typeof value == \"number\") {\n\t\t\t\t\treturn Mavo.Primitive.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t});\n\n\t\t\tret.presentational = ret.presentational.length === 1? ret.presentational[0] : ret.presentational.join(\"\");\n\t\t}\n\n\t\tret.value = ret.value.length === 1? ret.value[0] : ret.value.join(\"\");\n\n\t\tif (this.primitive && this.template.length === 1) {\n\t\t\tif (typeof ret.value === \"number\") {\n\t\t\t\tthis.primitive.datatype = \"number\";\n\t\t\t}\n\t\t\telse if (typeof ret.value === \"boolean\") {\n\t\t\t\tthis.primitive.datatype = \"boolean\";\n\t\t\t}\n\t\t}\n\n\t\tif (ret.presentational === ret.value) {\n\t\t\tret = ret.value;\n\t\t}\n\n\t\tif (this.primitive) {\n\t\t\tthis.primitive.value = ret;\n\t\t}\n\t\telse {\n\t\t\tMavo.Primitive.setValue(this.node, ret, {attribute: this.attribute});\n\t\t}\n\n\t\tMavo.hooks.run(\"expressiontext-update-end\", this);\n\t},\n\n\tstatic: {\n\t\telements: new WeakMap(),\n\n\t\t/**\n\t\t * Search for Mavo.Expression.Text object(s) associated with a given element\n\t\t * and optionally an attribute.\n\t\t *\n\t\t * @return If one argument, array of matching Expression.Text objects.\n\t\t *         If two arguments, the matching Expression.Text object or null\n\t\t */\n\t\tsearch: function(element, attribute) {\n\t\t\tvar all = _.elements.get(element) || [];\n\n\t\t\tif (arguments.length > 1) {\n\t\t\t\tif (!all.length) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn all.filter(et => et.attribute === attribute)[0] || null;\n\t\t\t}\n\n\t\t\treturn all;\n\t\t}\n\t}\n});\n\n})();\n\n(function() {\n\nvar _ = Mavo.Expressions = $.Class({\n\tconstructor: function(group) {\n\t\tif (group) {\n\t\t\tthis.group = group;\n\t\t\tthis.group.expressions = this;\n\t\t}\n\n\t\tthis.all = []; // all Expression.Text objects in this group\n\n\t\tMavo.hooks.run(\"expressions-init-start\", this);\n\n\t\tif (this.group) {\n\t\t\tvar template = this.group.template;\n\n\t\t\tif (template && template.expressions) {\n\t\t\t\t// We know which expressions we have, don't traverse again\n\t\t\t\tfor (let et of template.expressions.all) {\n\t\t\t\t\tthis.all.push(new Mavo.Expression.Text({\n\t\t\t\t\t\tpath: et.path,\n\t\t\t\t\t\tsyntax: et.syntax,\n\t\t\t\t\t\tattribute: et.attribute,\n\t\t\t\t\t\tgroup: this.group,\n\t\t\t\t\t\ttemplate: et\n\t\t\t\t\t}));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tvar syntax = Mavo.Expression.Syntax.create(this.group.element.closest(\"[mv-expressions]\")) || Mavo.Expression.Syntax.default;\n\t\t\t\tthis.traverse(this.group.element, undefined, syntax);\n\t\t\t}\n\t\t}\n\n\t\tthis.dependents = new Set();\n\n\t\tthis.active = true;\n\n\t\t// Watch changes and update value\n\t\tthis.group.element.addEventListener(\"mavo:datachange\", evt => this.update());\n\t},\n\n\t/**\n\t * Update all expressions in this group\n\t */\n\tupdate: function callee() {\n\t\tif (!this.active || this.group.isDeleted() || this.all.length + this.dependents.size === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar env = { context: this, data: this.group.getRelativeData() };\n\n\t\tMavo.hooks.run(\"expressions-update-start\", env);\n\n\t\tfor (let ref of this.all) {\n\t\t\tref.update(env.data);\n\t\t}\n\n\t\tfor (let exp of this.dependents) {\n\t\t\texp.update();\n\t\t}\n\t},\n\n\textract: function(node, attribute, path, syntax) {\n\t\tif (attribute && attribute.name == \"mv-expressions\") {\n\t\t\treturn;\n\t\t}\n\n\t\tif ((attribute && _.directives.indexOf(attribute.name) > -1) ||\n\t\t    syntax.test(attribute? attribute.value : node.textContent)\n\t\t) {\n\t\t\tthis.all.push(new Mavo.Expression.Text({\n\t\t\t\tnode, syntax,\n\t\t\t\tpath: (path || \"\").slice(1).split(\"/\").map(i => +i),\n\t\t\t\tattribute: attribute && attribute.name,\n\t\t\t\tgroup: this.group\n\t\t\t}));\n\t\t}\n\t},\n\n\t// Traverse an element, including attribute nodes, text nodes and all descendants\n\ttraverse: function(node, path = \"\", syntax) {\n\t\tif (node.nodeType === 8) {\n\t\t\t// We don't want expressions to be picked up from comments!\n\t\t\t// Commenting stuff out is a common debugging technique\n\t\t\treturn;\n\t\t}\n\n\t\tif (node.nodeType === 3) { // Text node\n\t\t\t// Leaf node, extract references from content\n\t\t\tthis.extract(node, null, path, syntax);\n\t\t}\n\t\t// Traverse children and attributes as long as this is NOT the root of a child group\n\t\t// (otherwise, it will be taken care of its own Expressions object)\n\t\telse if (node == this.group.element || !Mavo.is(\"group\", node)) {\n\t\t\tsyntax = Mavo.Expression.Syntax.create(node) || syntax;\n\n\t\t\tif (syntax === Mavo.Expression.Syntax.ESCAPE) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t$$(node.attributes).forEach(attribute => this.extract(node, attribute, path, syntax));\n\t\t\t$$(node.childNodes).forEach((child, i) => this.traverse(child, `${path}/${i}`, syntax));\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdirectives: []\n\t}\n});\n\n})();\n\nif (self.Proxy) {\n\tMavo.hooks.add(\"node-getdata-end\", function(env) {\n\t\tif (env.options.relative && env.data && typeof env.data === \"object\") {\n\t\t\tenv.data = new Proxy(env.data, {\n\t\t\t\tget: (data, property, proxy) => {\n\t\t\t\t\t// Checking if property is in proxy might add it to the data\n\t\t\t\t\tif (property in data || (property in proxy && property in data)) {\n\t\t\t\t\t\treturn data[property];\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == \"$index\") {\n\t\t\t\t\t\treturn this.index + 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == this.mavo.id) {\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Look in ancestors\n\t\t\t\t\tvar ret = this.walkUp(group => {\n\t\t\t\t\t\tif (property in group.children) {\n\t\t\t\t\t\t\tgroup.expressions.dependents.add(this.expressions);\n\n\t\t\t\t\t\t\treturn group.children[property].getData(env.options);\n\t\t\t\t\t\t};\n\t\t\t\t\t});\n\n\t\t\t\t\tif (ret !== undefined) {\n\t\t\t\t\t\treturn ret;\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\thas: (data, property) => {\n\t\t\t\t\tif (property in data) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Property does not exist, look for it elsewhere\n\n\t\t\t\t\tif (property == \"$index\" || property == this.mavo.id) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// First look in ancestors\n\t\t\t\t\tvar ret = this.walkUp(group => {\n\t\t\t\t\t\tif (property in group.children) {\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t};\n\t\t\t\t\t});\n\n\t\t\t\t\tif (ret !== undefined) {\n\t\t\t\t\t\treturn ret;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Still not found, look in descendants\n\t\t\t\t\tret = this.find(property);\n\n\t\t\t\t\tif (ret !== undefined) {\n\t\t\t\t\t\tif (Array.isArray(ret)) {\n\t\t\t\t\t\t\tret = ret.map(item => item.getData(env.options))\n\t\t\t\t\t\t\t\t\t .filter(item => item !== null);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tret = ret.getData(env.options);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdata[property] = ret;\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\tset: function(data, property, value) {\n\t\t\t\t\tthrow Error(\"You can’t set data via expressions.\");\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n}\n\n\nMavo.Node.prototype.getRelativeData = function() {\n\treturn this.getData({\n\t\trelative: true,\n\t\tstore: \"*\",\n\t\tnull: true,\n\t\tunhandled: this.mavo.unhandled\n\t});\n};\n\nMavo.hooks.add(\"group-init-start\", function() {\n\tnew Mavo.Expressions(this);\n});\n\nMavo.hooks.add(\"primitive-init-start\", function() {\n\tthis.expressionText = Mavo.Expression.Text.search(this.element, this.attribute);\n\n\tif (this.expressionText) {\n\t\tthis.expressionText.primitive = this;\n\t\tthis.store = this.store || \"none\";\n\t\tthis.modes = \"read\";\n\t}\n});\n\nMavo.hooks.add(\"group-init-end\", function() {\n\tthis.expressions.update();\n});\n\nMavo.hooks.add(\"group-render-start\", function() {\n\tthis.expressions.active = false;\n});\n\nMavo.hooks.add(\"group-render-end\", function() {\n\trequestAnimationFrame(() => {\n\t\tthis.expressions.active = true;\n\t\tthis.expressions.update();\n\t});\n});\n\n})(Bliss, Bliss.$);\n\n// mv-value plugin\nMavo.Expressions.directives.push(\"mv-value\");\n\nMavo.hooks.add(\"expressiontext-init-start\", function() {\n\tif (this.attribute == \"mv-value\") {\n\t\tthis.attribute = Mavo.Primitive.getValueAttribute(this.element);\n\t\tthis.fallback = this.fallback || Mavo.Primitive.getValue(this.element, {attribute: this.attribute});\n\t\tthis.expression = this.element.getAttribute(\"mv-value\");\n\n\t\tthis.template = [new Mavo.Expression(this.expression)];\n\t\tthis.expression = this.syntax.start + this.expression + this.syntax.end;\n\t}\n});\n\n// mv-if plugin\nMavo.Expressions.directives.push(\"mv-if\");\n\nMavo.hooks.add(\"expressiontext-init-start\", function() {\n\tif (this.attribute != \"mv-if\") {\n\t\treturn;\n\t}\n\n\tthis.expression = this.element.getAttribute(\"mv-if\");\n\tthis.template = [new Mavo.Expression(this.expression)];\n\tthis.expression = this.syntax.start + this.expression + this.syntax.end;\n\n\tthis.parentIf = Mavo.Expression.Text.search(this.element.parentNode.closest(\"[mv-if]\"), \"mv-if\");\n\n\tif (this.parentIf) {\n\t\tthis.parentIf.childIfs = (this.parentIf.childIfs || new Set()).add(this);\n\t}\n});\n\nMavo.hooks.add(\"expressiontext-update-end\", function() {\n\tif (this.attribute != \"mv-if\") {\n\t\treturn;\n\t}\n\n\t// Only apply this after the tree is built, otherwise any properties inside the if will go missing!\n\tthis.group.mavo.treeBuilt.then(() => {\n\t\tvar value = this.value[0];\n\t\tvar oldValue = this.oldValue && this.oldValue[0];\n\n\t\tif (this.parentIf) {\n\t\t\tvar parentValue = this.parentIf.value[0];\n\t\t\tthis.value[0] = value = value && parentValue;\n\t\t}\n\n\t\tif (value === oldValue) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (parentValue !== false) {\n\t\t\t// If parent if was false, it wouldn't matter whether this is in the DOM or not\n\t\t\tif (value) {\n\t\t\t\tif (this.comment && this.comment.parentNode) {\n\t\t\t\t\t// Is removed from the DOM and needs to get back\n\t\t\t\t\tthis.comment.parentNode.replaceChild(this.element, this.comment);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (this.element.parentNode) {\n\t\t\t\t// Is in the DOM and needs to be removed\n\t\t\t\tif (!this.comment) {\n\t\t\t\t\tthis.comment = document.createComment(\"mv-if\");\n\t\t\t\t}\n\n\t\t\t\tthis.element.parentNode.replaceChild(this.comment, this.element);\n\t\t\t}\n\t\t}\n\n\t\t// Mark any properties inside as hidden or not\n\t\tif (this.childProperties) {\n\t\t\tfor (let property of this.childProperties) {\n\t\t\t\tproperty.hidden = !value;\n\t\t\t}\n\t\t}\n\n\t\tif (this.childIfs) {\n\t\t\tfor (let childIf of this.childIfs) {\n\t\t\t\tchildIf.update();\n\t\t\t}\n\t\t}\n\n\t\tthis.oldValue = this.value;\n\t});\n});\n\nMavo.hooks.add(\"unit-isdatanull\", function(env) {\n\tenv.result = env.result || (this.hidden && env.options.store == \"*\");\n});\n\n$.live(Mavo.Primitive.prototype, \"hidden\", function(value) {\n\tif (this._hidden !== value) {\n\t\tthis._hidden = value;\n\t\tthis.dataChanged();\n\t}\n});\n\n$.lazy(Mavo.Expression.Text.prototype, \"childProperties\", function() {\n\tif (this.attribute != \"mv-if\") {\n\t\treturn;\n\t}\n\n\tvar properties = $$(Mavo.selectors.property, this.element)\n\t\t\t\t\t.filter(el => el.closest(\"[mv-if]\") == this.element)\n\t\t\t\t\t.map(el => Mavo.Node.get(el));\n\n\tif (properties.length) {\n\t\t// When the element is detached, datachange events from properties\n\t\t// do not propagate up to the group so expressions do not recalculate.\n\t\t// We must do this manually.\n\t\tthis.element.addEventListener(\"mavo:datachange\", evt => {\n\t\t\t// Cannot redispatch synchronously\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tif (!this.element.parentNode) { // still out of the DOM?\n\t\t\t\t\tthis.group.element.dispatchEvent(evt);\n\t\t\t\t}\n\t\t\t});\n\n\t\t});\n\t}\n\n\treturn properties;\n});\n"],"sourceRoot":"/source/"}