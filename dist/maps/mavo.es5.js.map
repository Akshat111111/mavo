{"version":3,"sources":["group.js"],"names":[],"mappings":"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","file":"mavo.es5.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Group = $.Class({\n\textends: Mavo.Unit,\n\tconstructor: function (element, mavo, o) {\n\t\tthis.children = {};\n\n\t\tthis.group = this;\n\n\t\tMavo.hooks.run(\"group-init-start\", this);\n\n\t\t// Should this element also create a primitive?\n\t\tif (Mavo.Primitive.getValueAttribute(this.element)) {\n\t\t\tvar obj = this.children[this.property] = new Mavo.Primitive(this.element, this.mavo, {group: this});\n\t\t}\n\n\t\t// Create Mavo objects for all properties in this group (primitives orgroups),\n\t\t// but not properties in descendantgroups (they will be handled by their group)\n\t\t$$(Mavo.selectors.property, this.element).forEach(element => {\n\t\t\tvar property = Mavo.Node.getProperty(element);\n\n\t\t\tif (this.contains(element)) {\n\t\t\t\tvar existing = this.children[property];\n\t\t\t\tvar template = this.template? this.template.children[property] : null;\n\t\t\t\tvar constructorOptions = {template, group: this};\n\n\t\t\t\tif (existing) {\n\t\t\t\t\t// Twogroups with the same property, convert to static collection\n\t\t\t\t\tvar collection = existing;\n\n\t\t\t\t\tif (!(existing instanceof Mavo.Collection)) {\n\t\t\t\t\t\tcollection = new Mavo.Collection(existing.element, this.mavo, constructorOptions);\n\t\t\t\t\t\tthis.children[property] = existing.collection = collection;\n\t\t\t\t\t\tcollection.add(existing);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!collection.mutable && Mavo.is(\"multiple\", element)) {\n\t\t\t\t\t\tcollection.mutable = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tcollection.add(element);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// No existing properties with this id, normal case\n\t\t\t\t\tvar obj = Mavo.Node.create(element, this.mavo, constructorOptions);\n\n\t\t\t\t\tthis.children[property] = obj;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tvar vocabElement = (this.isRoot? this.element.closest(\"[vocab]\") : null) || this.element;\n\t\tthis.vocab = vocabElement.getAttribute(\"vocab\");\n\n\t\tMavo.hooks.run(\"group-init-end\", this);\n\t},\n\n\tget isRoot() {\n\t\treturn !this.property;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: this.super.getData.call(this, o)\n\t\t};\n\n\t\tif (env.data !== undefined) {\n\t\t\treturn env.data;\n\t\t}\n\n\t\tenv.data = {};\n\n\t\tthis.propagate(obj => {\n\t\t\tif ((obj.saved || o.store == \"*\") && !(obj.property in env.data)) {\n\t\t\t\tvar data = obj.getData(o);\n\n\t\t\t\tif (data !== null || env.options.null) {\n\t\t\t\t\tenv.data[obj.property] = data;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (env.options.unhandled) {\n\t\t\t$.extend(env.data, this.unhandled);\n\t\t}\n\n\t\t// JSON-LD stuff\n\t\tif (this.type && this.type != _.DEFAULT_TYPE) {\n\t\t\tenv.data[\"@type\"] = this.type;\n\t\t}\n\n\t\tif (this.vocab) {\n\t\t\tenv.data[\"@context\"] = this.vocab;\n\t\t}\n\n\t\t// Special summary property works like toString\n\t\tif (env.data.summary) {\n\t\t\tenv.data.toString = function() {\n\t\t\t\treturn this.summary;\n\t\t\t};\n\t\t}\n\n\t\tMavo.hooks.run(\"primitive-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t/**\n\t * Search entire subtree for property, return relative value\n\t * @return {Mavo.Unit}\n\t */\n\tfind: function(property) {\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\n\t\tif (property in this.children) {\n\t\t\treturn this.children[property].find(property);\n\t\t}\n\n\t\tfor (var prop in this.children) {\n\t\t\tvar ret = this.children[prop].find(property);\n\n\t\t\tif (ret !== undefined) {\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t},\n\n\tsave: function() {\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tpropagated: [\"save\", \"import\", \"clear\"],\n\n\t// Inject data in this element\n\trender: function(data) {\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tMavo.hooks.run(\"group-render-start\", this);\n\n\t\t// TODO retain dropped elements\n\t\tdata = Array.isArray(data)? data[0] : data;\n\n\t\t// TODO what if it was a primitive and now it's a group?\n\t\t// In that case, render the this.children[this.property] with it\n\n\t\tthis.unhandled = $.extend({}, data, property => {\n\t\t\treturn !(property in this.children);\n\t\t});\n\n\t\tthis.propagate(obj => {\n\t\t\tobj.render(data[obj.property]);\n\t\t});\n\n\t\tthis.save();\n\n\t\tMavo.hooks.run(\"group-render-end\", this);\n\t},\n\n\t// Check if this group contains a property\n\t// property can be either a Mavo.Unit or a Node\n\tcontains: function(property) {\n\t\tif (property instanceof Mavo.Unit) {\n\t\t\treturn property.parentGroup === this;\n\t\t}\n\n\t\treturn property.parentNode && (this.element === property.parentNode.closest(Mavo.selectors.group));\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tDEFAULT_TYPE: \"Item\",\n\n\t\tnormalize: function(element) {\n\t\t\t// Get & normalize typeof name, if exists\n\t\t\tif (Mavo.is(\"group\", element)) {\n\t\t\t\tvar type = element.getAttribute(\"typeof\") || element.getAttribute(\"itemtype\") || _.DEFAULT_TYPE;\n\n\t\t\t\telement.setAttribute(\"typeof\", type);\n\n\t\t\t\treturn type;\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}