{"version":3,"sources":["expressiontext.js"],"names":[],"mappings":"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","file":"mavo.es5.js","sourcesContent":["(function($) {\n\nvar _ = Mavo.Expression.Text = $.Class({\n\tconstructor: function(o = {}) {\n\t\tthis.mavo = o.mavo;\n\t\tthis.template = o.template && o.template.template || o.template;\n\n\t\tfor (let prop of [\"group\", \"path\", \"syntax\", \"fallback\", \"attribute\"]) {\n\t\t\tthis[prop] = o[prop] === undefined && this.template? this.template[prop] : o[prop];\n\t\t}\n\n\t\tthis.node = o.node;\n\n\t\tif (!this.node) {\n\t\t\t// No node provided, figure it out from path\n\t\t\tthis.node = this.path.reduce((node, index) => {\n\t\t\t\treturn node.childNodes[index];\n\t\t\t}, this.group.element);\n\t\t}\n\n\t\tthis.element = this.node;\n\t\tthis.attribute = this.attribute || null;\n\n\t\tMavo.hooks.run(\"expressiontext-init-start\", this);\n\n\t\tif (!this.expression) { // Still unhandled?\n\t\t\tif (this.node.nodeType === 3) {\n\t\t\t\tthis.element = this.node.parentNode;\n\n\t\t\t\t// If no element siblings make this.node the element, which is more robust\n\t\t\t\t// Same if attribute, there are no attributes on a text node!\n\t\t\t\tif (!this.node.parentNode.children.length || this.attribute) {\n\t\t\t\t\tthis.node = this.element;\n\t\t\t\t\tthis.element.normalize();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.attribute) {\n\t\t\t\tthis.expression = this.node.getAttribute(this.attribute).trim();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Move whitespace outside to prevent it from messing with types\n\t\t\t\tthis.node.normalize();\n\n\t\t\t\tif (this.node.firstChild && this.node.childNodes.length === 1 && this.node.firstChild.nodeType === 3) {\n\t\t\t\t\tvar whitespace = this.node.firstChild.textContent.match(/^\\s*|\\s*$/g);\n\n\t\t\t\t\tif (whitespace[1]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(this.node.firstChild.textContent.length - whitespace[1].length);\n\t\t\t\t\t\t$.after(this.node.lastChild, this.node);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (whitespace[0]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(whitespace[0].length);\n\t\t\t\t\t\tthis.node.parentNode.insertBefore(this.node.firstChild, this.node);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.expression = this.node.textContent;\n\t\t\t}\n\n\n\t\t\tthis.parsed = o.template? o.template.parsed : this.syntax.tokenize(this.expression);\n\t\t}\n\n\t\tthis.oldValue = this.value = this.parsed.map(x => x instanceof Mavo.Expression? x.expression : x);\n\n\t\tMavo.hooks.run(\"expressiontext-init-end\", this);\n\n\t\t_.elements.set(this.element, [...(_.elements.get(this.element) || []), this]);\n\t},\n\n\tchangedBy: function(evt) {\n\t\treturn !this.parsed.every(expr => !(expr instanceof Mavo.Expression) || !expr.changedBy(evt));\n\t},\n\n\tupdate: function(data = this.data, evt) {\n\t\tthis.data = data;\n\n\t\tvar ret = {};\n\n\t\tMavo.hooks.run(\"expressiontext-update-start\", this);\n\n\t\tthis.oldValue = this.value;\n\n\t\tret.value = this.value = this.parsed.map((expr, i) => {\n\t\t\tif (expr instanceof Mavo.Expression) {\n\n\t\t\t\tif (expr.changedBy(evt)) {\n\t\t\t\t\tvar env = {context: this, expr};\n\n\t\t\t\t\tMavo.hooks.run(\"expressiontext-update-beforeeval\", env);\n\n\t\t\t\t\tenv.value = env.expr.eval(data);\n\n\t\t\t\t\tMavo.hooks.run(\"expressiontext-update-aftereval\", env);\n\n\t\t\t\t\tif (env.value instanceof Error) {\n\t\t\t\t\t\treturn this.fallback !== undefined? this.fallback : env.expr.expression;\n\t\t\t\t\t}\n\t\t\t\t\tif (env.value === undefined || env.value === null) {\n\t\t\t\t\t\t// Donâ€™t print things like \"undefined\" or \"null\"\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn env.value;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn this.oldValue[i];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn expr;\n\t\t});\n\n\t\tif (!this.attribute) {\n\t\t\t// Separate presentational & actual values only apply when content is variable\n\t\t\tret.presentational = this.value.map(value => {\n\t\t\t\tif (Array.isArray(value)) {\n\t\t\t\t\treturn value.join(\", \");\n\t\t\t\t}\n\n\t\t\t\tif (typeof value == \"number\") {\n\t\t\t\t\treturn Mavo.Primitive.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t});\n\n\t\t\tret.presentational = ret.presentational.length === 1? ret.presentational[0] : ret.presentational.join(\"\");\n\t\t}\n\n\t\tret.value = ret.value.length === 1? ret.value[0] : ret.value.join(\"\");\n\n\t\tif (this.primitive && this.parsed.length === 1) {\n\t\t\tif (typeof ret.value === \"number\") {\n\t\t\t\tthis.primitive.datatype = \"number\";\n\t\t\t}\n\t\t\telse if (typeof ret.value === \"boolean\") {\n\t\t\t\tthis.primitive.datatype = \"boolean\";\n\t\t\t}\n\t\t}\n\n\t\tif (ret.presentational === ret.value) {\n\t\t\tret = ret.value;\n\t\t}\n\n\t\tif (this.primitive) {\n\t\t\tthis.primitive.value = ret;\n\t\t}\n\t\telse {\n\t\t\tMavo.Primitive.setValue(this.node, ret, {attribute: this.attribute});\n\t\t}\n\n\t\tMavo.hooks.run(\"expressiontext-update-end\", this);\n\t},\n\n\tstatic: {\n\t\telements: new WeakMap(),\n\n\t\t/**\n\t\t * Search for Mavo.Expression.Text object(s) associated with a given element\n\t\t * and optionally an attribute.\n\t\t *\n\t\t * @return If one argument, array of matching Expression.Text objects.\n\t\t *         If two arguments, the matching Expression.Text object or null\n\t\t */\n\t\tsearch: function(element, attribute) {\n\t\t\tvar all = _.elements.get(element) || [];\n\n\t\t\tif (arguments.length > 1) {\n\t\t\t\tif (!all.length) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn all.filter(et => et.attribute === attribute)[0] || null;\n\t\t\t}\n\n\t\t\treturn all;\n\t\t}\n\t}\n});\n\n// Link primitive with its expressionText object\nMavo.hooks.add(\"primitive-init-start\", function() {\n\tthis.expressionText = Mavo.Expression.Text.search(this.element, this.attribute);\n\n\tif (this.expressionText) {\n\t\tthis.expressionText.primitive = this;\n\t\tthis.store = this.store || \"none\";\n\t\tthis.modes = \"read\";\n\t}\n});\n\n// Fix expressions on primitive collections\nMavo.hooks.add(\"collection-add-end\", function(env) {\n\tif (env.item instanceof Mavo.Primitive && this.itemTemplate) {\n\t\tvar et = Mavo.Expression.Text.search(this.itemTemplate.element)[0];\n\n\t\tif (et) {\n\t\t\tet.group.expressions.push(new Mavo.Expression.Text({\n\t\t\t\tnode: env.item.element,\n\t\t\t\ttemplate: et,\n\t\t\t\tmavo: this.mavo\n\t\t\t}));\n\t\t}\n\t}\n});\n\n})(Bliss);\n"],"sourceRoot":"/source/"}