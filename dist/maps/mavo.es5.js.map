{"version":3,"sources":["collection.js"],"names":[],"mappings":"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","file":"mavo.es5.js","sourcesContent":["(function($, $$) {\n\nMavo.attributes.push(\"mv-multiple\", \"mv-order\", \"mv-accepts\");\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Collection\",\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.children = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\", \"accepts\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\t\t\tthis.accepts = (this.templateElement.getAttribute(\"mv-accepts\") || \"\").split(/\\s+/);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.children.length;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: []\n\t\t};\n\n\t\tfor (item of this.children) {\n\t\t\tif (!item.deleted) {\n\t\t\t\tlet itemData = item.getData(env.options);\n\n\t\t\t\tif (itemData) {\n\t\t\t\t\tenv.data.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this.unhandled && env.options.unhandled) {\n\t\t\tenv.data = this.unhandled.before.concat(env.data, this.unhandled.after);\n\t\t}\n\n\t\tif (!this.mutable && env.data.length == 1) {\n\t\t\t// See https://github.com/LeaVerou/mavo/issues/50#issuecomment-266079652\n\t\t\tenv.data = env.data[0];\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Node.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type\n\t\t});\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Node} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Node.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (item.collection != this) {\n\t\t\tthis.adopt(item);\n\t\t}\n\n\t\tif (index in this.children) {\n\t\t\tif (this.bottomUp) {\n\t\t\t\tindex++;\n\t\t\t}\n\t\t}\n\t\telse if (index === undefined) {\n\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Add it to the DOM, or fix its place\n\t\t\tvar nextItem = this.children[index];\n\n\t\t\titem.element._.before(nextItem && nextItem.element || this.marker);\n\t\t}\n\n\t\t// Update internal data model\n\t\tvar changed = this.splice({\n\t\t\tremove: item\n\t\t}, {\n\t\t\tindex: index,\n\t\t\tadd: item\n\t\t});\n\n\t\tchanged.forEach(item => {\n\t\t\tif (!o.silent) {\n\t\t\t\titem.dataChanged(\"move\");\n\t\t\t\titem.unsavedChanges = true;\n\t\t\t}\n\t\t});\n\n\t\tif (!o.silent) {\n\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t}\n\n\t\treturn item;\n\t},\n\n\tsplice: function(...actions) {\n\t\tfor (let action of actions) {\n\t\t\tif (action.index === undefined && action.remove && isNaN(action.remove)) {\n\t\t\t\t// Remove is an item\n\t\t\t\taction.index = this.children.indexOf(action.remove);\n\t\t\t\taction.remove = 1;\n\t\t\t}\n\t\t}\n\n\t\t// Sort in reverse index order\n\t\tactions.sort((a, b) => b.index - a.index);\n\n\t\tfor (let action of actions) {\n\t\t\tif (action.index > -1 && (action.remove || action.add)) {\n\t\t\t\taction.remove = action.remove || 0;\n\t\t\t\taction.add = Mavo.toArray(action.add);\n\n\t\t\t\tthis.children.splice(action.index, +action.remove, ...action.add);\n\t\t\t}\n\t\t}\n\n\t\tvar changed = [];\n\n\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\tlet item = this.children[i];\n\n\t\t\tif (item && item.index !== i) {\n\t\t\t\titem.index = i;\n\t\t\t\tchanged.push(item);\n\t\t\t}\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\tadopt: function(item) {\n\t\tif (item.collection) {\n\t\t\t// It belongs to another collection, delete from there first\n\t\t\titem.collection.splice({remove: item});\n\t\t\titem.collection.dataChanged(\"delete\");\n\t\t}\n\n\t\t // Update collection & closestCollection properties\n\t\tthis.walk(obj => {\n\t\t\tif (obj.closestCollection === item.collection) {\n\t\t\t\tobj.closestCollection = this;\n\t\t\t}\n\n\t\t\t// Belongs to another Mavo?\n\t\t\tif (item.mavo != this.mavo) {\n\t\t\t\titem.mavo = this.mavo;\n\t\t\t}\n\t\t});\n\n\t\titem.collection = this;\n\n\t\t// Adjust templates and their copies\n\t\tif (item.template) {\n\t\t\tMavo.delete(item.template.copies, item);\n\n\t\t\titem.template = this.itemTemplate;\n\t\t}\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.splice({remove: item});\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.dataChanged(\"delete\");\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\tedit: function() {\n\t\tthis.super.edit.call(this);\n\n\t\tif (this.mutable) {\n\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\tthis.addButton._.before($.value(this.children[0], \"element\") || this.marker);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\n\t\t\t\t\tif (containerSelector) {\n\t\t\t\t\t\tvar after = this.marker.parentNode.closest(containerSelector);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.addButton._.after(after && after.parentNode? after : this.marker);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Set up drag & drop\n\t\t\t_.dragula.then(() => {\n\t\t\t\tthis.getDragula();\n\t\t\t});\n\t\t}\n\t},\n\n\tdone: function() {\n\t\tthis.super.done.call(this);\n\n\t\tif (this.mutable) {\n\t\t\tif (this.addButton.parentNode) {\n\t\t\t\tthis.addButton.remove();\n\t\t\t}\n\t\t}\n\t},\n\n\t/**\n\t * Delete all items in the collection.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.element.remove) {\n\t\t\t\t\titem.element.remove();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Document fragment, remove all children\n\t\t\t\t\tfor (let node of item.element.childNodes) {\n\t\t\t\t\t\tnode => node.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.children = [];\n\n\t\t\tthis.dataChanged(\"clear\");\n\t\t}\n\t},\n\n\tdataChanged: function(action, o = {}) {\n\t\to.element = o.element || this.marker;\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.children) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\"],\n\n\trevert: function() {\n\t\tfor (let item of this.children) {\n\t\t\t// Delete added items\n\t\t\tif (item.unsavedChanges) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Bring back deleted items\n\t\t\t\tif (item.deleted) {\n\t\t\t\t\titem.deleted = false;\n\t\t\t\t}\n\n\t\t\t\t// Revert all properties\n\t\t\t\titem.revert();\n\t\t\t}\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tthis.unhandled = {before: [], after: []};\n\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.children.forEach((item, i) => item.render(data && data[i]));\n\n\t\t\tif (data) {\n\t\t\t\tthis.unhandled.after = data.slice(this.length);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.clear();\n\n\t\t\t// Using document fragments improved rendering performance by 60%\n\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\tdata.forEach((datum, i) => {\n\t\t\t\tvar item = this.createItem();\n\n\t\t\t\titem.render(datum);\n\n\t\t\t\tthis.children.push(item);\n\t\t\t\titem.index = i;\n\n\t\t\t\tfragment.appendChild(item.element);\n\t\t\t});\n\n\t\t\tthis.marker.parentNode.insertBefore(fragment, this.marker);\n\t\t}\n\n\t\tthis.save();\n\t},\n\n\tfind: function(property, o = {}) {\n\t\tvar items = this.children.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn o.collections? this : items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property, o));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tisCompatible: function(c) {\n\t\treturn c && this.itemTemplate.nodeType == c.itemTemplate.nodeType && (c === this\n\t\t       || c.template == this || this.template == c || this.template && this.template == c.template\n\t\t       || this.accepts.indexOf(c.property) > -1);\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has mv-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\tthis.mavo.needsEdit = true;\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = document.createComment(\"mv-marker\");\n\t\t\t\tMavo.data(this.marker, \"collection\", this);\n\t\t\t\t$.after(this.marker, this.templateElement);\n\n\t\t\t\tthis.templateElement.classList.add(\"mv-item\");\n\t\t\t}\n\t\t}\n\t},\n\n\t// Make sure to only call after dragula has loaded\n\tgetDragula: function() {\n\t\tif (this.dragula) {\n\t\t\treturn this.dragula;\n\t\t}\n\n\t\tif (this.template) {\n\t\t\tMavo.pushUnique(this.template.dragula.containers, this.marker.parentNode);\n\t\t\treturn this.dragula = this.template.dragula || this.template.getDragula();\n\t\t}\n\n\t\tvar me = this;\n\t\tthis.dragula = dragula({\n\t\t\tcontainers: [this.marker.parentNode],\n\t\t\tisContainer: el => {\n\t\t\t\tif (this.accepts.length) {\n\t\t\t\t\treturn Mavo.flatten(this.accepts.map(property => this.mavo.root.find(property, {collections: true})))\n\t\t\t\t\t\t\t\t.filter(c => c && c instanceof _)\n\t\t\t\t\t\t\t\t.map(c => c.marker.parentNode)\n\t\t\t\t\t\t\t\t.indexOf(el) > -1;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tmoves: (el, container, handle) => {\n\t\t\t\treturn handle.classList.contains(\"mv-drag-handle\") && handle.closest(Mavo.selectors.item) == el;\n\t\t\t},\n\t\t\taccepts: function(el, target, source, next) {\n\t\t\t\tif (el.contains(target)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar previous = next? next.previousElementSibling : target.lastElementChild;\n\n\t\t\t\tvar collection = _.get(previous) || _.get(next);\n\n\t\t\t\tif (!collection) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar item = Mavo.Node.get(el);\n\n\t\t\t\treturn item && item.collection.isCompatible(collection);\n\t\t\t}\n\t\t});\n\n\t\tthis.dragula.on(\"drop\", (el, target, source) => {\n\t\t\tvar item = Mavo.Node.get(el);\n\t\t\tvar oldIndex = item && item.index;\n\t\t\tvar next = el.nextElementSibling;\n\t\t\tvar previous = el.previousElementSibling;\n\t\t\tvar collection = _.get(previous) || _.get(next);\n\t\t\tvar closestItem = Mavo.Node.get(previous) || Mavo.Node.get(next);\n\n\t\t\tif (closestItem && closestItem.collection != collection) {\n\t\t\t\tclosestItem = null;\n\t\t\t}\n\n\t\t\tif (item.collection.isCompatible(collection)) {\n\t\t\t\tvar index = closestItem? closestItem.index + (closestItem.element === previous) : collection.length;\n\t\t\t\tcollection.add(item, index);\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn this.dragula.cancel(true);\n\t\t\t}\n\t\t});\n\n\t\t_.dragulas.push(this.dragula);\n\n\t\treturn this.dragula;\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"mv-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.templateElement) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.item);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.mv-add-${this.property}`;\n\t\t\tvar group = this.closestCollection || this.marker.parentNode.closest(Mavo.selectors.group);\n\n\t\t\tif (group) {\n\t\t\t\tvar button = $$(selector, group).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\t\t\tMavo.data(button, \"collection\", this);\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`mv-add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.add().edit();\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdragulas: [],\n\t\tget: element => {\n\t\t\t// Is it an add button or a marker?\n\t\t\tvar collection = Mavo.data(element, \"collection\");\n\n\t\t\tif (collection) {\n\t\t\t\treturn collection;\n\t\t\t}\n\n\t\t\t// Maybe it's a collection item?\n\t\t\tvar item = Mavo.Node.get(element);\n\n\t\t\treturn item && item.collection || null;\n\t\t},\n\n\t\tlazy: {\n\t\t\tdragula: () => $.include(self.dragula, \"https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js\")\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"primitive-init-end\", function() {\n\tif (this.collection && !this.attribute) {\n\t\t// Collection of primitives, deal with setting textContent etc without the UI interfering.\n\t\tvar swapUI = callback => {\n\t\t\tvar ret;\n\n\t\t\tthis.sneak(() => {\n\t\t\t\tvar ui = $.remove($(\".mv-item-controls\", this.element));\n\n\t\t\t\tret = callback();\n\n\t\t\t\t$.inside(ui, this.element);\n\t\t\t});\n\n\t\t\treturn ret;\n\t\t};\n\n\t\t// Intercept certain properties so that any Mavo UI inside this primitive will not be destroyed\n\t\t[\"textContent\", \"innerHTML\"].forEach(property => {\n\t\t\tvar descriptor = Object.getOwnPropertyDescriptor(Node.prototype, property);\n\n\t\t\tObject.defineProperty(this.element, property, {\n\t\t\t\tget: function() {\n\t\t\t\t\treturn swapUI(() => descriptor.get.call(this));\n\t\t\t\t},\n\n\t\t\t\tset: function(value) {\n\t\t\t\t\tswapUI(() => descriptor.set.call(this, value));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n});\n\nMavo.hooks.add(\"node-edit-end\", function() {\n\tif (this.collection) {\n\t\tif (!this.itemControls) {\n\t\t\tthis.itemControls = $$(\".mv-item-controls\", this.element)\n\t\t\t\t\t\t\t\t   .filter(el => el.closest(Mavo.selectors.item) == this.element)[0];\n\n\t\t\tthis.itemControls = this.itemControls || $.create({\n\t\t\t\tclassName: \"mv-item-controls mv-ui\"\n\t\t\t});\n\n\t\t\t$.set(this.itemControls, {\n\t\t\t\tcontents: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Delete this \" + this.name,\n\t\t\t\t\t\tclassName: \"mv-delete\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.collection.delete(this)\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: `Add new ${this.name.replace(/s$/i, \"\")} ${this.bottomUp? \"after\" : \"before\"}`,\n\t\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.collection.add(null, this.collection.children.indexOf(item)).edit()\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Drag to reorder \" + this.name,\n\t\t\t\t\t\tclassName: \"mv-drag-handle\"\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t});\n\t\t}\n\n\t\tif (!this.itemControls.parentNode) {\n\t\t\tthis.element.appendChild(this.itemControls);\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"node-done-end\", function() {\n\tif (this.collection) {\n\t\tif (this.itemControls) {\n\t\t\tthis.itemControls.remove();\n\t\t}\n\t}\n});\n\nMavo.Node.prototype.getClosestCollection = function() {\n\treturn this.collection ||\n\t\t   this.group.collection ||\n\t\t   (this.parentGroup? this.parentGroup.closestCollection : null);\n};\n\n$.lazy(Mavo.Node.prototype, \"closestCollection\", function() {\n\treturn this.getClosestCollection();\n});\n\n$.live(Mavo.Node.prototype, \"deleted\", function(value) {\n\tthis.element.classList.toggle(\"mv-deleted\", value);\n\n\tif (value) {\n\t\t// Soft delete, store element contents in a fragment\n\t\t// and replace them with an undo prompt.\n\t\tthis.elementContents = document.createDocumentFragment();\n\t\t$$(this.element.childNodes).forEach(node => {\n\t\t\tthis.elementContents.appendChild(node);\n\t\t});\n\n\t\t$.contents(this.element, [\n\t\t\t{\n\t\t\t\ttag: \"button\",\n\t\t\t\tclassName: \"mv-close mv-ui\",\n\t\t\t\ttextContent: \"×\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": function(evt) {\n\t\t\t\t\t\t$.remove(this.parentNode);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"Deleted \" + this.name,\n\t\t\t{\n\t\t\t\ttag: \"button\",\n\t\t\t\tclassName: \"mv-undo mv-ui\",\n\t\t\t\ttextContent: \"Undo\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": evt => this.deleted = false\n\t\t\t\t}\n\t\t\t}\n\t\t]);\n\n\t\tthis.element.classList.remove(\"mv-delete-hover\");\n\t}\n\telse if (this.deleted) {\n\t\t// Undelete\n\t\tthis.element.textContent = \"\";\n\t\tthis.element.appendChild(this.elementContents);\n\n\t\t// otherwise expressions won't update because this will still seem as deleted\n\t\t// Alternatively, we could fire datachange with a timeout.\n\t\tthis._deleted = false;\n\n\t\tthis.dataChanged(\"undelete\");\n\t}\n});\n\n/**\n * Check if this unit is either deleted or inside a deleted group\n */\nMavo.Node.prototype.isDeleted = function() {\n\tvar ret = this.deleted;\n\n\tif (this.deleted) {\n\t\treturn true;\n\t}\n\n\treturn !!this.parentGroup && this.parentGroup.isDeleted();\n};\n\nMavo.hooks.add(\"node-init-end\", function(env) {\n\tthis.collection = env.options.collection;\n\n\tif (this.collection) {\n\t\t// This is a collection item\n\t\tthis.group = this.parentGroup = this.collection.parentGroup;\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}